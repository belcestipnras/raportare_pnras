<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Orar Individual PNRAS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e40af; --accent: #3ecf8e; --dark: #1a1a1a; --text: #1e293b; }
        @page { size: A4 portrait; margin: 1cm; }
        
        body { font-family: 'Inter', sans-serif; background: #f0f2f5; color: var(--text); margin: 0; padding: 20px; }
        
        /* INTERFA»öA DE CONTROL (NU SE PRINTEAZƒÇ) */
        .no-print { 
            background: white; padding: 25px; border-radius: 16px; 
            max-width: 1000px; margin: 0 auto 30px auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .header-ui { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Butonul Back: SƒÉgeatƒÉ Verde pe Fond Negru */
        .btn-back-custom {
            background: var(--dark); color: var(--accent);
            border: none; padding: 12px 20px; border-radius: 10px;
            font-weight: 800; cursor: pointer; display: flex; align-items: center;
            gap: 10px; text-decoration: none; transition: 0.3s; font-size: 14px;
        }
        .btn-back-custom:hover { transform: translateX(-5px); background: #000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .selector-label { font-size: 12px; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 8px; display: block; }
        
        .selector-group { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 15px; }
        
        .btn-luna, .btn-an { 
            padding: 8px 14px; border: 1px solid #e2e8f0; background: white; 
            border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-luna:hover, .btn-an:hover { border-color: var(--accent); background: #f8fafc; }
        .btn-luna.active, .btn-an.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(30, 64, 175, 0.2); }

        .btn-print { 
            background: var(--primary); color: white; border: none; 
            padding: 12px 25px; border-radius: 10px; font-weight: 700; 
            cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
        }
        .btn-print:hover { background: #173691; transform: translateY(-2px); }

        /* FORMATUL PAGINII (IDENTIC CU CEL GENERAL) */
        .page { 
            background: white; width: 210mm; min-height: 297mm; padding: 12mm 15mm; 
            margin: 20px auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            page-break-after: always; box-sizing: border-box; display: flex; flex-direction: column; 
        }
        .antet-img { width: 100%; margin-bottom: 5px; }
        .nr-inregistrare { text-align: left; font-size: 13px; margin-bottom: 10px; font-weight: 500; }
        h2 { font-family: 'Montserrat', sans-serif; text-align: center; text-transform: uppercase; font-size: 14px; margin: 10px 0; color: #000; line-height: 1.3; }
        .info-box { margin: 10px 0; font-size: 12px; line-height: 1.5; border-left: 3px solid var(--primary); padding-left: 10px; background: #f1f5f9; padding-top: 5px; padding-bottom: 5px; text-align: left; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f5f9; border: 1.5pt solid black; padding: 8px; font-size: 10px; text-transform: uppercase; }
        td { border: 1.5pt solid black; padding: 6px; text-align: center; font-size: 12px; font-family: 'Roboto Mono', monospace; color: #000; }
        .tabel-total { background: #f8fafc; font-weight: bold; text-align: right; }
        
        .signatures-grid { margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 12px; page-break-inside: avoid; text-align: left; }
        .sig-role { font-weight: bold; margin-bottom: 30px; }
        .sig-name { font-weight: 600; }
        .centered-sig { grid-column: span 2; text-align: center; margin-top: 5px; }

        @media print { 
            .no-print { display: none !important; } 
            body { padding: 0; background: none; } 
            .page { margin: 0; box-shadow: none; width: 100%; } 
        }
    </style>
</head>
<body>

<div class="no-print">
    <div class="header-ui">
        <button type="button" class="btn-back-custom" onclick="duTeInapoiLaDosar()">
            <span style="font-size: 18px;">‚¨Ö</span> √éNAPOI √éN DOSAR
        </button>
        <h3 style="margin:0; font-family: 'Montserrat'; color: var(--primary);">
            ORAR INDIVIDUAL: <span id="nume-expert-display">...</span>
        </h3>
        <button type="button" class="btn-print" onclick="window.print()">üñ®Ô∏è PRINTEAZƒÇ DOCUMENTUL</button>
    </div>
    
    <span class="selector-label">Selecta»õi Luna</span>
    <div class="selector-group" id="luna-buttons"></div>
    
    <span class="selector-label">Anul »òcolar</span>
    <div class="selector-group" id="an-buttons">
        <button type="button" class="btn-an" onclick="setAn(2025)">2025</button>
        <button type="button" class="btn-an" onclick="setAn(2026)">2026</button>
    </div>
</div>

<div id="display-area"></div>

<script>
    const URL_S = 'https://aexjrbdgajurxzngfkpx.supabase.co';
    const KEY_S = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
    const _supabase = supabase.createClient(URL_S, KEY_S);

    let selectatLuna = "";
    let selectatAn = new Date().getFullYear();

    const LUNI_RO = ["Ianuarie", "Februarie", "Martie", "Aprilie", "Mai", "Iunie", "Iulie", "August", "Septembrie", "Octombrie", "Noiembrie", "Decembrie"];
    const MAP_LUNI_COD = { "Ianuarie": "01", "Februarie": "02", "Martie": "03", "Aprilie": "04", "Mai": "05", "Iunie": "06", "Iulie": "07", "August": "08", "Septembrie": "09", "Octombrie": "10", "Noiembrie": "11", "Decembrie": "12" };
    
    // Mape identice cu Orar General
    const MAP_CLASE = { '5A': 'Clasa a V-a A', '5B': 'Clasa a V-a B', '5C': 'Clasa a V-a C', '6A': 'Clasa a VI-a A', '6B': 'Clasa a VI-a B', '6C': 'Clasa a VI-a C', '7A': 'Clasa a VII-a A', '7B': 'Clasa a VII-a B', '7C': 'Clasa a VII-a C', '8A': 'Clasa a VIII-a A', '8B': 'Clasa a VIII-a B', '8C': 'Clasa a VIII-a C', 'SG1': 'Grupa 1, Sport', 'SG2': 'Grupa 2, Sport', 'PG1': 'Grupa 1, PicturƒÉ', 'PG2': 'Grupa 2, PicturƒÉ', 'MG1': 'Grupa 1, MuzicƒÉ', 'MG2': 'Grupa 2, MuzicƒÉ', 'DG1': 'Grupa 1, Dansuri', 'StG1': 'Grupa 1, »òtiin»õe', 'StG2': 'Grupa 1, »òtiin»õe', 'SG1A': 'Grupa 1A, Sport', 'SG1B': 'Grupa 1B, Sport', 'PG1A': 'Grupa 1A, PicturƒÉ', 'PG1B': 'Grupa 1B, PicturƒÉ', 'StG1A': 'Grupa 1A, »òtiin»õe', 'StG1B': 'Grupa 1B, »òtiin»õe', 'AV5A': 'Clasa a V-a A', 'AV5B': 'Clasa a V-a B', 'AV6A': 'Clasa a VI-a A', 'AV6B': 'Clasa a VI-a B', 'AV7A': 'Clasa a VII-a A', 'AV7B': 'Clasa a VII-a B', 'AV8A1': 'Clasa a VIII-a A, Grupa 1', 'AV8A2': 'Clasa a VIII-a A, Grupa 2', 'AV8B1': 'Clasa a VIII-a B, Grupa 1', 'AV8B2': 'Clasa a VIII-a B, Grupa 2', 'AR5AB': 'Clasele a V-a A, B', 'AR5A': 'Clasa a V-a A', 'AR5B': 'Clasa a V-a B', 'AR6A': 'Clasa a VI-a A', 'AR6B': 'Clasa a VI-a B', 'AR7B': 'Clasa a VII-a B', 'BA6B': 'Clasa a VI-a B', 'BA7A': 'Clasa a VII-a A', 'BA8A1': 'Clasa a VIII-a A, Grupa 1', 'BA8A2': 'Clasa a VIII-a A, Grupa 2', 'BA8B': 'Clasa a VIII-a B', 'AD8B1': 'Clasa a VIII-a B, Grupa 1', 'AD8B2': 'Clasa a VIII-a B, Grupa 2', 'AD8B3': 'Clasa a VIII-a B, Grupa 3', 'PE8A1': 'Clasa a VIII-a A, Grupa 1', 'PE8A2': 'Clasa a VIII-a A, Grupa 2', 'PE6B': 'Clasa a VI-a B', 'PE7A': 'Clasa a VII-a A', 'IA5AB1': 'Clasele a V-a A, B', 'IA5AB2': 'Clasele a V-a A, B', 'IA6A': 'Clasa a VI-a A', 'IA7B': 'Clasa a VII-a B' };
    const MAP_EXPERT_DETALII = { "Anghelu»ô Raluca": { act: "A II.4.", desc: "ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ" }, "Baziluc Ana Maria": { act: "A II.4.", desc: "ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ" }, "Gheme»ô Anca": { act: "A II.4.", desc: "ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ" }, "ArotƒÉri»õei DƒÉnu»õ": { act: "A II.4.", desc: "ActivitƒÉ»õi remediale la matematicƒÉ" }, "Boldan Ovidiu": { act: "A II.4.", desc: "ActivitƒÉ»õi remediale la matematicƒÉ" }, "Popovici Estera": { act: "A II.4.", desc: "ActivitƒÉ»õi remediale la matematicƒÉ" }, "Iftene Ana Maria": { act: "A II.4.", desc: "ActivitƒÉ»õi remediale la matematicƒÉ" }, "Albu »òtefan": { act: "A II.5.", desc: "ActivitƒÉ»õi extracurriculare la Clubul de activitƒÉ»õi sportive »ôi outdoor" }, "Marele Daniela": { act: "A II.5.", desc: "ActivitƒÉ»õi extracurriculare la Clubul de picturƒÉ" }, "TanasƒÉ Liliana": { act: "A II.5.", desc: "ActivitƒÉ»õi extracurriculare la Clubul de muzicƒÉ" }, "Popa Gabriela": { act: "A II.5.", desc: "ActivitƒÉ»õi extracurriculare la Clubul de dansuri" }, "Nohai Iuliana": { act: "A II.5.", desc: "ActivitƒÉ»õi extracurriculare la Clubul de »ôtiin»õe" }, "Nohai Vili": { act: "A II.5.", desc: "ActivitƒÉ»õi extracurriculare la Clubul de »ôtiin»õe" }, "AparascƒÉi Vasile": { act: "A II.6.", desc: "ActivitƒÉ»õi extracurriculare la Clubul de lecturƒÉ »ôi litera»õie" } };
    const DESC_ACTIVITATI_FULL = { "A II.4.": "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", "A II.5.": "A II.5. ActivitƒÉ»õi extracurriculare »ôi/sau extra»ôcolare", "A II.6.": "A II.6. ActivitƒÉ»õi pentru dezvoltarea litera»õiei. Club de lecturƒÉ" };
    
    const ORA_START = (cl) => cl.includes('5') ? "13:00" : "14:00";
    function adunaTimp(start, ore) { let [h, m] = start.split(':').map(Number); let total = h * 60 + m + (ore * 60); return `${Math.floor(total / 60).toString().padStart(2, '0')}:${(total % 60).toString().padStart(2, '0')}`; }

    function duTeInapoiLaDosar() {
        const expert = localStorage.getItem('expertPNRAS');
        window.location.href = expert ? `dosar-expert.html?expert=${encodeURIComponent(expert)}` : 'index.html';
    }

    function init() {
        const containerLuni = document.getElementById('luna-buttons');
        LUNI_RO.forEach(l => {
            const btn = document.createElement('button');
            btn.type = "button"; btn.className = "btn-luna"; btn.innerText = l;
            btn.onclick = () => setLuna(l);
            containerLuni.appendChild(btn);
        });
        selectatLuna = LUNI_RO[new Date().getMonth()];
        setLuna(selectatLuna); setAn(selectatAn);
    }

    function setLuna(l) {
        selectatLuna = l;
        document.querySelectorAll('.btn-luna').forEach(b => b.classList.toggle('active', b.innerText === l));
        incarcaOrar();
    }

    function setAn(an) {
        selectatAn = an;
        document.querySelectorAll('.btn-an').forEach(b => b.classList.toggle('active', b.innerText == an));
        incarcaOrar();
    }

    async function incarcaOrar() {
    const expert = localStorage.getItem('expertPNRAS');
    const display = document.getElementById('display-area');
    if (!expert) return;
    document.getElementById('nume-expert-display').innerText = expert;

    const lunaCod = MAP_LUNI_COD[selectatLuna];
    
    // 1. Definim cheia unicƒÉ pentru numƒÉrul de √Ænregistrare √Æn Tabelul 4
    const tipDocCheie = `INFO_ORAR_${expert.replace(/\s+/g, '')}_${lunaCod}_${selectatAn}`;

    // 2. Ini»õializƒÉm valorile implicite (pentru a asigura afi»ôarea tabelului chiar dacƒÉ baza e goalƒÉ)
    let nrC = "...";
    let nrD = "...";

    display.innerHTML = "<div style='text-align:center; padding:50px;'>‚åõ Se actualizeazƒÉ datele...</div>";

    try {
        // 3. √éncercƒÉm sƒÉ preluƒÉm datele salvate anterior √Æn Supabase
        const { data: infoExistenta, error: errorFetch } = await _supabase
            .from('planificari_documente')
            .select('continut_json')
            .eq('tip_document', tipDocCheie)
            .maybeSingle(); // Folosim maybeSingle pentru a evita erorile dacƒÉ nu existƒÉ r√¢ndul

        if (infoExistenta && infoExistenta.continut_json) {
            nrC = infoExistenta.continut_json.nr_inreg || "...";
            nrD = infoExistenta.continut_json.data_inreg || "...";
        }
    } catch (err) {
        console.error("Eroare la preluare nr. √Ænregistrare:", err);
    }

    // 4. PreluƒÉm datele de pontaj pentru tabel
    const { data: pontaje } = await _supabase.from('pontaj_detaliat')
        .select('*')
        .eq('expert', expert)
        .eq('luna', selectatLuna)
        .eq('an', selectatAn)
        .order('zi', { ascending: true });

    if (!pontaje || pontaje.length === 0) {
        display.innerHTML = `<div class="page" style="justify-content:center; text-align:center; color:#64748b;">
            <h3>Nu am gƒÉsit ore √Ænregistrate</h3>
            <p>Pentru ${selectatLuna} ${selectatAn}</p>
        </div>`;
        return;
    }

    let det = MAP_EXPERT_DETALII[expert];
    let totProf = 0; 
    pontaje.forEach(p => totProf += parseFloat(p.nr_ore));

    // 5. Construim HTML-ul paginii
    // Am adƒÉugat ID-uri »ôi contenteditable pentru a permite editarea »ôi salvarea automatƒÉ
    let html = `<div class="page"><img src="antet_pnras.jpeg" class="antet-img">
        <div class="nr-inregistrare">
            Nr. √Ænregistrare: 
            <span id="nr_inreg_c" contenteditable="true" onblur="salveazaInfoInregistrare()" style="min-width: 30px; display: inline-block; border-bottom: 1px dashed #ccc;">${nrC}</span> 
            / 
            <span id="nr_inreg_d" contenteditable="true" onblur="salveazaInfoInregistrare()" style="min-width: 30px; display: inline-block; border-bottom: 1px dashed #ccc;">${nrD}</span>
        </div>
        <h2>Orar individual activitƒÉ»õi PNRAS</h2>
        <div class="info-box">
            <b>Activitatea:</b> ${DESC_ACTIVITATI_FULL[det.act]}<br>
            <b>Disciplina:</b> ${det.desc}<br>
            <b>Expert:</b> ${expert} | <b>Luna:</b> ${selectatLuna} ${selectatAn}
        </div>
        <table>
            <thead>
                <tr><th>Data</th><th>Clasa / Grupa</th><th>Interval Orar</th><th>Ore</th></tr>
            </thead>
            <tbody>`;

    let zileP = {}; 
    pontaje.forEach(p => { if(!zileP[p.zi]) zileP[p.zi]=[]; zileP[p.zi].push(p); });
    
    Object.keys(zileP).sort((a,b)=>a-b).forEach(z => {
        let currS = ""; 
        zileP[z].sort((a,b) => ORA_START(a.clase_grupe).localeCompare(ORA_START(b.clase_grupe))).forEach((act, idx) => {
            if(idx === 0) currS = ORA_START(act.clase_grupe); 
            let f = adunaTimp(currS, act.nr_ore);
            html += `<tr>
                <td>${z.toString().padStart(2,'0')}.${lunaCod}.${selectatAn}</td>
                <td>${MAP_CLASE[act.clase_grupe] || act.clase_grupe}</td>
                <td>${currS}-${f}</td>
                <td>${act.nr_ore}</td>
            </tr>`; 
            currS = f;
        });
    });

    html += `<tr><td colspan="3" class="tabel-total">TOTAL ORE EXPERT:</td><td><b>${totProf}</b></td></tr></tbody></table>
        <div class="signatures-grid">
            <div class="sig-block"><div class="sig-role">√éntocmit,<br>Expert,</div><div class="sig-name">${expert}</div></div>
            <div class="sig-block" style="text-align:right;"><div class="sig-role">Avizat,<br>Manager proiect,</div><div class="sig-name">prof. dr. Ciprian MIHAI</div></div>
            <div class="centered-sig"><div class="sig-role">Aprobat,<br>Director,</div><div class="sig-name">prof. CƒÉtƒÉlin Ionu»õ BAZILUC</div></div>
        </div></div>`;
    
    display.innerHTML = html;
}
async function salveazaInfoInregistrare() {
    const expert = localStorage.getItem('expertPNRAS');
    const nr_val = document.getElementById('nr_inreg_c').innerText;
    const data_val = document.getElementById('nr_inreg_d').innerText;
    
    // GenerƒÉm aceea»ôi cheie ca la √ÆncƒÉrcare
    const lunaCod = MAP_LUNI_COD[selectatLuna];
    const tipDocCheie = `INFO_ORAR_${expert.replace(/\s+/g, '')}_${lunaCod}_${selectatAn}`;

    console.log("Se salveazƒÉ pentru:", tipDocCheie); // VerificƒÉm √Æn consolƒÉ dacƒÉ porne»ôte

    const { error } = await _supabase
        .from('planificari_documente')
        .upsert({
            expert: expert,
            tip_document: tipDocCheie,
            luna: selectatLuna,
            an: selectatAn,
            continut_json: { nr_inreg: nr_val, data_inreg: data_val },
            updated_at: new Date().toISOString()
        }, { onConflict: 'tip_document' });

    if (error) {
        console.error("Eroare la salvare:", error.message);
    } else {
        console.log("Salvare reu»ôitƒÉ √Æn Tabelul 4!");
    }
}

    window.onload = init;
</script>
</body>
</html>