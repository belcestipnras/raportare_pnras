<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>PNRAS Expert - FIX FINAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --sidebar-bg: #0f172a; --ui-accent: #8b5cf6; --bg-app: #1e293b; --save-green: #10b981; --error-red: #ef4444; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg-app); font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 310px; background: var(--sidebar-bg); color: white; padding: 15px; display: flex; flex-direction: column; border-right: 1px solid #334155; height: 100vh; z-index: 1000; }
        
        .back-btn {
            background: #334155; 
            color: #e2e8f0; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 15px; 
            transition: 0.2s;
            text-decoration: none; /* Pentru cƒÉ va fi un link <a> */
            justify-content: center;
        }
        .back-btn:hover { background: #475569; color: white; }

        .prof-info { 
            background: rgba(139, 92, 246, 0.15); 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid var(--ui-accent); 
            margin-bottom: 5px; 
            text-align: center; 
            font-size: 14px; 
            font-weight: bold; 
            color: #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .save-status { font-size: 11px; color: #fbbf24; text-align: center; margin-bottom: 15px; height: 15px; font-weight: bold; }

        .main-view { flex: 1; overflow-y: auto; padding: 40px 0; display: block; }
        .a4-page {
            width: 210mm; min-height: 297mm; height: auto; 
            background: white; color: black; padding: 15mm; margin: 0 auto 50px auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            font-family: "Times New Roman", Times, serif !important; font-size: 12pt !important;
            position: relative;
        }

        .antet-img { width: 100%; height: auto; display: block; margin-bottom: 5px; }
        .anexa-text { text-align: center; font-size: 12pt !important; font-weight: bold !important; margin-bottom: 10px; }
        .titlu-fisa { font-size: 16pt; font-weight: bold; text-align: center; text-transform: uppercase; margin: 10px 0 20px 0; outline: none; border: none; background: transparent; }
        
        #zona-dinamica { outline: none; text-align: justify; min-height: 500px; }
        #zona-dinamica p { margin: 0 0 1.15em 0; text-indent: 1.25cm !important; line-height: 1.15; }
        #zona-dinamica p.sectiune-noua { margin-top: 1.5em; font-weight: bold; }

        label { font-size: 9px; text-transform: uppercase; color: #94a3b8; margin-top: 10px; display: block; }
        textarea, input[type="text"] { width: 100%; background: #1e293b; border: 1px solid #334155; color: white; padding: 10px; border-radius: 6px; margin-top: 4px; font-size: 13px; outline: none; }
        textarea:focus, input:focus { border-color: var(--ui-accent); }
        .btn { width: 100%; padding: 11px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-top: 8px; font-size: 12px; }
        .btn-ai { background: var(--ui-accent); color: white; }
        
        /* ISTORIC */
        .fise-cloud { flex: 1; overflow-y: auto; margin-top: 15px; border-top: 1px solid #334155; padding-top: 10px; }
        .fisa-card { background: #161b2c; padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; font-size: 11px; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: 0.2s; }
        .fisa-card:hover { background: #334155; }
        .fisa-card.active { border-color: var(--save-green); background: #0f172a; }
        .error-msg { color: var(--error-red); font-size: 11px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; text-align: center; }

        @media print {
            @page { size: A4; margin: 15mm; }
            .sidebar, .no-print { display: none !important; }
            body { background: white !important; overflow: visible !important; }
            .main-view { padding: 0 !important; overflow: visible !important; }
            .a4-page { box-shadow: none !important; margin: 0 !important; width: 100% !important; padding: 0 !important; }
        }
    </style>
</head>
<body>

    <div class="sidebar no-print">
        <div class="prof-info" id="expert-display">
            üë§ Se √ÆncarcƒÉ...
        </div>
        <div id="status" class="save-status">Conectare...</div>
        
        <button class="btn" style="background:#3b82f6; color:white;" onclick="nouaFisa()">+ FI»òƒÇ NOUƒÇ</button>
        
        <label>Titlu Fi»ôƒÉ</label>
        <input type="text" id="titlu-input" oninput="syncTitluInput()">
        
        <label>Cerin»õe AI</label>
        <textarea id="cerinte-ai" rows="4" placeholder="Ex: √éntrebƒÉri din text..."></textarea>
        
        <button id="btn-ai" class="btn btn-ai" onclick="comunicaCuAI()">üöÄ GENEREAZƒÇ CU AI</button>
        <button class="btn" style="background:#64748b; color:white;" onclick="window.print()">üñ®Ô∏è PRINTEAZƒÇ A4</button>

        <div class="fise-cloud" id="lista-container"></div>
    </div>

    <div class="main-view">
        <div class="a4-page">
            <img src="antet_pnras.jpeg" class="antet-img" onerror="this.src='https://via.placeholder.com/800x100?text=Antet+PNRAS'">
            <div class="anexa-text"><b>Anexa 1: Fi»ôƒÉ de lucru/Materiale</b></div>
            
            <div id="titlu-display" class="titlu-fisa" contenteditable="true" oninput="syncTitluDisplay()">TITLU FI»òƒÇ DE LUCRU</div>
            
            <div id="zona-dinamica" contenteditable="true" onfocus="curataPlaceholder()" oninput="debounceSave()">
                <p id="placeholder-id" style="color:#ccc; text-indent:0;">Scrie sau folose»ôte AI-ul...</p>
            </div>
        </div>
    </div>

    <script>
        const URL_S = 'https://aexjrbdgajurxzngfkpx.supabase.co';
        const KEY_S = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
        const FUNCTION_URL = 'https://aexjrbdgajurxzngfkpx.supabase.co/functions/v1/chatgpt-pnras';
        
        const _sb = supabase.createClient(URL_S, KEY_S);
        let currentId = null; 
        let expertNume = "Necunoscut";
        let saveTimeout = null;

        // --- PORNIRE AUTOMATƒÇ ---
        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            const urlName = params.get('expert');
            
            if (urlName) {
                // Decodare (rezolvƒÉ %20, %C8 etc.)
                expertNume = decodeURIComponent(urlName);
            } else {
                expertNume = "Expert Test"; 
            }

            document.getElementById('expert-display').innerText = "üë§ " + expertNume;
            
            await incarcaIstoric();
            
            // DacƒÉ existƒÉ fi»ôe, deschidem PRIMA (cea mai recentƒÉ)
            const container = document.getElementById('lista-container');
            if(container.children.length > 0 && container.firstChild.className.includes('fisa-card')) {
                container.firstChild.click();
            }
        };

        function setStatus(txt) { document.getElementById('status').innerText = txt; }
        function curataPlaceholder() { const p = document.getElementById('placeholder-id'); if(p) p.remove(); }

        // --- SINCRONIZARE TITLU ---
        function syncTitluInput() {
            const val = document.getElementById('titlu-input').value.toUpperCase();
            document.getElementById('titlu-display').innerText = val || "TITLU FI»òƒÇ";
            debounceSave();
        }
        function syncTitluDisplay() {
            document.getElementById('titlu-input').value = document.getElementById('titlu-display').innerText;
            debounceSave();
        }

        // --- SALVARE AUTOMATƒÇ ---
        function debounceSave() {
            setStatus("Salvare...");
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { salveazaFisa(); }, 1000);
        }

        async function salveazaFisa() {
            const titlu = document.getElementById('titlu-display').innerText;
            const html = document.getElementById('zona-dinamica').innerHTML;
            if(html.includes('placeholder-id') && !currentId) return;

            // ELIMINAT updated_at PENTRU CƒÇ PROBABIL NU EXISTƒÇ COLOANA √éN BAZA TA DE DATE
            // Folosim doar created_at implicit de Supabase
            const pld = { 
                expert_nume: expertNume, 
                titlu: titlu, 
                continut_html: html, 
                tip_document: 'fisa_lucru'
            };
            
            try {
                if (currentId) {
                    await _sb.from('documente_generat').update(pld).eq('id', currentId);
                } else {
                    const { data } = await _sb.from('documente_generat').insert([pld]).select();
                    if (data && data.length > 0) currentId = data[0].id;
                }
                setStatus("Salvat √Æn Cloud ‚úî");
                // Refresh lista pentru a vedea titlurile noi
                await incarcaIstoric(); 
            } catch (err) { 
                console.error(err);
                setStatus("Eroare Conexiune!"); 
            }
        }

        // --- GESTIONARE LISTƒÇ FI»òE ---
        async function incarcaIstoric() {
            const container = document.getElementById('lista-container');
            if(container.innerHTML === "") container.innerHTML = '<div style="text-align:center; color:#888;">‚è≥ Se cautƒÉ...</div>';

            try {
                // MODIFICARE CRITICƒÇ: Sortare dupƒÉ created_at (sigur existƒÉ)
                const { data, error } = await _sb.from('documente_generat')
                    .select('*')
                    .eq('expert_nume', expertNume)
                    .eq('tip_document', 'fisa_lucru')
                    .order('created_at', {ascending: false});

                if (error) throw error;

                container.innerHTML = "";
                
                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="error-msg">Nu existƒÉ fi»ôe salvate pentru:<br><b>${expertNume}</b></div>`;
                    return;
                }

                data.forEach(f => {
                    const div = document.createElement('div');
                    div.className = `fisa-card ${currentId == f.id ? 'active' : ''}`;
                    div.innerHTML = `
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:230px;">${f.titlu}</span>
                        <span onclick="stergeFisa('${f.id}', event)" style="color:#ff4b4b; font-weight:bold; padding:0 5px;">‚úï</span>
                    `;
                    div.onclick = () => incarcaFisaDinDB(f);
                    container.appendChild(div);
                });

            } catch (err) {
                console.error("Eroare Supabase:", err);
                container.innerHTML = `<div class="error-msg">Eroare √ÆncƒÉrcare listƒÉ (VerificƒÉ consola).</div>`;
            }
        }

        function incarcaFisaDinDB(fisa) {
            currentId = fisa.id;
            document.getElementById('zona-dinamica').innerHTML = fisa.continut_html;
            document.getElementById('titlu-display').innerText = fisa.titlu;
            document.getElementById('titlu-input').value = fisa.titlu;
            
            // ActualizƒÉm vizual
            const cards = document.querySelectorAll('.fisa-card');
            cards.forEach(c => c.classList.remove('active'));
            // Re√ÆncƒÉrcƒÉm lista e cel mai simplu mod de a seta active corect
            incarcaIstoric(); 
        }

        // --- AI ---
       async function comunicaCuAI() {
            const cmd = document.getElementById('cerinte-ai').value.trim();
            const zona = document.getElementById('zona-dinamica');
            if(!cmd) return;

            const contextText = zona.innerText; 
            curataPlaceholder();
            document.getElementById('btn-ai').disabled = true;
            setStatus("AI g√¢nde»ôte...");

            const instructiuniSystem = `E»ôti un profesor expert care redacteazƒÉ o fi»ôƒÉ de lucru.
            REGULI STRICTE DE GENERARE:
            1. GenereazƒÉ DOAR con»õinutul cerut (exerci»õii, text, √ÆntrebƒÉri).
            2. NU folosi formule de polite»õe, NU saluta, NU oferi sfaturi.
            3. ContinuƒÉ logic textul existent pe foaie.
            4. Folose»ôte tag-ul <p> pentru fiecare paragraf sau r√¢nd nou.
            5. Folose»ôte tag-ul <b> pentru a eviden»õia cuvinte cheie.
            6. Stilul trebuie sƒÉ fie academic, clar »ôi direct, gata de printat.`;

            const promptFinal = `${instructiuniSystem}\n\nCONTEXT DEJA EXISTENT:\n"${contextText}"\n\nCERIN»öƒÇ NOUƒÇ:\n${cmd}`;

            try {
                // Acum FUNCTION_URL este definit »ôi va merge!
                const resp = await fetch(FUNCTION_URL, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${KEY_S}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ prompt: promptFinal })
                });

                const data = await resp.json();
                
                if (data.reply) {
                    zona.innerHTML += data.reply;
                    document.getElementById('cerinte-ai').value = "";
                    await salveazaFisa();
                } else {
                    throw new Error(data.error || "RƒÉspuns invalid de la server");
                }
                
            } catch (e) { 
                alert("Eroare TehnicƒÉ: " + e.message);
                console.error(e);
            }
            finally { 
                document.getElementById('btn-ai').disabled = false; 
                setStatus("Generat."); 
            }
        }

        function nouaFisa() {
            currentId = null;
            document.getElementById('titlu-input').value = "";
            document.getElementById('titlu-display').innerText = "TITLU FI»òƒÇ NOUƒÇ";
            document.getElementById('zona-dinamica').innerHTML = '<p id="placeholder-id" style="color:#ccc; text-indent:0;">Scrie aici...</p>';
            // Nu salvƒÉm imediat, a»ôteptƒÉm input
        }

        async function stergeFisa(id, e) {
            e.stopPropagation();
            if(confirm("»òtergi definitiv?")) {
                await _sb.from('documente_generat').delete().eq('id', id);
                if(currentId == id) nouaFisa();
                await incarcaIstoric();
            }
        }
    </script>
</body>
</html>
