<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Planificare PNRAS - Final Complet</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* SETƒÇRI PRINTARE */
        @page { 
            size: A4; 
            margin: 1.5cm 1.5cm 2.0cm 1.5cm; 
        }
        
        body { 
            background: #f1f5f9; 
            margin: 0; 
            padding: 60px 0 40px 0; 
            font-family: "Times New Roman", serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        .page { 
            background: white; 
            width: 210mm; 
            min-height: 297mm; 
            padding: 1.5cm 1.5cm 1.5cm 1.5cm; 
            box-sizing: border-box; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }

        #save-status { 
            position: fixed; top: 70px; left: 20px; padding: 5px 10px; 
            border-radius: 10px; font-family: sans-serif; font-size: 11px; 
            font-weight: bold; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .status-loading { background: #fef3c7; color: #92400e; }
        .status-saved { background: #dcfce7; color: #166534; }
        .status-error { background: #fee2e2; color: #991b1b; }
        .status-unsaved { background: #dbeafe; color: #1e40af; }

        .antet-img { width: 100%; height: auto; margin-bottom: 15px; }
        
        .nr-inregistrare { display: flex; justify-content: center; align-items: center; gap: 5px; margin-bottom: 20px; font-size: 12pt; }
        #nr-reg { width: 40px; text-align: right; border: 1px solid #ccc; padding: 2px; font-family: inherit; font-size: 12pt; }
        #data-reg { width: 85px; text-align: left; border: 1px solid #ccc; padding: 2px; font-family: inherit; font-size: 12pt; }

        .main-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 20px; margin-bottom: 20px; }
        .main-table th, .main-table td { border: 1px solid black; padding: 4px; font-size: 10pt; vertical-align: middle; word-wrap: break-word; }
        .main-table th { background: #f8fafc; font-weight: bold; text-align: center; }
        .col-center { text-align: center !important; }

        .edit-cell { outline: none; min-height: 1.5em; line-height: 1.4; border: 1px dashed #ccc; padding: 4px; text-align: left; white-space: pre-wrap; background: #fff; }
        .readonly-cell { background: #f3f4f6; color: #000; font-weight: bold; cursor: default; border: none; padding: 6px; text-align: center; }
        .manual-date-cell { background: #fff; border: 1px dashed #ccc; font-weight: bold; cursor: text; padding: 4px; outline: none; text-align: center; }

        #lista-obiective { 
    margin-top: 5px; 
    margin-bottom: 15px;
    border: 1px dashed #ccc; 
    padding: 4px; 
    min-height: 1.5em; 
    outline: none;
    white-space: pre-wrap; /* Asta asigurƒÉ afi»ôarea corectƒÉ a r√¢ndurilor */
}
/* Po»õi »ôterge regula #lista-obiective ul { ... } dacƒÉ mai existƒÉ, nu mai avem nevoie de ea */

        .no-print { position: fixed; top: 0; left: 0; width: 100%; background: #1e293b; padding: 15px 20px; display: flex; align-items: center; justify-content: flex-end; gap: 10px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); box-sizing: border-box; }
        .btn { padding: 8px 16px; border: none; cursor: pointer; font-weight: bold; border-radius: 6px; font-family: sans-serif; font-size: 14px; transition: 0.2s; }
        .btn-green { background: #22c55e; color: white; } .btn-green:hover { background: #16a34a; }
        .btn-red { background: #ef4444; color: white; } .btn-red:hover { background: #dc2626; }
        .btn-orange { background: #f59e0b; color: white; margin-right: 20px; } .btn-orange:hover { background: #d97706; }
        .btn-back { background: #64748b; color: white; } .btn-back:hover { background: #475569; }
        .btn-print { background: #ffffff; color: #1e293b; } .btn-print:hover { background: #f1f5f9; }

        .signature-section { width: 100%; display: flex; justify-content: space-between; font-size: 11pt; line-height: 1.4; margin-top: auto; padding-bottom: 20px; page-break-inside: avoid; }
        .sig-box { width: 30%; text-align: left; }
        .sig-center { text-align: center; }
        .sig-right { text-align: right; }

        @media print {
            body { background: white; padding: 0; margin: 0; }
            .page { width: 100%; margin: 0; box-shadow: none; padding: 0; border: none; min-height: auto; }
            .no-print, #save-status { display: none !important; }
            .edit-cell, input, #lista-obiective, .manual-date-cell { border: none !important; padding: 0 !important; }
            .readonly-cell { background: transparent !important; }
            .footer-pnrr { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding-bottom: 5px; border-top: 1px solid #000; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <button class="btn btn-green" onclick="addNewRow()">‚ûï AdaugƒÉ R√¢nd</button>
        <button class="btn btn-red" onclick="deleteLastRow()">‚ûñ »òterge Ultimul</button>
        <button class="btn btn-orange" onclick="resetData()">üîÑ Reset</button>
        <button class="btn btn-back" id="btn-back">‚¨ÖÔ∏è √énapoi</button>
        <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è PDF</button>
    </div>

    <div id="save-status" class="status-loading">‚è≥ Se ini»õializeazƒÉ...</div>

    <div class="page">
        <div>
            <img src="antet_pnras.jpeg" class="antet-img">
            <div class="nr-inregistrare">
                Nr. √Ænregistrare: <input type="text" id="nr-reg" maxlength="4"> / <input type="text" id="data-reg" maxlength="10">
            </div>
            <div style="text-align: center; font-size: 14pt; font-weight: bold; margin-bottom: 10px;">Planificare lunarƒÉ a activitƒÉ»õilor</div>
            <div style="text-align: center; font-size: 12pt; line-height: 1.3; margin-bottom: 20px;">
                <div id="label-activitate-tip" style="font-weight: bold;"></div>
                <div id="label-disciplina"></div>
                <div style="font-weight: bold; margin-top: 10px;">Expert: <span id="label-nume"></span></div>
                <div style="font-weight: bold;">Luna: <span id="label-luna"></span></div>
                <div style="font-weight: bold;">Clasa: <span id="label-clasa"></span></div>
            </div>
            <strong>Obiective:</strong>
            <div id="lista-obiective" contenteditable="true" onblur="formatObiective(this)"></div>
        </div>

        <table class="main-table">
            <thead>
                <tr>
                    <th style="width: 50px;">Nr.</th>
                    <th style="width: 90px;">Data</th>
                    <th>Con»õinuturi</th>
                    <th>ActivitƒÉ»õi</th>
                    <th>Resurse</th>
                    <th style="width: 12%;">Eval.</th>
                </tr>
            </thead>
            <tbody id="tabel-body"></tbody>
        </table>

        <div class="signature-section">
            <div class="sig-box"><strong>√éntocmit,</strong><br>Expert:<br><span id="sig-expert-nume"></span></div>
            <div class="sig-box sig-center"><strong>Avizat,</strong><br>Manager proiect,<br>prof. dr. Ciprian MIHAI</div>
            <div class="sig-box sig-right"><strong>Aprobat,</strong><br>Director,<br>prof. CƒÉtƒÉlin Ionu»õ BAZILUC</div>
        </div>     
    </div>

<script>
    const URL_S = 'https://aexjrbdgajurxzngfkpx.supabase.co';
    const KEY_S = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
    const supabaseClient = supabase.createClient(URL_S, KEY_S);

    const params = new URLSearchParams(window.location.search);
    const config = {
        expert: params.get('expert'),
        luna: params.get('luna'),
        an: params.get('an'),
        clasa: params.get('clasa'),
        idDoc: `PLAN_${params.get('expert')}_${params.get('clasa')}_${params.get('luna')}_${params.get('an')}`
    };

    function transformClasa(cod) {
        const mape = {
            "5A": "Clasa a V-a A", "5B": "Clasa a V-a B",
            "6A": "Clasa a VI-a A", "6B": "Clasa a VI-a B", "6C": "Clasa a VI-a C",
            "7A": "Clasa a VII-a A", "7B": "Clasa a VII-a B",
            "8A": "Clasa a VIII-a A", "8B": "Clasa a VIII-a B", "8C": "Clasa a VIII-a C",
            "SG1": "Sport Grupa 1", "SG2": "Sport Grupa 2",
            "PG1": "PicturƒÉ Grupa 1", "PG2": "PicturƒÉ Grupa 2",
            "MG1": "MuzicƒÉ Grupa 1", "MG2": "MuzicƒÉ Grupa 2",
            "DG1": "Dansuri Grupa 1", "StG1": "»òtiin»õe Grupa 1", "StG2": "»òtiin»õe Grupa 2"
        };
        return mape[cod] || cod;
    }

    const dbExperti = {
        "Anghelu»ô Raluca": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ" },
        "Baziluc Ana Maria": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ" },
        "Gheme»ô Anca": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ" },
        "ArotƒÉri»õei DƒÉnu»õ": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la matematicƒÉ" },
        "Boldan Ovidiu": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la matematicƒÉ" },
        "Popovici Estera": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la matematicƒÉ" },
        "Iftene Ana Maria": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la matematicƒÉ" },
        "Albu »òtefan": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de activitƒÉ»õi sportive »ôi outdoor" },
        "Marele Daniela": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de picturƒÉ" },
        "TanasƒÉ Liliana": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de muzicƒÉ" },
        "Popa Gabriela": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de dansuri" },
        "Nohai Iuliana": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de »ôtiin»õe" },
        "Nohai Vili": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de »ôtiin»õe" },
        "AparascƒÉi Vasile": { act: "A II.6. ActivitƒÉ»õi de dezvoltare a abilitƒÉ»õilor de litera»õie", disc: "Clubul de lecturƒÉ »ôi litera»õie" }
    };

    let localRows = [];
    let isReady = false;

    function safeHtml(text) { if (!text) return ""; return text.replace(/\n/g, '<br>'); }
    
    function formatDate(zi, lunaNume, an) {
        const luni = { "Ianuarie": "01", "Februarie": "02", "Martie": "03", "Aprilie": "04", "Mai": "05", "Iunie": "06", "Iulie": "07", "August": "08", "Septembrie": "09", "Octombrie": "10", "Noiembrie": "11", "Decembrie": "12" };
        const l = luni[lunaNume] || "01";
        const z = zi.toString().padStart(2, '0');
        return `${z}.${l}.${an}`;
    }

    document.getElementById('btn-back').onclick = () => {
        if(config.expert) window.location.href = `dosar-expert.html?expert=${encodeURIComponent(config.expert)}`;
        else window.history.back();
    };

    async function init() {
        setStatus('loading', '‚è≥ Se sincronizeazƒÉ datele...');
        
        // 1. SetƒÉri etichete antet (RƒÉm√¢n neschimbate)
        const info = dbExperti[config.expert] || { act: "Activitate PNRAS", disc: "" };
        document.getElementById('label-activitate-tip').innerText = info.act;
        document.getElementById('label-disciplina').innerText = info.disc;
        document.getElementById('label-nume').innerText = config.expert;
        document.getElementById('sig-expert-nume').innerText = config.expert;
        document.getElementById('label-luna').innerText = `${config.luna} ${config.an}`;
        document.getElementById('label-clasa').innerText = transformClasa(config.clasa);

        // 2. Extragem datele actuale din PONTEL (Master List)
        const { data: pnt } = await supabaseClient
            .from('pontaj_detaliat')
            .select('zi')
            .match({ expert: config.expert, luna: config.luna, an: config.an })
            .ilike('clase_grupe', `%${config.clasa}%`)
            .order('zi', { ascending: true });

        // 3. Extragem ce avem salvat √Æn PLANIFICARE (Saved Data)
        const { data: planDoc } = await supabaseClient
            .from('planificari_documente')
            .select('continut_json')
            .eq('tip_document', config.idDoc)
            .maybeSingle();

        let savedRows = [];
        if (planDoc && planDoc.continut_json) {
            savedRows = planDoc.continut_json.tableRows || [];
            document.getElementById('lista-obiective').innerHTML = planDoc.continut_json.obiective || "<ul><li></li></ul>";
            document.getElementById('nr-reg').value = planDoc.continut_json.nr || "";
            document.getElementById('data-reg').value = planDoc.continut_json.dataReg || "";
        }

        // 4. LOGICA DE MERGE (Sincronizare r√¢nduri)
        if (pnt && pnt.length > 0) {
            const tempRows = [];
            
            pnt.forEach(z => {
                const dataCalendaristica = formatDate(z.zi, config.luna, config.an);
                
                // CƒÉutƒÉm dacƒÉ avem deja aceastƒÉ datƒÉ salvatƒÉ √Æn planificare
                const existingRow = savedRows.find(r => r.data === dataCalendaristica);
                
                if (existingRow) {
                    // DacƒÉ existƒÉ, √Æl pƒÉstrƒÉm exact a»ôa cum e (cu textele completate)
                    tempRows.push(existingRow);
                } else {
                    // DacƒÉ e o zi nouƒÉ din pontaj, creƒÉm r√¢ndul gol
                    tempRows.push({ 
                        data: dataCalendaristica, 
                        cont: "", 
                        actv: "", 
                        res: "", 
                        eval: "", 
                        manual: false 
                    });
                }
            });

            // AdƒÉugƒÉm »ôi eventualele r√¢nduri manuale care nu sunt √Æn pontaj, dar au fost adƒÉugate de utilizator
            const manualRows = savedRows.filter(r => r.manual === true);
            localRows = [...tempRows, ...manualRows];
        } else {
            // DacƒÉ nu e nimic √Æn pontaj, pƒÉstrƒÉm ce era salvat sau un r√¢nd gol default
            localRows = savedRows.length > 0 ? savedRows : [{ data: "", cont: "", actv: "", res: "", eval: "", manual: true }];
        }

        renderTable();
        isReady = true;
        setStatus('saved', '‚úÖ Date sincronizate');
    }

window.formatObiective = function(el) {
    let text = el.innerText;
    let lines = text.split('\n').filter(l => l.trim() !== "");
    
    if(lines.length > 0) {
        // Logica noua: Doar adauga bulina, NU sterge punctul sau ; de la final
        el.innerText = lines.map(l => {
            // Curata doar bulina veche daca exista, ca sa nu le dublam
            let curat = l.replace(/^‚Ä¢\s*/, '').trim(); 
            // Returneaza textul exact cum l-ai scris tu, dar cu bulina in fata
            return `‚Ä¢ ${curat}`; 
        }).join('\n');
    }
    triggerSave();
}

    function renderTable() {
        const tb = document.getElementById('tabel-body'); tb.innerHTML = "";
        localRows.forEach((r, i) => {
            const tr = document.createElement('tr');
            let dateCell = r.manual ? `<div class="manual-date-cell" contenteditable="true" oninput="upd(${i},'data',this)">${r.data}</div>` : `<div class="readonly-cell">${r.data}</div>`;
            tr.innerHTML = `<td class="col-center">${i+1}</td><td class="col-center">${dateCell}</td><td><div class="edit-cell" contenteditable="true" onblur="bul(${i},'cont',this)">${safeHtml(r.cont)}</div></td><td><div class="edit-cell" contenteditable="true" onblur="bul(${i},'actv',this)">${safeHtml(r.actv)}</div></td><td><div class="edit-cell" contenteditable="true" onblur="bul(${i},'res',this)">${safeHtml(r.res)}</div></td><td><div class="edit-cell" contenteditable="true" oninput="upd(${i},'eval',this)">${safeHtml(r.eval)}</div></td>`;
            tb.appendChild(tr);
        });
    }

    window.upd = function(idx, k, el) { localRows[idx][k] = el.innerText; triggerSave(); }
    window.addNewRow = function() { localRows.push({ data: "", cont: "", actv: "", res: "", eval: "", manual: true }); renderTable(); triggerSave(); }
    window.deleteLastRow = function() { if(localRows.length > 1 && confirm("»òtergi ultimul r√¢nd?")) { localRows.pop(); renderTable(); triggerSave(); } }
    
    // FUNC»öIA DE RESET CERUTƒÇ
    window.resetData = async function() {
        if (confirm("Sigur vrei sƒÉ resetezi tabelul? Vei pierde modificƒÉrile nesalvate »ôi se vor re√ÆncƒÉrca datele din Cloud.")) {
            isReady = false; // DezactivƒÉm temporar autosave
            await init();    // Re-ini»õializƒÉm totul din Supabase
            setStatus('saved', '‚úÖ Date restaurate');
        }
    }

    window.bul = function(idx, k, el) {
    let text = el.innerText;
    let lines = text.split('\n').filter(l => l.trim() !== "");
    
    if(lines.length > 0) {
        text = lines.map(l => {
            let curat = l.replace(/^‚Ä¢\s*/, '').trim();
            return `‚Ä¢ ${curat}`; // Pastreaza punctuatia originala
        }).join('\n');
    }
    
    localRows[idx][k] = text;
    renderTable(); 
    triggerSave();
}

    let t;
    function triggerSave() {
        if (!isReady) return;
        setStatus('unsaved', 'üíæ Se salveazƒÉ...');
        clearTimeout(t);
        t = setTimeout(async () => {
            const obj = { nr: document.getElementById('nr-reg').value, dataReg: document.getElementById('data-reg').value, obiective: document.getElementById('lista-obiective').innerHTML, tableRows: localRows };
            const { error } = await supabaseClient.from('planificari_documente').upsert({ expert: config.expert, tip_document: config.idDoc, luna: config.luna, an: config.an, continut_json: obj }, { onConflict: 'tip_document' });
            setStatus(error ? 'error' : 'saved', error ? '‚ùå Eroare' : '‚úÖ Salvat √Æn Cloud');
        }, 1000);
    }

    function setStatus(cl, txt) { const s = document.getElementById('save-status'); s.className = `status-${cl}`; s.innerText = txt; }
    document.getElementById('nr-reg').oninput = triggerSave; document.getElementById('data-reg').oninput = triggerSave; document.getElementById('lista-obiective').oninput = triggerSave;
    init();
</script>
</body>
</html>
