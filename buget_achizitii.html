<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buget PNRAS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Times+New+Roman&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --pnras-blue: #0056b3; --bg-color: #f4f6f9; --text-dark: #333; --border-color: #d1d9e0; --green: #28a745; --orange: #fd7e14; --red: #dc3545;}
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text-dark); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        /* --- STILURI NOI PENTRU MENIU COMPACT (FƒÇRƒÇ SCROLL) --- */

        /* 1. Micsoram padding-ul general al barei laterale */
        .sidebar { 
            width: 300px; /* Putin mai ingust */
            background: white; 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            padding: 15px; /* REDUS de la 25px */
            box-sizing: border-box; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.03); 
            z-index: 10; 
            overflow-y: auto;
        }

        /* 2. Micsoram butonul de "Inapoi" */
        .back-btn { 
            text-decoration: none; 
            color: var(--pnras-blue); 
            font-weight: 600; 
            font-size: 0.9rem; /* REDUS */
            margin-bottom: 15px; /* REDUS de la 30px */
            display: inline-block;
        }
        
        /* 3. Butonul mare negru (Raport) mai mic */
        .btn-raport { 
            background: #111; 
            color: white; 
            border: none; 
            padding: 10px; /* REDUS de la 15px */
            border-radius: 6px; 
            font-weight: 700; 
            font-size: 0.9rem; /* REDUS de la 1rem */
            cursor: pointer; 
            transition: 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            margin-bottom: 15px; /* REDUS de la 25px */
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        .btn-raport:hover { background: #333; transform: translateY(-2px); }

        /* 4. Butoanele de printare mai compacte */
        .btn-print-sidebar { 
            background: #f0f4f8; 
            color: var(--pnras-blue); 
            border: 1px solid #d1d9e0; 
            padding: 6px 10px; /* REDUS */
            border-radius: 6px; 
            font-weight: 600; 
            font-size: 0.8rem; /* REDUS */
            cursor: pointer; 
            transition: 0.2s; 
            text-align: left; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 4px; /* REDUS */
            width: 100%;
        }
        .btn-print-sidebar:hover { background: var(--pnras-blue); color: white; border-color: var(--pnras-blue);}

        /* 5. Titlurile sectiunilor mai mici */
        .section-title { 
            font-size: 0.75rem; /* REDUS */
            font-weight: 700; 
            color: #aaa; 
            text-transform: uppercase; 
            margin-bottom: 8px; /* REDUS de la 15px */
            letter-spacing: 0.5px; 
            margin-top: 5px;
        }

        /* 6. Cifrele (Sumele) mult mai compacte */
        .total-box { margin-bottom: 10px; /* REDUS de la 20px */ }
        .total-label { 
            font-size: 0.75rem; /* REDUS */
            color: #555; 
            font-weight: 600; 
            text-transform: uppercase; 
            margin-bottom: 2px; /* REDUS */
        }
        .total-val { 
            font-size: 1.2rem; /* REDUS de la 1.6rem */
            font-weight: 700; 
            color: #111; 
            line-height: 1.2;
        }
        
        /* Culorile raman la fel */
        .total-val.blue { color: var(--pnras-blue); }
        .total-val.red { color: var(--red); }
        .total-val.green { color: var(--green); }
        .total-val.orange { color: var(--orange); }

        /* 7. Linia despartitoare mai subtire */
        .divider { 
            height: 1px; 
            background: #eee; 
            margin: 10px 0; /* REDUS de la 25px */
        }

        /* --- RESTUL STILURILOR RAMAN LA FEL DE AICI IN JOS --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-header { padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid var(--border-color); }
        .top-header h1 { margin: 0; font-size: 1.5rem; color: var(--pnras-blue); }
        .year-selector { display: flex; gap: 10px; }
        .year-btn { background: #f0f0f0; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; color: #444; transition: 0.2s; }
        .year-btn.active { background: #333; color: white; }
        .year-btn.total-btn { background: #e0f2fe; color: var(--pnras-blue); border: 1px solid #bae6fd; margin-left: 10px;}
        .year-btn.total-btn.active { background: var(--pnras-blue); color: white; border-color: var(--pnras-blue);}

        .activities-nav { display: flex; gap: 10px; padding: 15px 30px; background: #fbfdff; border-bottom: 1px solid var(--border-color); flex-wrap: wrap;}
        .activity-card { flex: 1; min-width: 180px; background: white; border: 2px solid var(--border-color); border-radius: 10px; padding: 12px; cursor: pointer; text-align: center; font-weight: 600; font-size: 0.85rem; color: #444; transition: 0.2s; display: flex; align-items: center; justify-content: center; line-height: 1.3;}
        .activity-card.active { background: var(--pnras-blue); color: white; border-color: var(--pnras-blue); box-shadow: 0 4px 10px rgba(0,86,179,0.2); }

        .selection-summary { background: #111; color: white; padding: 12px 30px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; font-weight: 600; }
        .selection-summary .sum-item { display: flex; align-items: center; gap: 8px; }
        
        .btn-print-view { background: white; color: #111; border: none; padding: 6px 12px; border-radius: 4px; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;}
        .btn-print-view:hover { background: #f0f0f0; }

        .data-viewport { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .empty-state { text-align: center; color: #888; margin-top: 50px; font-style: italic; font-size: 1.1rem; }

        .buget-row { background: white; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; }
        .buget-header { background: #f8fbff; padding: 20px; display: flex; flex-direction: column; gap: 15px; border-bottom: 1px solid var(--border-color); }
        .buget-title-container { display: flex; justify-content: space-between; align-items: center; }
        .buget-title { font-size: 1.05rem; color: #111; line-height: 1.4; max-width: 65%; font-family: 'Times New Roman', Times, serif;}
        
        .line-financials { display: flex; gap: 30px; align-items: center; justify-content: flex-end;}
        .fin-block { display: flex; flex-direction: column; align-items: flex-end; }
        .fin-block.alocat { color: #111; }
        .fin-block.cheltuit { color: var(--red); }
        .fin-block.ramas { color: var(--green); }
        .fin-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 600; opacity: 0.7; }
        .fin-val { font-size: 1.15rem; font-weight: 700; }

        .matrix-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #fff; border: 1px solid #bae6fd; border-radius: 6px; padding: 10px;}
        .matrix-col { display: flex; flex-direction: column; border-right: 1px solid #e2e8f0; padding-right: 10px; font-size: 0.85rem;}
        .matrix-col:last-child { border-right: none; padding-right: 0;}
        .matrix-title { font-weight: 700; color: var(--pnras-blue); margin-bottom: 8px; text-transform: uppercase; font-size: 0.8rem;}
        .m-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #f0f0f0; padding-bottom: 2px;}
        .m-row:last-child { border-bottom: none; font-weight: 700; padding-top: 4px; border-top: 1px solid #e2e8f0;}
        .m-lbl { color: #666; }
        .m-val { color: #111; }

        .budget-timeline { display: flex; background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px 15px; font-size: 0.85rem; justify-content: space-between; }
        .timeline-item { display: flex; flex-direction: column; }
        .timeline-label { color: #666; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; }
        .timeline-val { font-weight: 700; color: #111; margin-top: 2px; }

        .contracte-container { padding: 20px; }
        .contract-box { background: #f9fafb; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--pnras-blue); }
        .contract-header { display: flex; justify-content: space-between; font-weight: 600; color: #111; margin-bottom: 5px; align-items: center; }
        .tva-details { font-size: 0.75rem; color: #777; font-weight: 500; font-style: italic; margin-bottom: 10px;}
        
        .contract-status { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; color: white; background: #6c757d; }
        .contract-status.platit { background: var(--green); }
        .contract-status.derulare { background: var(--orange); }

        .factura-list { margin-left: 10px; padding-left: 15px; border-left: 2px solid #cbd5e0; }
        .factura-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: #444; margin-bottom: 5px; align-items: center; }
        
        .btn-add-contract { background: #eef2f5; color: var(--pnras-blue); border: 1px dashed var(--pnras-blue); padding: 8px 15px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.2s;}
        .btn-add-contract:hover { background: #e2e8f0;}
        .btn-add-factura { background: white; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
        
        .btn-action-small { background: none; border: none; font-size: 1rem; cursor: pointer; opacity: 0.5; transition: 0.2s; padding: 0 5px; }
        .btn-action-small:hover { opacity: 1; transform: scale(1.1); }
        .btn-delete { color: #dc3545; }
        .btn-edit { color: var(--pnras-blue); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #444; display: none; justify-content: center; align-items: flex-start; z-index: 1000; overflow-y: auto; padding-top: 20px; padding-bottom: 20px;}
        
        .modal-audit { 
            background: white; 
            width: 210mm; 
            min-height: 297mm; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5); 
            display: flex; 
            flex-direction: column; 
            font-family: 'Times New Roman', Times, serif; 
            color: #000; 
            position: relative;
            margin-bottom: 40px; 
            overflow: visible; 
        }

        .modal-executie { 
            background: white; 
            width: 85%; 
            max-width: 1000px;
            padding: 30px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .print-controls { position: sticky; top: 0; background: #222; padding: 10px 15px; display: flex; justify-content: space-between; z-index: 10;}
        .btn-print-action { background: var(--pnras-blue); color: white; border: none; padding: 8px 20px; font-size: 1rem; font-weight: bold; cursor: pointer; border-radius: 4px;}
        .close-audit { background: #dc3545; color: white; border: none; padding: 8px 15px; font-size: 1rem; cursor: pointer; font-weight: bold; border-radius: 4px;}

        .a4-content { padding: 1.5cm; box-sizing: border-box; background: white; width: 100%;}
        .antet-img { width: 100%; height: auto; display: block; margin-bottom: 20px; }
        
        .audit-title { text-align: center; font-size: 1.15rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase;}
        .audit-subtitle { text-align: center; font-size: 0.9rem; margin-bottom: 25px; font-style: italic; }

        .audit-section { margin-bottom: 25px; border: 1px solid #000; padding: 15px; background: #fff;}
        .section-h { font-size: 1rem; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px;}

        .audit-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.85rem;}
        .audit-table th, .audit-table td { border: 1px solid #000; padding: 6px; text-align: right; }
        .audit-table th { background-color: #f2f2f2; text-align: center; font-weight: bold;}
        .audit-table td.text-left { text-align: left; line-height: 1.3;}
        .audit-table tr.total-row { font-weight: bold; background-color: #e6e6e6; font-size: 0.9rem;}

        .kpi-grid { display: flex; justify-content: space-between; gap: 15px; margin-bottom: 15px; }
        .kpi-box { border: 1px solid #000; padding: 10px; text-align: center; flex: 1; background: #fafafa;}
        .kpi-label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase;}
        .kpi-val { font-size: 1.15rem; font-weight: bold; }

        .audit-signatures { display: flex; justify-content: space-between; margin-top: 40px; font-size: 0.95rem; line-height: 1.3; }
        .sig-block { text-align: left; width: 45%; }

        /* --- LIPE»òTE ACEST BLOC √éN LOC --- */
@media print {
    /* 1. SETƒÇRI PAGINƒÇ (1.5cm Margine) */
    @page {
        size: A4 portrait;
        margin: 1.5cm;
    }

    /* 2. RESETARE CORP PAGINƒÇ */
    html, body {
        width: 100%;
        height: auto;
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        overflow: visible !important; /* Permite curgerea pe mai multe pagini */
    }

    /* 3. ASCUNDEM TOT CE NU TREBUIE */
    .sidebar, 
    .main-content, 
    .no-print, 
    .print-controls, 
    .modal-actions, 
    .btn-save, 
    .btn-cancel, 
    .close-audit,
    .btn-print-action, 
    .btn-raport,
    .year-selector,
    .activities-nav,
    .selection-summary,
    .top-header,
    #exec-data-titlu {
        display: none !important;
    }

    /* 4. REGLAJ FIN PENTRU ANTET (SƒÉ nu fie deformat) */
    .antet-img {
        display: block !important;
        width: 100% !important;
        height: auto !important;     /* √é»ôi pƒÉstreazƒÉ √ÆnƒÉl»õimea naturalƒÉ */
        max-height: 150px;           /* LimitƒÉ ca sƒÉ nu fie prea mare */
        object-fit: contain !important; /* CRUCIAL: Previne deformarea/turtirea */
        margin-bottom: 20px;
    }

    /* 5. GESTIONAREA FERESTRELOR (Overlay) */
    /* AceastƒÉ regulƒÉ detecteazƒÉ fereastra deschisƒÉ »ôi o transformƒÉ √Æn paginƒÉ de print */
    .modal-overlay {
        position: absolute !important; /* Nu fixed, ca sƒÉ curgƒÉ paginile */
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: auto !important;
        z-index: 9999;
        background: white !important;
        overflow: visible !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    /* FOARTE IMPORTANT: DacƒÉ fereastra e √ÆnchisƒÉ (display: none), o »õinem ascunsƒÉ */
    .modal-overlay[style*="display: none"] {
        display: none !important;
    }

    /* 6. CON»öINUTUL RAPOARTELOR (Cutia AlbƒÉ) */
    /* Se aplicƒÉ »ôi la Audit (Registre) »ôi la Execu»õie */
    .modal-audit, 
    .modal-executie {
        display: block !important;
        position: relative !important;
        width: 100% !important;
        max-width: none !important; /* Scoatem limitele de lƒÉ»õime */
        min-height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
        overflow: visible !important;
    }

    /* 7. TABELE »òI SEMNƒÇTURI */
    .audit-table {
        width: 100% !important;
        border-collapse: collapse !important;
        font-size: 10pt !important;
    }

    .audit-table th, .audit-table td {
        border: 1px solid black !important;
        padding: 4px !important;
        color: black !important;
    }

    /* Previne ruperea r√¢ndurilor la jumƒÉtate */
    tr { page-break-inside: avoid; }
    
    .audit-signatures {
        display: flex !important;
        justify-content: space-between !important;
        margin-top: 40px;
        page-break-inside: avoid;
    }
    
    /* Ascundem fundalul gri la KPI pentru economie cernealƒÉ */
    .kpi-box {
        border: 1px solid black !important;
        background: white !important;
        color: black !important;
    }
}
}

/* Stilurile pentru celelalte modale rƒÉm√¢n neschimbate */
.modal-overlay.operational { background: rgba(0,0,0,0.5); align-items: center;}
.modal { background: white; width: 500px; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); font-family: 'Inter', sans-serif;}
.modal h2 { margin-top: 0; color: var(--pnras-blue); border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;}
.form-group { margin-bottom: 15px; }
.form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: #555; margin-bottom: 5px; }
.form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-family: 'Inter', sans-serif; }
.tva-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;}
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
.btn-save { background: var(--pnras-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
.btn-cancel { background: #e0e0e0; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }

    </style>
</head>
<body>

    <div class="sidebar">
        <a href="index.html" class="back-btn">‚Üê √énapoi la Meniu</a>

        <div class="total-box">
            <div class="total-label">Buget TOTAL PNRAS</div>
            <div class="total-val blue" id="total-buget">0 LEI</div>
        </div>
        <div class="divider"></div>

        <div class="section-title">Situa»õie Contractare</div>
        <div class="total-box">
            <div class="total-label">Total Contractat</div>
            <div class="total-val orange" id="total-contractat">0 LEI</div>
        </div>
        <div class="total-box">
            <div class="total-label">RƒÉmas de Contractat</div>
            <div class="total-val green" id="total-ramas-contractare">0 LEI</div>
        </div>
        <div class="divider"></div>

        <div class="section-title">Situa»õie PlƒÉ»õi</div>
        <div class="total-box">
            <div class="total-label">Total Cheltuit (PlƒÉtit)</div>
            <div class="total-val red" id="total-platit">0 LEI</div>
        </div>
        <div class="total-box">
            <div class="total-label">RƒÉmas Disponibil √Æn Cont</div>
            <div class="total-val green" id="total-ramas-plati">0 LEI</div>
        </div>

        <div class="divider"></div>

        <div class="section-title">üñ®Ô∏è Centru Printare</div>
        <div style="display: flex; flex-direction: column;">
             <button class="btn-print-sidebar" onclick="printeazaFacturiPeAni()">üí∏ Registru Facturi</button>
            <button class="btn-print-sidebar" onclick="printeazaContractePeAni()">üìù Registru Contracte</button>
            <button class="btn-print-sidebar" onclick="printeazaStatePlata()">üìù Registru State de PlatƒÉ</button>
        </div>

        <div class="divider"></div>
        <div class="section-title">‚è±Ô∏è Execu»õie la DatƒÉ</div>
        <div class="form-group" style="margin-bottom:10px;">
            <input type="date" id="input-data-executie" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
        </div>
        <button class="btn-raport" style="width:100%; margin-bottom:0;" onclick="genereazaExecutieLaData()">üìä Vezi Situa»õia la DatƒÉ</button>
    </div>

    <div class="main-content">
        <div class="top-header">
            <h1>Achizi»õii »ôi PlƒÉ»õi</h1>
            <div class="year-selector">
                <button class="year-btn" onclick="schimbaAn(2024, this)">2024</button>
                <button class="year-btn active" onclick="schimbaAn(2025, this)">2025</button>
                <button class="year-btn" onclick="schimbaAn(2026, this)">2026</button>
                <button class="year-btn total-btn" onclick="schimbaAn('TOTAL', this)">TOTAL PROIECT</button>
            </div>
        </div>

        <div class="activities-nav">
            <div class="activity-card" id="btn-I" onclick="schimbaActivitate('I', this)">Categoria I: ActivitƒÉ»õi de identificarea »ôi monitorizare a elevilor √Æn risc de abandon »ôcolar - MATE</div>
            <div class="activity-card active" id="btn-II" onclick="schimbaActivitate('II', this)">Categoria II: ActivitƒÉ»õi de prevenire, interven»õie »ôi compensare</div>
            <div class="activity-card" id="btn-III" onclick="schimbaActivitate('III', this)">Categoria III: LucrƒÉri minore, achizi»õionarea de bunuri</div>
            <div class="activity-card" id="btn-IV" onclick="schimbaActivitate('IV', this)">Categoria IV: ActivitƒÉ»õi digitalizare proces educa»õional</div>
        </div>

        <div class="selection-summary">
            <div id="text-bara-neagra">SintezƒÉ Selec»õie CurentƒÉ</div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div class="sum-item"><span>Disponibil:</span> <span id="sel-alocat">0 LEI</span></div>
                <div class="sum-item" style="color: #ff6b6b;"><span>Cheltuit:</span> <span id="sel-cheltuit">0 LEI</span></div>
                <div class="sum-item" style="color: #51cf66;"><span>RƒÉmas:</span> <span id="sel-ramas">0 LEI</span></div>
                
                <button class="btn-print-view" onclick="printeazaFisaCurenta()">üñ®Ô∏è PrinteazƒÉ Vizualizarea CurentƒÉ</button>
            </div>
        </div>

        <div class="data-viewport" id="data-container"></div>
    </div>

    <div class="modal-overlay operational" id="modal-executie-overlay">
        <div class="modal-executie">
            <h2 id="exec-data-titlu" style="color:var(--pnras-blue); border-bottom:2px solid #eee; padding-bottom:10px;">SintezƒÉ la data...</h2>
            <div id="exec-data-content"></div>
            <div class="modal-actions" style="margin-top:20px;">
                <button class="btn-cancel" onclick="inchideModale()">√énchide</button>
                <button class="btn-save" onclick="window.print()">üñ®Ô∏è PrinteazƒÉ Sinteza</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-audit-overlay">
        <div class="modal-audit">
            <div class="print-controls">
                <button class="btn-print-action" onclick="window.print()">üñ®Ô∏è PrinteazƒÉ</button>
                <button class="close-audit" onclick="inchideModale()">‚úñ √énchide</button>
            </div>
            <div class="a4-content" id="audit-content"></div>
        </div>
    </div>

    <div class="modal-overlay operational" id="modal-contract">
        <div class="modal">
            <h2 id="modal-contract-title">AdaugƒÉ Document</h2>
            <input type="hidden" id="c-id">
            <input type="hidden" id="c-parent-id">
            <input type="hidden" id="c-an">
            <input type="hidden" id="c-pilon">
            <input type="hidden" id="c-subcategorie">

            <div class="form-group"><label>Titlu / Descriere (Ex: Agora Electronics SRL)</label><input type="text" id="c-titlu"></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group"><label>NumƒÉr Document</label><input type="text" id="c-numar"></div>
                <div class="form-group"><label>Data Document</label><input type="date" id="c-data-document"></div>
            </div>

            <div class="tva-grid">
                <div class="form-group"><label>Val. FƒÉrƒÉ TVA (LEI)</label><input type="number" id="c-fara-tva" step="0.01" oninput="calculeazaTotalContract()"></div>
                <div class="form-group"><label>Val. TVA (LEI)</label><input type="number" id="c-tva" step="0.01" oninput="calculeazaTotalContract()"></div>
                <div class="form-group"><label>TOTAL (Inclusiv TVA)</label><input type="number" id="c-valoare" readonly style="background:#e9ecef; font-weight:bold;"></div>
            </div>

            <div class="form-group"><label>Stare Document</label>
                <select id="c-stare">
                    <option value="Planificat">üü° Planificat / SEAP</option>
                    <option value="In_derulare">üü† √én derulare</option>
                    <option value="Finalizat">üü¢ Finalizat / PlƒÉtit</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="inchideModale()">AnuleazƒÉ</button>
                <button class="btn-save" onclick="salveazaContract()">SalveazƒÉ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay operational" id="modal-factura">
        <div class="modal">
            <h2 id="modal-factura-title">AdaugƒÉ FacturƒÉ / PlatƒÉ</h2>
            <input type="hidden" id="f-id">
            <input type="hidden" id="f-parent-id">
            <input type="hidden" id="f-an">

            <div class="form-group"><label>Descriere (Ex: Agora Electronics SRL)</label><input type="text" id="f-titlu"></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group"><label>NumƒÉr FacturƒÉ</label><input type="text" id="f-numar"></div>
                <div class="form-group"><label>Data FacturƒÉ</label><input type="date" id="f-data-document"></div>
            </div>

            <div class="tva-grid">
                <div class="form-group"><label>FƒÉrƒÉ TVA (LEI)</label><input type="number" id="f-fara-tva" step="0.01" oninput="calculeazaTotalFactura()"></div>
                <div class="form-group"><label>TVA (LEI)</label><input type="number" id="f-tva" step="0.01" oninput="calculeazaTotalFactura()"></div>
                <div class="form-group"><label>TOTAL PlƒÉtit</label><input type="number" id="f-valoare" readonly style="background:#e9ecef; font-weight:bold;"></div>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="inchideModale()">AnuleazƒÉ</button>
                <button class="btn-save" onclick="salveazaFactura()">√énregistreazƒÉ Plata</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://aexjrbdgajurxzngfkpx.supabase.co';
        const supabaseKey = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        let rawData = [];
        let anSelectat = 2025; 
        let pilonSelectat = 'II'; 

        const formatBani = (val) => new Intl.NumberFormat('ro-RO', { style: 'currency', currency: 'RON', minimumFractionDigits: 2 }).format(val);

        const formatDataRo = (str) => {
            if(!str) return "";
            const cleanStr = str.split('T')[0]; 
            const parts = cleanStr.split("-");
            if(parts.length !== 3) return cleanStr;
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        };

        const subcategoriiPNRAS = {
            'a': 'Servicii si bunuri',
            'b': 'Subven»õii, ajutoare, premii',
            'c': 'Cheltuieli de natura salariala',
            'd': 'Cheltuieli formare cadre didactice',
            'e': 'Mobilier si mici lucrari de amenajare',
            'f': 'Echipamente si software'
        };

        function getIerarhiePilonSiCategorie(pilonId, literaDb) {
            const litera = (literaDb || '').toLowerCase().trim();
            let numePilon = "";
            if (pilonId === 'I') numePilon = "Categoria I: ActivitƒÉ»õi de identificarea »ôi monitorizare a elevilor √Æn risc de abandon »ôcolar - MATE";
            else if (pilonId === 'II') numePilon = "Categoria II: ActivitƒÉ»õi de prevenire, interven»õie »ôi compensare";
            else if (pilonId === 'III') numePilon = "Categoria III: LucrƒÉri minore, achizi»õionarea de bunuri";
            else if (pilonId === 'IV') numePilon = "Categoria IV: ActivitƒÉ»õi digitalizare proces educa»õional";
            const numeSubcat = subcategoriiPNRAS[litera] || "Alte cheltuieli";
            return `<span style="font-weight:700;">${numePilon}</span><br><span style="padding-left:15px; font-style:italic;">${litera}. ${numeSubcat}</span>`;
        }

        function getNumeComplet(literaDb) {
            const litera = (literaDb || '').toLowerCase().trim();
            const numeSubcat = subcategoriiPNRAS[litera] || "Alte cheltuieli";
            return `${litera}. ${numeSubcat}`;
        }

        window.onload = function() { incarcaDatele(); };

        async function incarcaDatele() {
            const { data, error } = await supabaseClient.from('buget_pnras').select('*');
            if (error) { console.error(error); return; }
            rawData = data;

            let needsRefresh = false;
            for (let r of rawData) {
                if (r.tip_rand === 'FACTURA' && (!r.pilon || !r.subcategorie)) {
                    const parent = rawData.find(p => p.id === r.parent_id);
                    if (parent) {
                        console.log("Repar factura:", r.titlu);
                        await supabaseClient.from('buget_pnras').update({ 
                            pilon: parent.pilon, 
                            subcategorie: parent.subcategorie 
                        }).eq('id', r.id);
                        needsRefresh = true;
                    }
                }
            }
            if(needsRefresh) {
                const { data: newData } = await supabaseClient.from('buget_pnras').select('*');
                rawData = newData;
                alert("Am reparat automat facturile care nu apƒÉreau! Acum sunt vizibile.");
            }

            calculeazaTotaluriGlobale();
            randeazaContinutul();
        }

        function calculeazaTotalContract() {
            const faraTva = parseFloat(document.getElementById('c-fara-tva').value) || 0;
            const tva = parseFloat(document.getElementById('c-tva').value) || 0;
            document.getElementById('c-valoare').value = (faraTva + tva).toFixed(2);
        }

        function calculeazaTotalFactura() {
            const faraTva = parseFloat(document.getElementById('f-fara-tva').value) || 0;
            const tva = parseFloat(document.getElementById('f-tva').value) || 0;
            document.getElementById('f-valoare').value = (faraTva + tva).toFixed(2);
        }

        function printeazaTotalProiect() {
            const pilonOriginal = pilonSelectat;
            const titluPerioada = (anSelectat === 'TOTAL') ? "MULTIANUALƒÇ (2024 - 2026)" : `ANUL FINANCIAR ${anSelectat}`;
            let totHtml = '';
            const totiPilonii = [
                {id: 'I', nume: 'Categoria I: ActivitƒÉ»õi de identificarea »ôi monitorizare a elevilor √Æn risc de abandon »ôcolar - MATE'}, 
                {id: 'II', nume: 'Categoria II: ActivitƒÉ»õi de prevenire, interven»õie »ôi compensare'}, 
                {id: 'III', nume: 'Categoria III: LucrƒÉri minore, achizi»õionarea de bunuri'}, 
                {id: 'IV', nume: 'Categoria IV: ActivitƒÉ»õi digitalizare proces educa»õional'}
            ];
            totiPilonii.forEach(p => {
                pilonSelectat = p.id;
                const htmlPilon = randeazaLinii(true); 
                if(!htmlPilon.includes("Nu existƒÉ buget")) {
                    totHtml += `<div style="font-family: 'Inter', sans-serif; font-weight:800; font-size: 1.15rem; margin-top: 25px; margin-bottom: 10px; color: var(--pnras-blue); border-bottom: 1px solid var(--pnras-blue); padding-bottom: 3px;">${p.nume.toUpperCase()}</div><div style="font-family: 'Times New Roman', Times, serif;">${htmlPilon}</div>`;
                }
            });
            pilonSelectat = pilonOriginal;
            const printHtml = `<img src="antet_pnras.jpeg" class="antet-img" alt="Antet PNRAS"><div class="audit-title" style="margin-bottom:5px;">REGISTRU COMPLET - EXECU»öIE FINANCIARƒÇ</div><div class="audit-title" style="color:var(--pnras-blue); font-size:1.15rem;">TOATE SEC»öIUNILE DE FINAN»öARE (I - IV)</div><div class="audit-subtitle">Perioada analizatƒÉ: ${titluPerioada} | Data generƒÉrii: ${new Date().toLocaleDateString('ro-RO')}</div>${totHtml}<div class="audit-signatures" style="margin-top: 40px;"><div class="sig-block"><b>√éntocmit,</b><br>Responsabil Financiar PNRAS<br>ec. Viorica MORƒÇRA»òU</div><div class="sig-block" style="text-align: right;"><b>Aprobat,</b><br>Director,<br>prof. CƒÉtƒÉlin Ionu»õ BAZILUC</div></div>`;
            document.getElementById('audit-content').innerHTML = printHtml; document.getElementById('modal-audit-overlay').style.display = 'flex';
        }

        function printeazaFacturiPeAni() {
            let tabelHtml = ''; let totalPlatitGrand = 0;
            [2024, 2025, 2026].forEach(an => {
                let facturiAn = rawData.filter(r => r.tip_rand === 'FACTURA' && r.an == an);
                if(facturiAn.length > 0) {
                    facturiAn.sort((a, b) => new Date(a.data_document) - new Date(b.data_document));
                    let totalAn = 0;
                    tabelHtml += `<div class="section-h" style="margin-top: 25px;">Facturi Efectuate √Æn Anul ${an}</div><table class="audit-table"><thead><tr><th class="text-left" style="width: 50%;">Categorie / Pilon</th><th class="text-left">Denumire FacturƒÉ</th><th style="width: 15%;">Suma PlƒÉtitƒÉ</th></tr></thead><tbody>`;
                    facturiAn.forEach(f => { 
                        totalAn += parseFloat(f.valoare); 
                        const titlu = `FacturƒÉ Nr. ${f.numar || '??'}/${formatDataRo(f.data_document)} (${f.titlu})`;
                        tabelHtml += `<tr><td class="text-left">${getIerarhiePilonSiCategorie(f.pilon, f.subcategorie)}</td><td class="text-left">${titlu}</td><td>${formatBani(f.valoare)}</td></tr>`; 
                    });
                    totalPlatitGrand += totalAn;
                    tabelHtml += `<tr class="total-row"><td colspan="2" class="text-left">TOTAL PLƒÇTIT ANUL ${an}:</td><td>${formatBani(totalAn)}</td></tr></tbody></table>`;
                }
            });
            const printHtml = `<img src="antet_pnras.jpeg" class="antet-img" alt="Antet PNRAS"><div class="audit-title" style="margin-bottom:5px;">REGISTRU JURNAL DE PLƒÇ»öI (FACTURI)</div><div class="audit-subtitle">Generat la data: ${new Date().toLocaleDateString('ro-RO')} | Total Istoric PlƒÉtit: ${formatBani(totalPlatitGrand)}</div>${tabelHtml}<div class="audit-signatures"><div class="sig-block"><b>√éntocmit,</b><br>Responsabil Financiar PNRAS<br>ec. Viorica MORƒÇRA»òU</div><div class="sig-block" style="text-align: right;"><b>Aprobat,</b><br>Director,<br>prof. CƒÉtƒÉlin Ionu»õ BAZILUC</div></div>`;
            document.getElementById('audit-content').innerHTML = printHtml; document.getElementById('modal-audit-overlay').style.display = 'flex';
        }

        function printeazaContractePeAni() {
            let tabelHtml = ''; let totalContractatGrand = 0;
            [2024, 2025, 2026].forEach(an => {
                let contracteAn = rawData.filter(r => r.tip_rand === 'CONTRACT' && r.subcategorie !== 'c' && r.an == an);
                if(contracteAn.length > 0) {
                    contracteAn.sort((a, b) => new Date(a.data_document) - new Date(b.data_document));
                    let totalAn = 0;
                    tabelHtml += `<div class="section-h" style="margin-top: 25px;">Proceduri / Contracte din Anul ${an}</div><table class="audit-table"><thead><tr><th class="text-left" style="width: 50%;">Linie Buget / Pilon</th><th class="text-left">Obiect Achizi»õie</th><th>Stare</th><th style="width: 15%;">Valoare AngajatƒÉ</th></tr></thead><tbody>`;
                    contracteAn.forEach(c => { 
                        totalAn += parseFloat(c.valoare); 
                        const titlu = `Contract Nr. ${c.numar || '??'}/${formatDataRo(c.data_document)} (${c.titlu})`;
                        tabelHtml += `<tr><td class="text-left">${getIerarhiePilonSiCategorie(c.pilon, c.subcategorie)}</td><td class="text-left">${titlu}</td><td>${c.stare}</td><td>${formatBani(c.valoare)}</td></tr>`; 
                    });
                    totalContractatGrand += totalAn;
                    tabelHtml += `<tr class="total-row"><td colspan="3" class="text-left">TOTAL ANGAJAMENTE ANUL ${an}:</td><td>${formatBani(totalAn)}</td></tr></tbody></table>`;
                }
            });
            const printHtml = `<img src="antet_pnras.jpeg" class="antet-img" alt="Antet PNRAS"><div class="audit-title" style="margin-bottom:5px;">REGISTRU PROCEDURI DE ACHIZI»öIE (CONTRACTE)</div><div class="audit-subtitle">Generat la data: ${new Date().toLocaleDateString('ro-RO')} | Total Istoric Angajat: ${formatBani(totalContractatGrand)}</div>${tabelHtml}<div class="audit-signatures"><div class="sig-block"><b>√éntocmit,</b><br>Responsabil Financiar PNRAS<br>ec. Viorica MORƒÇRA»òU</div><div class="sig-block" style="text-align: right;"><b>Aprobat,</b><br>Director,<br>prof. CƒÉtƒÉlin Ionu»õ BAZILUC</div></div>`;
            document.getElementById('audit-content').innerHTML = printHtml; document.getElementById('modal-audit-overlay').style.display = 'flex';
        }

        function printeazaStatePlata() {
            let tabelHtml = ''; let totalSalariiGrand = 0;
            [2024, 2025, 2026].forEach(an => {
                let stateAn = rawData.filter(r => r.tip_rand === 'CONTRACT' && r.subcategorie === 'c' && r.an == an);
                if(stateAn.length > 0) {
                    stateAn.sort((a, b) => new Date(a.data_document) - new Date(b.data_document));
                    let totalAn = 0;
                    tabelHtml += `<div class="section-h" style="margin-top: 25px;">State de PlatƒÉ Salarii - Anul ${an}</div><table class="audit-table"><thead><tr><th class="text-left" style="width: 25%;">Pilon / Activitate</th><th class="text-left">Identificator Stat</th><th style="width: 20%;">Suma AchitatƒÉ</th></tr></thead><tbody>`;
                    stateAn.forEach(s => { 
                        totalAn += parseFloat(s.valoare); 
                        const titlu = `Stat Nr. ${s.numar || '??'}/${formatDataRo(s.data_document)} (${s.titlu})`;
                        tabelHtml += `<tr><td class="text-left">Pilon ${s.pilon}</td><td class="text-left">${titlu}</td><td>${formatBani(s.valoare)}</td></tr>`; 
                    });
                    totalSalariiGrand += totalAn;
                    tabelHtml += `<tr class="total-row"><td colspan="2" class="text-left">TOTAL SALARII ANUL ${an}:</td><td>${formatBani(totalAn)}</td></tr></tbody></table>`;
                }
            });
            const printHtml = `<img src="antet_pnras.jpeg" class="antet-img" alt="Antet PNRAS"><div class="audit-title" style="margin-bottom:5px;">REGISTRU JURNAL - STATE DE PLATƒÇ (SALARII)</div><div class="audit-subtitle">Generat la data: ${new Date().toLocaleDateString('ro-RO')} | Total Istoric Salarii: ${formatBani(totalSalariiGrand)}</div>${tabelHtml}<div class="audit-signatures"><div class="sig-block"><b>√éntocmit,</b><br>Responsabil Financiar PNRAS<br>ec. Viorica MORƒÇRA»òU</div><div class="sig-block" style="text-align: right;"><b>Aprobat,</b><br>Director,<br>prof. CƒÉtƒÉlin Ionu»õ BAZILUC</div></div>`;
            document.getElementById('audit-content').innerHTML = printHtml; document.getElementById('modal-audit-overlay').style.display = 'flex';
        }

        function genereazaExecutieLaData() {
            const dataLimita = document.getElementById('input-data-executie').value;
            if(!dataLimita) { alert("VƒÉ rugƒÉm selecta»õi o datƒÉ!"); return; }

            const dLim = new Date(dataLimita);
            dLim.setHours(23, 59, 59); 

            let totalB = 0, totalC = 0, totalP = 0;

            // 1. Calcule Generale
            rawData.filter(r => r.tip_rand === 'BUGET').forEach(r => totalB += parseFloat(r.valoare));
            
            rawData.filter(r => r.tip_rand === 'CONTRACT').forEach(r => {
                const dDoc = new Date(r.data_document);
                if(dDoc <= dLim) totalC += parseFloat(r.valoare);
            });

            rawData.forEach(r => {
                const dDoc = new Date(r.data_document);
                if(dDoc <= dLim) {
                    if (r.tip_rand === 'FACTURA') {
                        totalP += parseFloat(r.valoare);
                    } else if (r.tip_rand === 'CONTRACT' && r.subcategorie === 'c') {
                        totalP += parseFloat(r.valoare);
                    }
                }
            });

            const gradAbs = totalB > 0 ? (totalP / totalB) * 100 : 0;
            const gradContr = totalB > 0 ? (totalC / totalB) * 100 : 0;

            // --- A. Statistici pe Categorii ---
            const mapCategorii = {};
            const litere = ['a','b','c','d','e','f'];
            litere.forEach(l => { 
                mapCategorii[l] = { alocat: 0, contractat: 0, platit: 0, nume: subcategoriiPNRAS[l] || 'Altele' }; 
            });

            rawData.forEach(r => {
                const dDoc = new Date(r.data_document);
                if (r.tip_rand === 'BUGET' && mapCategorii[r.subcategorie]) {
                     mapCategorii[r.subcategorie].alocat += parseFloat(r.valoare);
                }
                if (dDoc <= dLim) {
                    if (r.tip_rand === 'CONTRACT' && mapCategorii[r.subcategorie]) {
                        mapCategorii[r.subcategorie].contractat += parseFloat(r.valoare);
                        if (r.subcategorie === 'c') mapCategorii[r.subcategorie].platit += parseFloat(r.valoare);
                    }
                    if (r.tip_rand === 'FACTURA' && mapCategorii[r.subcategorie]) {
                        mapCategorii[r.subcategorie].platit += parseFloat(r.valoare);
                    }
                }
            });

            let htmlCategorii = `
                <div class="audit-section">
                    <div class="section-h">AnalizƒÉ VerticalƒÉ pe Categorii de Cheltuieli</div>
                    <table class="audit-table">
                        <thead>
                            <tr>
                                <th class="text-left">Categorie</th>
                                <th>Alocat</th>
                                <th>Contractat</th>
                                <th>PlƒÉtit</th><th>RƒÉmas</th><th>% Absorb»õie</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            litere.forEach(l => {
                const cat = mapCategorii[l];
                const proc = cat.alocat > 0 ? (cat.platit / cat.alocat) * 100 : 0;
                htmlCategorii += `
                    <tr>
                        <td class="text-left"><b>${l.toUpperCase()}.</b> ${cat.nume}</td>
                        <td>${formatBani(cat.alocat)}</td>
                        <td>${formatBani(cat.contractat)}</td>
                        <td>${formatBani(cat.platit)}</td><td style="font-weight:bold; color: #28a745;">${formatBani(cat.alocat - cat.platit)}</td><td>${proc.toFixed(2)}%</td>
                    </tr>`;
            });
            htmlCategorii += `</tbody></table></div>`;


            // --- B. Statistici pe Piloni ---
            const mapNumePiloni = {
                'I': 'Categoria I: ActivitƒÉ»õi de identificarea »ôi monitorizare a elevilor √Æn risc de abandon »ôcolar - MATE ',
                'II': 'Categoria II: ActivitƒÉ»õi de prevenire, interven»õie »ôi compensare',
                'III': 'Categoria III: LucrƒÉri minore, achizi»õionarea de bunuri',
                'IV': 'Categoria IV: ActivitƒÉ»õi digitalizare proces educa»õional'
            };

            let piloniHtml = '<div class="audit-section"><div class="section-h">AnalizƒÉ pe Piloni de Investi»õie</div><table class="audit-table"><thead><tr><th class="text-left">Pilon de Investi»õie</th><th>Alocat</th><th>Contractat</th><th>PlƒÉtit</th><th>RƒÉmas</th><th>%</th></tr></thead><tbody>';
            
            ['I', 'II', 'III', 'IV'].forEach(p => {
                let pB = 0, pC = 0, pP = 0;
                rawData.filter(r => r.tip_rand === 'BUGET' && r.pilon === p).forEach(r => pB += parseFloat(r.valoare));
                rawData.filter(r => r.tip_rand === 'CONTRACT' && r.pilon === p).forEach(r => {
                    if(new Date(r.data_document) <= dLim) pC += parseFloat(r.valoare);
                });
                rawData.forEach(r => {
                    if(r.pilon === p && new Date(r.data_document) <= dLim) {
                         if(r.tip_rand === 'FACTURA') pP += parseFloat(r.valoare);
                         else if(r.tip_rand === 'CONTRACT' && r.subcategorie === 'c') pP += parseFloat(r.valoare);
                    }
                });
                const procP = pB > 0 ? (pP / pB) * 100 : 0;
                piloniHtml += `<tr><td class="text-left"><b>Pilon ${p}.</b> ${mapNumePiloni[p]}</td><td>${formatBani(pB)}</td><td>${formatBani(pC)}</td><td>${formatBani(pP)}</td><td><b>${formatBani(pB - pP)}</b></td><td>${procP.toFixed(1)}%</td></tr>`;
            });
            piloniHtml += '</tbody></table></div>';

            // --- C. Detaliere √éncruci»ôatƒÉ (Pilon x Categorie) ---
            let detaliereHtml = '<div class="audit-section"><div class="section-h">Detaliere √éncruci»ôatƒÉ (Pilon x Categorie)</div>';
            
            ['I', 'II', 'III', 'IV'].forEach(p => {
                const hasActivity = rawData.some(r => r.pilon === p && (r.tip_rand === 'BUGET' || new Date(r.data_document) <= dLim));
                
                if(hasActivity) {
                    detaliereHtml += `<div style="margin-bottom:15px; border:1px solid #eee; padding:10px; border-radius:4px; page-break-inside: avoid;">
                        <div style="font-weight:bold; color:var(--pnras-blue); margin-bottom:5px;">Pilon ${p}. ${mapNumePiloni[p]}</div>
                        <table class="audit-table" style="font-size:0.8rem;">
                            <thead>
                                <tr>
                                    <th class="text-left">Categorie</th>
                                    <th>Alocat</th>
                                    <th>Contractat</th>
                                    <th>PlƒÉtit</th>
                                    <th>RƒÉmas</th>
                                    <th>% Abs.</th>
                                </tr>
                            </thead>
                        <tbody>`;
                    
                    ['a','b','c','d','e','f'].forEach(l => {
                        let subB = 0, subC = 0, subP = 0;
                        rawData.filter(r => r.pilon === p && r.subcategorie === l && r.tip_rand === 'BUGET').forEach(r => subB += parseFloat(r.valoare));
                        rawData.filter(r => r.pilon === p && r.subcategorie === l && r.tip_rand === 'CONTRACT').forEach(r => {
                            if(new Date(r.data_document) <= dLim) subC += parseFloat(r.valoare);
                        });
                        rawData.forEach(r => {
                            if(r.pilon === p && r.subcategorie === l && new Date(r.data_document) <= dLim) {
                                if(r.tip_rand === 'FACTURA') subP += parseFloat(r.valoare);
                                else if(r.tip_rand === 'CONTRACT' && r.subcategorie === 'c') subP += parseFloat(r.valoare);
                            }
                        });

                        let subRamas = subB - subP;
                        let subProcent = subB > 0 ? (subP / subB) * 100 : 0;

                        if(subB > 0 || subC > 0 || subP > 0) {
                            detaliereHtml += `<tr>
                                <td class="text-left">${l.toUpperCase()}. ${subcategoriiPNRAS[l]}</td>
                                <td>${formatBani(subB)}</td>
                                <td>${formatBani(subC)}</td>
                                <td>${formatBani(subP)}</td>
                                <td style="font-weight:bold; color:${subRamas >= 0 ? '#28a745' : '#dc3545'}">${formatBani(subRamas)}</td>
                                <td>${subProcent.toFixed(2)}%</td>
                            </tr>`;
                        }
                    });
                    detaliereHtml += `</tbody></table></div>`;
                }
            });
            detaliereHtml += '</div>';

            // --- AFISARE FINALƒÇ (Antet, Titlu, SemnƒÉturi) ---
            const htmlAntet = `<img src="antet_pnras.jpeg" class="antet-img" alt="Antet PNRAS">`;
            const htmlTitlu = `<h2 style="text-align:center; margin-bottom:20px; font-family:'Times New Roman', serif;">EXECU»öIE BUGETARƒÇ LA DATA DE ${formatDataRo(dataLimita)}</h2>`;

            // Ascundem titlul vechi al ferestrei
            document.getElementById('exec-data-titlu').style.display = 'none';

            let htmlSinteza = `
                <div class="kpi-grid">
                    <div class="kpi-box"><div class="kpi-label">Buget Proiect</div><div class="kpi-val">${formatBani(totalB)}</div></div>
                    <div class="kpi-box"><div class="kpi-label">Contractat p√¢nƒÉ la ${formatDataRo(dataLimita)}</div><div class="kpi-val" style="color:var(--orange);">${formatBani(totalC)}</div></div>
                    <div class="kpi-box"><div class="kpi-label">PlƒÉtit p√¢nƒÉ la ${formatDataRo(dataLimita)}</div><div class="kpi-val" style="color:var(--red);">${formatBani(totalP)}</div></div>
                </div>
                <div class="audit-section">
                    <div class="section-h">Indicatori de Performan»õƒÉ (SintezƒÉ)</div>
                    <table class="audit-table">
                        <tr><td class="text-left">Grad Absorb»õie la datƒÉ:</td><td><b>${gradAbs.toFixed(2)}%</b></td></tr>
                        <tr><td class="text-left">Grad Contractare la datƒÉ:</td><td><b>${gradContr.toFixed(2)}%</b></td></tr>
                        <tr class="total-row"><td class="text-left">DISPONIBIL NECONTRACTAT:</td><td>${formatBani(totalB - totalC)}</td></tr>
                        <tr class="total-row"><td class="text-left">DIFEREN»öƒÇ DE PLATƒÇ (Angajat - PlƒÉtit):</td><td>${formatBani(totalC - totalP)}</td></tr>
                    </table>
                </div>
            `;

            // Blocul de semnƒÉturi cu PAGE-BREAK-INSIDE: AVOID
            let htmlSemnaturi = `
                <div style="margin-top: 50px; display: flex; justify-content: space-between; font-family: 'Times New Roman', serif; font-size: 11pt; page-break-inside: avoid; break-inside: avoid;">
                    <div style="text-align: left; width: 30%;">
                        <b>√éntocmit,</b><br><br>
                        ec. Viorica MORƒÇRA»òU
                    </div>
                    <div style="text-align: center; width: 30%;">
                        <b>Avizat,</b><br>
                        Manager proiect,<br>
                        prof. dr. Ciprian MIHAI
                    </div>
                    <div style="text-align: right; width: 30%;">
                        <b>Aprobat,</b><br>
                        Director,<br>
                        prof. CƒÉtƒÉlin BAZILUC
                    </div>
                </div>
            `;

            // InjectƒÉm TOT con»õinutul
            document.getElementById('exec-data-content').innerHTML = htmlAntet + htmlTitlu + htmlSinteza + piloniHtml + htmlCategorii + detaliereHtml + htmlSemnaturi;
            document.getElementById('modal-executie-overlay').style.display = 'flex';
        }

        function calculeazaTotaluriGlobale() {
            let totalBuget = 0, totalContractat = 0, totalPlatit = 0;
            rawData.filter(r => r.tip_rand === 'BUGET').forEach(r => totalBuget += parseFloat(r.valoare));
            rawData.filter(r => r.tip_rand === 'CONTRACT').forEach(r => totalContractat += parseFloat(r.valoare));
            rawData.filter(r => r.tip_rand === 'FACTURA').forEach(r => totalPlatit += parseFloat(r.valoare));
            document.getElementById('total-buget').innerText = formatBani(totalBuget);
            document.getElementById('total-contractat').innerText = formatBani(totalContractat);
            document.getElementById('total-ramas-contractare').innerText = formatBani(totalBuget - totalContractat);
            document.getElementById('total-platit').innerText = formatBani(totalPlatit);
            document.getElementById('total-ramas-plati').innerText = formatBani(totalBuget - totalPlatit);
        }

        function randeazaContinutul() {
            const html = randeazaLinii(false);
            document.getElementById('data-container').innerHTML = html;
        }

        function randeazaLinii(isPrintMode) {
            let containerHtml = '';
            const isTotalView = (anSelectat === 'TOTAL');
            
            if(!isPrintMode) {
                if(isTotalView) document.getElementById('text-bara-neagra').innerText = "SintezƒÉ MultianualƒÉ TOTALƒÇ (Execu»õie 2024 - 2026)";
                else document.getElementById('text-bara-neagra').innerText = "SintezƒÉ Selec»õie CurentƒÉ (Include reportƒÉrile din anii trecu»õi)";
            }
            
            const liniiDinPilon = rawData.filter(r => r.tip_rand === 'BUGET' && r.pilon === pilonSelectat);
            const categoriiUnice = [...new Set(liniiDinPilon.map(r => r.subcategorie))].sort();
            
            let selTotalDisponibil = 0; 
            let selTotalCheltuit = 0;
            let randate = 0;
            
            // Functie ajutatoare pentru a detecta daca exista facturi in anul selectat sau in viitor
            const hasFacturiInAn = (id, an) => rawData.some(x => x.tip_rand === 'FACTURA' && x.parent_id === id && x.an == an);

            categoriiUnice.forEach(subcat => {
                const bugetOriginal = liniiDinPilon.find(r => r.subcategorie === subcat);
                const titluComplet = getNumeComplet(subcat);
                let bugetRealDisponibil = 0, bugetCheltuitInAn = 0, contracteCurente = [], timelineHtml = '';
                let b24 = 0, b25 = 0, b26 = 0, p24 = 0, p25 = 0, p26 = 0;

                rawData.filter(r => r.tip_rand === 'BUGET' && r.pilon === pilonSelectat && r.subcategorie === subcat).forEach(r => {
                    if(r.an == 2024) b24 += parseFloat(r.valoare); if(r.an == 2025) b25 += parseFloat(r.valoare); if(r.an == 2026) b26 += parseFloat(r.valoare);
                });
                rawData.filter(r => r.tip_rand === 'FACTURA' && r.pilon === pilonSelectat && r.subcategorie === subcat).forEach(r => {
                    if(r.an == 2024) p24 += parseFloat(r.valoare); if(r.an == 2025) p25 += parseFloat(r.valoare); if(r.an == 2026) p26 += parseFloat(r.valoare);
                });

                let r24 = b24 - p24;
                let r25_cumulat = r24 + b25 - p25;
                let r26_cumulat = r25_cumulat + b26 - p26;

                if(isTotalView) {
                    bugetRealDisponibil = b24 + b25 + b26;
                    selTotalDisponibil += bugetRealDisponibil;
                    
                    contracteCurente = rawData.filter(r => r.tip_rand === 'CONTRACT' && r.pilon === pilonSelectat && r.subcategorie === subcat);
                    
                    // SORTARE CRONOLOGICA CONTRACTE TOTAL
                    contracteCurente.sort((a, b) => new Date(a.data_document) - new Date(b.data_document));
                    
                    if (bugetRealDisponibil <= 0) return;
                    
                    let c25 = (p25 > b25) ? (r25_cumulat >= 0 ? "color:var(--green);" : "color:var(--red);") : "";
                    let c26 = (p26 > b26) ? (r26_cumulat >= 0 ? "color:var(--green);" : "color:var(--red);") : "";
                    timelineHtml = `<div class="matrix-grid"><div class="matrix-col"><div class="matrix-title">Total Proiect</div><div class="m-row"><span class="m-lbl">Alocat:</span><span class="m-val">${formatBani(bugetRealDisponibil)}</span></div><div class="m-row"><span class="m-lbl">Cheltuit:</span><span class="m-val">${formatBani(p24+p25+p26)}</span></div><div class="m-row" style="color:var(--pnras-blue);"><span class="m-lbl">RƒÉmas Final:</span><span class="m-val">${formatBani(r26_cumulat)}</span></div></div><div class="matrix-col"><div class="matrix-title">Anul 2024</div><div class="m-row"><span class="m-lbl">Alocat:</span><span class="m-val">${formatBani(b24)}</span></div><div class="m-row"><span class="m-lbl">Cheltuit:</span><span class="m-val">${formatBani(p24)}</span></div><div class="m-row" style="${p24>b24 ? 'color:var(--red);' : ''}"><span class="m-lbl">RƒÉmas 2024:</span><span class="m-val">${formatBani(r24)}</span></div></div><div class="matrix-col"><div class="matrix-title">Anul 2025</div><div class="m-row"><span class="m-lbl">Alocat:</span><span class="m-val">${formatBani(b25)}</span></div><div class="m-row"><span class="m-lbl">Cheltuit:</span><span class="m-val">${formatBani(p25)}</span></div><div class="m-row" style="${c25}"><span class="m-lbl">RƒÉmas '24+'25:</span><span class="m-val">${formatBani(r25_cumulat)}</span></div></div><div class="matrix-col"><div class="matrix-title">Anul 2026</div><div class="m-row"><span class="m-lbl">Alocat:</span><span class="m-val">${formatBani(b26)}</span></div><div class="m-row"><span class="m-lbl">Cheltuit:</span><span class="m-val">${formatBani(p26)}</span></div><div class="m-row" style="${c26}"><span class="m-lbl">RƒÉmas Total:</span><span class="m-val">${formatBani(r26_cumulat)}</span></div></div></div>`;
                } else {
                    const bugetAnual = rawData.find(r => r.tip_rand === 'BUGET' && r.pilon === pilonSelectat && r.subcategorie === subcat && r.an == anSelectat);
                    const bugetAnCurent = bugetAnual ? parseFloat(bugetAnual.valoare) : 0;
                    
                    let reportatTrecut = 0; 
                    if(anSelectat == 2025) reportatTrecut = r24; 
                    if(anSelectat == 2026) reportatTrecut = r25_cumulat;
                    
                    let bugetViitor = 0; 
                    if(anSelectat == 2024) bugetViitor = b25 + b26; 
                    if(anSelectat == 2025) bugetViitor = b26;
                    
                    bugetRealDisponibil = bugetAnCurent + reportatTrecut;
                    selTotalDisponibil += bugetRealDisponibil;

                    if (bugetRealDisponibil <= 0 && bugetAnCurent <= 0) return;
                    
                    // FILTRU ACTUALIZAT: Afiseaza contractul daca:
                    // 1. E creat in anul curent
                    // 2. E creat in trecut SI (e in derulare SAU are facturi in anul curent)
                    contracteCurente = rawData.filter(r => 
                        r.tip_rand === 'CONTRACT' && 
                        r.pilon === pilonSelectat && 
                        r.subcategorie === subcat && 
                        (
                            r.an == anSelectat || 
                            (r.an < anSelectat && (r.stare === 'In_derulare' || hasFacturiInAn(r.id, anSelectat)))
                        )
                    );

                    // SORTARE CRONOLOGICA CONTRACTE
                    contracteCurente.sort((a, b) => new Date(a.data_document) - new Date(b.data_document));
                    
                    let textAnTrecut = "RƒÉma»ôi din anii trecu»õi:"; if(anSelectat == 2025) textAnTrecut = "RƒÉma»ôi din 2024:"; if(anSelectat == 2026) textAnTrecut = "RƒÉma»ôi din 2024 & 2025:";
                    let textAnViitor = "RƒÉma»ôi pt. anii viitori:"; if(anSelectat == 2024) textAnViitor = "RƒÉma»ôi pt. 2025 & 2026:"; if(anSelectat == 2025) textAnViitor = "RƒÉma»ôi pt. 2026:";
                    timelineHtml = `<div class="budget-timeline"><div class="timeline-item"><span class="timeline-label">${textAnTrecut}</span><span class="timeline-val plus">${reportatTrecut > 0 ? '+ ' + formatBani(reportatTrecut) : formatBani(reportatTrecut)}</span></div><div class="timeline-item"><span class="timeline-label">PrevƒÉzut pe ${anSelectat}:</span><span class="timeline-val">${formatBani(bugetAnCurent)}</span></div><div class="timeline-item" style="opacity: ${bugetViitor > 0 ? 1 : 0.5}"><span class="timeline-label">${textAnViitor}</span><span class="timeline-val future">${formatBani(bugetViitor)}</span></div></div>`;
                }

                let contracteHtml = '';

                contracteCurente.forEach(contract => {
                    const facturi = rawData.filter(r => r.parent_id === contract.id && r.tip_rand === 'FACTURA');
                    // SORTARE CRONOLOGICA FACTURI (existenta)
                    facturi.sort((a, b) => new Date(a.data_document) - new Date(b.data_document));
                    
                    const cheltuitContract = facturi.reduce((sum, f) => sum + parseFloat(f.valoare), 0);
                    
                    if(subcat === 'c') {
                        if(contract.an == anSelectat || isTotalView) {
                            bugetCheltuitInAn += parseFloat(contract.valoare);
                        }
                    } else {
                        if (isTotalView) {
                            bugetCheltuitInAn += cheltuitContract;
                        } else {
                            const facturiStrictAn = facturi.filter(f => f.an == anSelectat);
                            const sumaFacturiAn = facturiStrictAn.reduce((sum, f) => sum + parseFloat(f.valoare), 0);
                            bugetCheltuitInAn += sumaFacturiAn;
                        }
                    }

                    // --- LOGICA VIZUALA PENTRU STARE ---
                    // Daca contractul este "Finalizat", dar are facturi intr-un an viitor fata de cel selectat,
                    // inseamna ca in anul selectat era inca "In_derulare".
                    let displayStare = contract.stare;
                    if(contract.stare === 'Finalizat' && rawData.some(f => f.tip_rand === 'FACTURA' && f.parent_id === contract.id && f.an > anSelectat)) {
                        displayStare = 'In_derulare';
                    }
                    const clasaStare = (displayStare === 'Finalizat') ? 'platit' : 'derulare';
                    // -----------------------------------

                    let facturiHtml = facturi.map(f => {
                        const tvaInfo = (f.val_tva > 0 || f.val_fara_tva > 0) ? `<span style="color:#777; font-size:0.7rem; font-style:italic;">(FƒÉrƒÉ TVA: ${formatBani(f.val_fara_tva)} | TVA: ${formatBani(f.val_tva)})</span>` : '';
                        const dateF = formatDataRo(f.data_document);
                        const titluFactura = `Factura Nr. ${f.numar || '??'}/${dateF} (${f.titlu})`;
                        
                        const stilFactura = (f.an != anSelectat && !isTotalView) ? "opacity: 0.5;" : "";

                        return `<div class="factura-row" style="${stilFactura}"><span style="display:flex; flex-direction:column;"><span>‚Ü™ ${titluFactura}</span>${tvaInfo}</span><div style="display:flex; align-items:center;"><b>${formatBani(f.valoare)}</b>${(!isPrintMode && !isTotalView) ? `<button class="btn-action-small btn-edit no-print" onclick="deschideEditareFactura('${f.id}')">‚úèÔ∏è</button><button class="btn-action-small btn-delete no-print" onclick="stergeFactura('${f.id}')">üóëÔ∏è</button>` : ''}</div></div>`;
                    }).join('');

                    const cTvaInfo = (contract.val_tva > 0 || contract.val_fara_tva > 0) ? `<div class="tva-details">(FƒÉrƒÉ TVA: ${formatBani(contract.val_fara_tva)} | TVA: ${formatBani(contract.val_tva)})</div>` : '';
                    const tipC = subcat === 'c' ? 'Stat de platƒÉ' : 'Contract';
                    const dateC = formatDataRo(contract.data_document);
                    const titluContract = `${tipC} Nr. ${contract.numar || '??'}/${dateC} (${contract.titlu})`;

                    contracteHtml += `
                        <div class="contract-box">
                            <div class="contract-header">
                                <span>${titluContract}</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span>${formatBani(contract.valoare)} <span class="contract-status ${clasaStare}">${displayStare}</span></span>
                                    ${(!isPrintMode && !isTotalView) ? `<button class="btn-action-small btn-edit no-print" onclick="deschideEditareContract('${contract.id}')">‚úèÔ∏è</button><button class="btn-action-small btn-delete no-print" onclick="stergeContract('${contract.id}')">üóëÔ∏è</button>` : ''}
                                </div>
                            </div>
                            ${cTvaInfo}
                            <div class="factura-list">${facturiHtml}</div>
                            ${(!isTotalView && !isPrintMode && subcat !== 'c') ? `<button class="btn-add-factura no-print" onclick="deschideModalFactura('${contract.id}', ${anSelectat})">‚ûï PlƒÉte»ôte facturƒÉ (Tran»ôƒÉ)</button>` : ''}
                        </div>
                    `;
                });

                if(!isTotalView) {
                    const facturiOrfane = rawData.filter(f => f.tip_rand === 'FACTURA' && f.pilon === pilonSelectat && f.subcategorie === subcat && f.an == anSelectat && !contracteCurente.some(c => c.id === f.parent_id));
                    facturiOrfane.forEach(f => bugetCheltuitInAn += parseFloat(f.valoare));
                }

                selTotalCheltuit += bugetCheltuitInAn;
                const ramasLaFinal = bugetRealDisponibil - bugetCheltuitInAn;
                const labelCheltuit = isTotalView ? "Total Cheltuit" : `Cheltuit (${anSelectat})`;
                const labelDisponibil = isTotalView ? "Alocat Total Proiect" : "Disponibil Acum";
                const labelRamasFin = isTotalView ? "RƒÉmas Total Proiect" : ((anSelectat == 2026) ? "RƒÉmas p√¢nƒÉ la final" : "RƒÉmas pt. viitor");

                randate++;

                containerHtml += `
                    <div class="buget-row">
                        <div class="buget-header">
                            <div class="buget-title-container">
                                <div class="buget-title">${titluComplet}</div>
                                <div class="line-financials">
                                    <div class="fin-block alocat"><span class="fin-label">${labelDisponibil}</span><span class="fin-val">${formatBani(bugetRealDisponibil)}</span></div>
                                    <div class="fin-block cheltuit"><span class="fin-label">${labelCheltuit}</span><span class="fin-val">${formatBani(bugetCheltuitInAn)}</span></div>
                                    <div class="fin-block ramas"><span class="fin-label">${labelRamasFin}</span><span class="fin-val">${formatBani(ramasLaFinal)}</span></div>
                                </div>
                            </div>
                            ${timelineHtml}
                        </div>
                        <div class="contracte-container">
                            ${contracteHtml}
                            ${(!isTotalView && !isPrintMode) ? `<button class="btn-add-contract no-print" onclick="deschideModalContract('${bugetOriginal.id}', ${anSelectat}, '${pilonSelectat}', '${subcat}')">${subcat === 'c' ? '‚ûï √énregistreazƒÉ Stat de PlatƒÉ' : '‚ûï AdaugƒÉ Contract / Achizi»õie √Æn ' + anSelectat}</button>` : ''}
                        </div>
                    </div>
                `;
            });

            if(randate === 0) containerHtml = `<div class="empty-state">Nu existƒÉ buget disponibil pentru aceastƒÉ activitate.</div>`;
            
            if(!isPrintMode) {
                document.getElementById('sel-alocat').innerText = formatBani(selTotalDisponibil);
                document.getElementById('sel-cheltuit').innerText = formatBani(selTotalCheltuit);
                document.getElementById('sel-ramas').innerText = formatBani(selTotalDisponibil - selTotalCheltuit);
            }
            return containerHtml;
        }

        function schimbaAn(an, btn) { anSelectat = an; document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); randeazaContinutul(); }
        function schimbaActivitate(pilon, btn) { pilonSelectat = pilon; document.querySelectorAll('.activity-card').forEach(b => b.classList.remove('active')); btn.classList.add('active'); randeazaContinutul(); }
        
        function deschideModalContract(parentId, an, pilon, subcat) { 
            resetModale();
            document.getElementById('modal-contract-title').innerText = subcat === 'c' ? "√énregistrare Stat de PlatƒÉ" : "AdaugƒÉ Contract / Achizi»õie";
            document.getElementById('c-parent-id').value = parentId; 
            document.getElementById('c-an').value = an; 
            document.getElementById('c-pilon').value = pilon; 
            document.getElementById('c-subcategorie').value = subcat; 
            if(subcat === 'c') { document.getElementById('c-stare').value = 'Finalizat'; }
            document.getElementById('modal-contract').style.display = 'flex'; 
        }

        function deschideEditareContract(id) {
            resetModale();
            const item = rawData.find(r => r.id === id);
            document.getElementById('modal-contract-title').innerText = item.subcategorie === 'c' ? "EditeazƒÉ Stat de PlatƒÉ" : "EditeazƒÉ Contract";
            document.getElementById('c-id').value = item.id;
            document.getElementById('c-titlu').value = item.titlu;
            document.getElementById('c-numar').value = item.numar || '';
            document.getElementById('c-data-document').value = item.data_document ? item.data_document.split('T')[0] : '';
            document.getElementById('c-fara-tva').value = item.val_fara_tva;
            document.getElementById('c-tva').value = item.val_tva;
            document.getElementById('c-valoare').value = item.valoare;
            document.getElementById('c-stare').value = item.stare;
            document.getElementById('c-pilon').value = item.pilon;
            document.getElementById('c-subcategorie').value = item.subcategorie;
            document.getElementById('c-an').value = item.an;
            document.getElementById('modal-contract').style.display = 'flex';
        }

        function deschideModalFactura(contractId, an) { 
            resetModale();
            document.getElementById('f-parent-id').value = contractId; 
            document.getElementById('f-an').value = an; 
            document.getElementById('modal-factura').style.display = 'flex'; 
        }

        function deschideEditareFactura(id) {
            resetModale();
            const item = rawData.find(r => r.id === id);
            document.getElementById('modal-factura-title').innerText = "EditeazƒÉ PlatƒÉ / FacturƒÉ";
            document.getElementById('f-id').value = item.id;
            document.getElementById('f-titlu').value = item.titlu;
            document.getElementById('f-numar').value = item.numar || '';
            document.getElementById('f-data-document').value = item.data_document ? item.data_document.split('T')[0] : '';
            document.getElementById('f-fara-tva').value = item.val_fara_tva;
            document.getElementById('f-tva').value = item.val_tva;
            document.getElementById('f-valoare').value = item.valoare;
            document.getElementById('f-an').value = item.an;
            document.getElementById('f-parent-id').value = item.parent_id;
            document.getElementById('modal-factura').style.display = 'flex';
        }

        function inchideModale() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        function resetModale() { 
            document.querySelectorAll('.modal input:not([type="hidden"])').forEach(i => i.value = '');
            document.querySelectorAll('.modal input[type="hidden"]').forEach(i => i.value = '');
        }

        async function salveazaContract() { 
            const id = document.getElementById('c-id').value;
            const subcat = document.getElementById('c-subcategorie').value;
            const oldItem = id ? rawData.find(r => r.id === id) : null;
            const pilonSafe = document.getElementById('c-pilon').value || (oldItem ? oldItem.pilon : pilonSelectat);
            const subcatSafe = document.getElementById('c-subcategorie').value || (oldItem ? oldItem.subcategorie : '');

            const date = { 
                parent_id: document.getElementById('c-parent-id').value || null, 
                tip_rand: 'CONTRACT', 
                pilon: pilonSafe, 
                subcategorie: subcatSafe, 
                an: document.getElementById('c-an').value, 
                titlu: document.getElementById('c-titlu').value, 
                numar: document.getElementById('c-numar').value,
                data_document: document.getElementById('c-data-document').value,
                valoare: parseFloat(document.getElementById('c-valoare').value), 
                val_fara_tva: parseFloat(document.getElementById('c-fara-tva').value) || 0, 
                val_tva: parseFloat(document.getElementById('c-tva').value) || 0, 
                stare: document.getElementById('c-stare').value 
            }; 

            if(id) await supabaseClient.from('buget_pnras').update(date).eq('id', id);
            else await supabaseClient.from('buget_pnras').insert([date]);

            inchideModale(); incarcaDatele(); 
        }

        async function salveazaFactura() { 
            const id = document.getElementById('f-id').value;
            const contractId = document.getElementById('f-parent-id').value; 
            const parent = rawData.find(r => r.id === contractId);
            const oldItem = id ? rawData.find(r => r.id === id) : null;
            const pilonSafe = parent ? parent.pilon : (oldItem ? oldItem.pilon : pilonSelectat);
            const subcatSafe = parent ? parent.subcategorie : (oldItem ? oldItem.subcategorie : '');

            const date = { 
                parent_id: contractId || null, 
                tip_rand: 'FACTURA', 
                pilon: pilonSafe, 
                subcategorie: subcatSafe, 
                an: document.getElementById('f-an').value, 
                titlu: document.getElementById('f-titlu').value, 
                numar: document.getElementById('f-numar').value,
                data_document: document.getElementById('f-data-document').value,
                valoare: parseFloat(document.getElementById('f-valoare').value), 
                val_fara_tva: parseFloat(document.getElementById('f-fara-tva').value) || 0, 
                val_tva: parseFloat(document.getElementById('f-tva').value) || 0, 
                stare: 'Platit' 
            }; 

            if(id) await supabaseClient.from('buget_pnras').update(date).eq('id', id);
            else await supabaseClient.from('buget_pnras').insert([date]);

            inchideModale(); incarcaDatele(); 
        }

        async function stergeContract(id) { if (!confirm("‚ö†Ô∏è »òtergi contractul »ôi facturile sale?")) return; await supabaseClient.from('buget_pnras').delete().eq('id', id); await supabaseClient.from('buget_pnras').delete().eq('parent_id', id); incarcaDatele(); }
        async function stergeFactura(id) { if (!confirm("»òtergi aceastƒÉ platƒÉ?")) return; await supabaseClient.from('buget_pnras').delete().eq('id', id); incarcaDatele(); }
    </script>
</body>
</html>