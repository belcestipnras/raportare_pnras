<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raport chestionare SASAT</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #1e3a8a; --accent: #db2777; --bg: #ffffff; }
        @page { size: A4; margin: 1.5cm; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f1f5f9; 
            margin: 0; 
            padding: 0; 
            color: #1e293b; 
            font-size: 9pt; 
        }
        
        .a4-page { 
            width: 210mm; 
            min-height: 297mm; 
            margin: 20px auto; 
            background: white; 
            padding: 1.5cm; 
            box-sizing: border-box; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
        }

        .antet-wrapper { width: 100%; margin-bottom: 10px; text-align: center; }
        .antet-img { width: 100%; height: auto; display: block; object-fit: contain; }
        
        .admin-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 800; border-bottom: 2px solid var(--primary); padding-bottom: 5px; font-size: 0.8rem; }
        
        .titlu-principal { text-align: center; margin-bottom: 25px; }
        .titlu-principal h1 { margin: 0; font-size: 1.2rem; font-weight: 900; color: var(--primary); text-transform: uppercase; outline: none; }

        .section-header { background: #f8fafc; padding: 8px 12px; border-left: 5px solid var(--primary); font-weight: 800; font-size: 0.85rem; margin: 20px 0 10px 0; color: var(--primary); text-transform: uppercase; }
        
        .class-section { margin-bottom: 30px; page-break-inside: avoid; }
        .class-title { background: var(--primary); color: white; padding: 6px 12px; font-weight: 800; font-size: 0.9rem; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; outline: none; }
        
        .data-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .data-table th { background: #f8fafc; color: #475569; font-size: 0.65rem; padding: 5px; border: 1px solid #e2e8f0; text-align: left; }
        .data-table td { padding: 4px 8px; border: 1px solid #e2e8f0; font-weight: 600; font-size: 0.8rem; outline: none; }
        .score-cell { font-family: 'Roboto Mono', monospace; text-align: center; width: 100px; }
        
        .sc-excelent { color: #15803d; background: #f0fdf4; }
        .sc-f-bine { color: #16a34a; }
        .sc-bine { color: #2563eb; }
        .sc-slab { color: #d97706; }
        .sc-f-slab { color: #dc2626; background: #fef2f2; }

        .ai-interpretare-box { 
            margin-top: 20px; 
            padding: 25px; 
             border: 1px solid var(--accent); 
            border-radius: 8px; 
            line-height: 1.6; 
            font-size: 9pt; 
            border-left: 10px solid var(--accent); 
            text-align: justify; 
            outline: none;
            page-break-inside: avoid;
        }
        
        .ai-paragraph {
            display: block;
            text-indent: 1.27cm;
            margin-bottom: 8pt;
        }

        .signature-area { margin-top: 40px; display: flex; justify-content: space-between; font-size: 0.85rem; page-break-inside: avoid; }
        .sig-box { width: 40%; outline: none; }
        .sig-line { margin-top: 30px; border-top: 1px solid #000; width: 170px; }

        .nav-bar { position: fixed; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 9999; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; color: white; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        @media print {
            body { background: white !important; }
            .a4-page { margin: 0; box-shadow: none; width: 100%; padding: 0; }
            .nav-bar { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<div class="nav-bar no-print">
    <button class="btn" style="background:#475569;" onclick="window.location.href='mate_sasat.html'"><i class="fa-solid fa-chevron-left"></i> ÎNAPOI</button>
    <button class="btn" style="background:var(--primary);" onclick="generateInterpretation()"><i class="fa-solid fa-file-signature"></i> GENEREAZĂ INTERPRETARE</button>
    <button class="btn" style="background:#0f172a;" onclick="window.print()"><i class="fa-solid fa-print"></i> PRINTARE</button>
</div>

<div class="a4-page">
    <div class="antet-wrapper"><img src="antet_pnras.jpeg" alt="Antet PNRAS" class="antet-img"></div>

    <div class="admin-header">
        <div id="nr-inreg-field" contenteditable="true">NR. ÎNREG: ........ / ................</div>
        <div id="data-doc" contenteditable="true">DATA: --.--.----</div>
    </div>

    <div class="titlu-principal">
        <h1 contenteditable="true">Raport chestionare SASAT</h1>
    </div>

    <div class="section-header">I. Rezultate consolidate la nivelul unității de învățământ</div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Item analizat</th>
                <th class="score-cell">Medie Școală</th>
                <th class="score-cell">Interpretare</th>
            </tr>
        </thead>
        <tbody id="school-summary-body"></tbody>
    </table>

    <div class="section-header">II. Analiză detaliată pe clase</div>
    <div id="classes-container"></div>

    <div class="section-header">III. Analiză și concluzii</div>
    <div class="ai-interpretare-box" id="interpretare-text" contenteditable="true">
        <span style="color: #64748b; font-style: italic;">Utilizați butonul lateral pentru a genera textul analizei bazat pe datele de mai sus.</span>
    </div>

    <div class="signature-area">
        <div class="sig-box">
            <strong contenteditable="true">Întocmit,</strong><br>
            <span contenteditable="true">Manager proiect,</span><br>
            <span contenteditable="true">prof. dr. Ciprian MIHAI</span>
            <div class="sig-line"></div>
        </div>
        <div class="sig-box" style="text-align: right;">
            <div style="display: inline-block; text-align: left;">
                <strong contenteditable="true">Aprobat,</strong><br>
                <span contenteditable="true">Director,</span><br>
                <span contenteditable="true">prof. Cătălin BAZILUC</span>
                <div class="sig-line"></div>
            </div>
        </div>
    </div>
</div>

<script>
const supabaseUrl = 'https://aexjrbdgajurxzngfkpx.supabase.co';
const supabaseKey = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
const _db = supabase.createClient(supabaseUrl, supabaseKey);
const TABLE_NAME = 'mate_pnras';
const EDGE_URL = 'https://aexjrbdgajurxzngfkpx.supabase.co/functions/v1/chatgpt-pnras';
const RAPORT_ID = 'raport_sasat_general';

const ITEMS = [
    {id:"a11", t:"Încredere în comunicarea cu părinții"},
    {id:"a13", t:"Părinții ascultă preocupările elevului"},
    {id:"a26", t:"Importanța educației în viziunea familiei"},
    {id:"b12", t:"Sentimentul de apartenență la școală"},
    {id:"b41", t:"Încrederea în cadrele didactice"},
    {id:"b53", t:"Ordinea și liniștea în timpul orelor"},
    {id:"b61", t:"Incidența jignirilor sau poreclirii"},
    {id:"b64", t:"Incidența violenței fizice"},
    {id:"c1", t:"Aspirații privind nivelul de studii"}
];

let globalStatsText = "";

function getInterpretation(avg) {
    if (avg >= 4.5) return { label: "Excelent", cls: "sc-excelent" };
    if (avg >= 3.8) return { label: "Foarte Bine", cls: "sc-f-bine" };
    if (avg >= 2.8) return { label: "Bine", cls: "sc-bine" };
    if (avg >= 1.8) return { label: "Slab", cls: "sc-slab" };
    return { label: "Foarte Slab", cls: "sc-f-slab" };
}

async function init() {
    document.getElementById('data-doc').innerText = `DATA: ${new Date().toLocaleDateString('ro-RO')}`;

    const { data, error } = await _db.from(TABLE_NAME).select('*').not('a11', 'is', null);
    if (error || !data) return;

    const schoolTbody = document.getElementById('school-summary-body');
    ITEMS.forEach(it => {
        const vals = data.map(e => e[it.id]).filter(v => v);
        const avg = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2) : "0.00";
        const inter = getInterpretation(avg);
        schoolTbody.innerHTML += `<tr><td contenteditable="true">${it.t}</td><td class="score-cell ${inter.cls}">${avg}</td><td class="score-cell ${inter.cls}">${inter.label}</td></tr>`;
    });

    const clase = [...new Set(data.map(d => d.clasa))].sort();
    const container = document.getElementById('classes-container');
    let rawLog = "";

    clase.forEach(cls => {
        const elCls = data.filter(d => d.clasa === cls);
        rawLog += `Clasa ${cls} (${elCls.length} elevi): `;
        let html = `<div class="class-section"><div class="class-title"><span contenteditable="true">Clasa ${cls}</span><span contenteditable="true">Efectiv: ${elCls.length}</span></div><table class="data-table"><thead><tr><th>Item analizat</th><th class="score-cell">Medie</th><th class="score-cell">Interpretare</th></tr></thead><tbody>`;
        
        ITEMS.forEach(it => {
            const v = elCls.map(e => e[it.id]).filter(x => x);
            const m = v.length ? (v.reduce((a,b)=>a+b,0)/v.length).toFixed(2) : "0.00";
            const inter = getInterpretation(m);
            html += `<tr><td contenteditable="true">${it.t}</td><td class="score-cell ${inter.cls}">${m}</td><td class="score-cell ${inter.cls}">${inter.label}</td></tr>`;
            rawLog += `${it.t}=${m}; `;
        });
        container.innerHTML += html + `</tbody></table></div>`;
        rawLog += " | ";
    });
    globalStatsText = rawLog;

    // Încărcare date salvate din Supabase
    await loadFromSupabase();

    // Salvare automată la editare manuală
    let timeout = null;
    document.querySelector('.a4-page').addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(saveToSupabase, 2000);
    });
}

async function saveToSupabase() {
    const nr = document.getElementById('nr-inreg-field').innerText;
    const analiza = document.getElementById('interpretare-text').innerHTML;
    await _db.from('rapoarte_salvate').upsert({ 
        id: RAPORT_ID, 
        nr_inreg: nr, 
        continut_analiza: analiza,
        updated_at: new Date() 
    });
}

async function loadFromSupabase() {
    const { data } = await _db.from('rapoarte_salvate').select('*').eq('id', RAPORT_ID).maybeSingle();
    if (data) {
        if (data.nr_inreg) document.getElementById('nr-inreg-field').innerText = data.nr_inreg;
        if (data.continut_analiza && data.continut_analiza.length > 20) {
            const out = document.getElementById('interpretare-text');
            out.innerHTML = data.continut_analiza;
            out.style.fontStyle = "normal";
        }
    }
}

async function generateInterpretation() {
    const out = document.getElementById('interpretare-text');
    out.innerHTML = '<span class="ai-paragraph">Se redactează analiza detaliată...</span>';
    
    try {
        const response = await fetch(EDGE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${supabaseKey}` },
            body: JSON.stringify({ 
                prompt: `Analizează mediile chestionarelor SASAT: ${globalStatsText}. 
                         Generează un text amplu, structurat obligatoriu după următoarea schemă, dar fără a scrie titluri de secțiuni sau liste cu puncte:
                         1. Introducere privind contextul evaluării.
                         2. Analiza generală la nivelul unității de învățământ (interpretarea tabelului consolidat).
                         3. Analiza pe clase (evidențierea diferențelor dintre colective).
                         4. Concluzii privind starea de bine și climatul școlar.
                         5. Recomandări concrete pentru ameliorarea indicatorilor.

                         Reguli stricte:
                         - Folosește exclusiv scara: foarte slab, slab, bine, foarte bine, excelent.
                         - Formatează textul doar ca paragrafe separate (fără bold, fără cifre, fără liniuțe).
                         - Nu menționa "AI", "ChatGPT" sau procese tehnice.
                         - Raportează-te strict la datele de față.`
            })
        });

        const r = await response.json();
        const text = r.reply || r.content || (r.choices && r.choices[0].message.content);
        
        const formattedText = text.split('\n').filter(p => p.trim() !== '')
            .map(p => `<span class="ai-paragraph">${p.trim()}</span>`)
            .join('');
        
        out.innerHTML = formattedText;
        await saveToSupabase(); // Salvăm analiza imediat ce a fost generată
    } catch (e) {
        out.innerHTML = "Eroare la generarea textului.";
    }
}

init();
</script>
</body>
</html>