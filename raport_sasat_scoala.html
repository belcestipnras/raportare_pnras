<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raport Strategic SASAT Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { 
            --primary: #1e3a8a; --accent: #3b82f6; --bg-soft: #f8fafc;
            --optim: #10b981; --bun: #34d399; --mediu: #f59e0b; --scazut: #f97316; --f-scazut: #ef4444;
        }
        @page { size: A4; margin: 1cm; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; padding: 0; color: #0f172a; font-size: 8.5pt; line-height: 1.5; }
        .a4-page { width: 210mm; min-height: 297mm; margin: 20px auto; background: white; padding: 1.2cm; box-sizing: border-box; box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; }

        @media print { 
            .no-print { display: none !important; } 
            body { background: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } 
            .a4-page { margin: 0; box-shadow: none; width: 100%; padding: 1cm; }
            .card, .main-header, .prog-fill, .badge, .lvl-tag { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        .antet-full { width: 100%; margin-bottom: 5px; }
        .antet-img { width: 100%; height: auto; display: block; }
        .nr-inreg-row { margin: 10px 0; font-weight: 700; font-size: 8.5pt; color: #000; }
        .edit-line { padding: 0 5px; min-width: 150px; display: inline-block; cursor: text; border: none !important; }

        .header-center { text-align: center; margin: 20px 0 30px 0; }
        .header-center h1 { margin: 0; font-size: 1.1rem; color: #000; text-transform: uppercase; font-weight: 800; }
        .header-center h2 { margin: 5px 0; font-size: 0.85rem; color: #000; font-weight: 800; text-transform: uppercase; }
        .header-center h3 { margin: 0; font-size: 0.8rem; color: #334155; font-weight: 500; }

        .period-selector { background: white; padding: 15px; border-radius: 12px; margin: 20px auto; width: 210mm; text-align: center; border: 1px solid #e2e8f0; }
        .p-btn { padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; background: white; font-weight: 600; margin: 0 4px; transition: 0.2s; }
        .p-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .section-wrap { margin-top: 40px; }
        .main-header { 
            background: linear-gradient(90deg, var(--primary), var(--accent)); 
            color: white; padding: 12px 20px; font-weight: 800; font-size: 10pt; 
            text-transform: uppercase; border-radius: 8px; display: flex; align-items: center; gap: 12px;
            margin-bottom: 20px;
        }
        
        .sub-header { 
            background: #eff6ff; color: var(--primary); padding: 8px 15px; 
            font-weight: 800; font-size: 8.5pt; text-transform: uppercase;
            border-left: 6px solid var(--primary); margin: 25px 0 15px 0;
        }

        .cards-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .card { background: var(--bg-soft); border-radius: 10px; padding: 12px 15px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-weight: 700; color: #1e293b; font-size: 8.5pt; margin-bottom: 2px; }
        .card-subtitle { font-size: 6.5pt; text-transform: uppercase; color: #64748b; font-weight: 600; }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 7pt; font-weight: 800; text-transform: uppercase; width: 95px; text-align: center; color: white !important; }
        .prog-container { display: flex; align-items: center; gap: 12px; }
        .prog-bar { width: 120px; height: 8px; background: #e2e8f0; border-radius: 10px; overflow: hidden; border: 0.5pt solid #cbd5e1; }
        .prog-fill { height: 100%; border-radius: 10px; transition: width 1s ease; }
        .score-val { font-family: 'Roboto Mono', monospace; font-weight: 800; width: 45px; text-align: right; font-size: 10pt; color: var(--primary); }

        /* Analiza Narativă */
        .ai-output-box { margin-top: 15px; padding: 0; border: none; }
        .ai-paragraph { display: block; text-indent: 1.27cm; margin-bottom: 18px; text-align: justify; font-size: 9.5pt; color: #1e293b; line-height: 1.8; }

        /* Grupare semnatura cu ultimul paragraf */
        .keep-together { page-break-inside: avoid; display: block; margin-top: 0; }
        .signature-row { margin-top: 40px; text-align: center; font-size: 10pt; font-weight: 600; }

        .appendix { margin-top: 50px; border-top: 2.5px solid #000; padding-top: 20px; page-break-inside: avoid; }
        .meth-section-title { font-weight: 800; text-transform: uppercase; font-size: 9.5pt; margin-bottom: 20px; color: #000; border-bottom: 1px solid #000; padding-bottom: 5px; display: inline-block; }
        .meth-indicator-title { font-weight: 800; font-size: 8.5pt; margin: 15px 0 5px 0; color: var(--primary); text-transform: uppercase; }
        .legend-table { width: 100%; border-collapse: collapse; font-size: 7.2pt; margin-bottom: 20px; }
        .legend-table td { padding: 7px 10px; border: 0.5pt solid #000; color: #000; vertical-align: top; }
        .lvl-tag { font-weight: 800; width: 110px; text-align: center; color: white !important; text-transform: uppercase; font-size: 6pt; }

        .nav-bar { position: fixed; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 9999; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="nav-bar no-print">
    <button class="btn" style="background:#64748b;" onclick="window.location.href='mate_sasat.html'"><i class="fa-solid fa-arrow-left"></i> ÎNAPOI</button>
    <button class="btn" style="background:var(--primary);" onclick="generateInterpretation()"><i class="fa-solid fa-wand-magic-sparkles"></i> GENEREAZĂ ANALIZĂ</button>
    <button class="btn" style="background:#000;" onclick="window.print()"><i class="fa-solid fa-print"></i> PRINTARE</button>
</div>

<div class="period-selector no-print">
    <div class="btn-group">
        <button class="p-btn" onclick="initRaport('IANUARIE 2025', 2025, this)">IANUARIE 2025</button>
        <button class="p-btn" onclick="initRaport('SEPTEMBRIE 2025', 2025, this)">SEPTEMBRIE 2025</button>
        <button class="p-btn" onclick="initRaport('MARTIE 2026', 2026, this)">MARTIE 2026</button>
    </div>
</div>

<div class="a4-page">
    <div class="antet-full"><img src="antet_pnras.jpeg" class="antet-img"></div>
    <div class="nr-inreg-row">NR. ÎNREG: <span class="edit-line" id="nr-inreg-field" contenteditable="true">........ / ................</span></div>

    <div class="header-center">
        <h1>Raport SASAT - <span id="display-period">Nesetat</span></h1>
        <h2>Categoria I: Activități de identificarea și monitorizare a elevilor în risc de abandon școlar - MATE</h2>
        <h3>A I.1. Aplicarea chestionarului SASAT, de evaluare a succesului școlar, în rândul elevilor de gimnaziu</h3>
    </div>

    <div class="section-wrap">
        <div class="main-header"><i class="fa-solid fa-chart-line"></i> Secțiunea I: Analiza Consolidată la Nivel de Unitate</div>
        <div class="cards-grid" id="school-summary-body"></div>
    </div>

    <div class="section-wrap">
        <div class="main-header"><i class="fa-solid fa-users-viewfinder"></i> Secțiunea II: Diagnoză Comparativă pe Clase</div>
        <div id="classes-container"></div>
    </div>

    <div class="section-wrap">
        <div class="main-header"><i class="fa-solid fa-file-signature"></i> Secțiunea III: Analiză și concluzii</div>
        <div class="ai-output-box" id="interpretare-text" contenteditable="true">
            <span style="color: #64748b; font-style: italic;">Așteptare procesare date...</span>
        </div>
    </div>

    <div class="appendix">
        <div class="meth-section-title">Anexă: Metodologie de Evaluare și Interpretare SASAT</div>
        <div class="meth-indicator-title">A1 – Sprijin parental social și emoțional</div>
        <table class="legend-table"><tr><td class="lvl-tag" style="background:var(--f-scazut)">Foarte scăzut</td><td>Lipsă susținere emoțională; comunicare aproape inexistentă.</td></tr><tr><td class="lvl-tag" style="background:var(--scazut)">Scăzut</td><td>Sprijin emoțional ocazional; părinții intervin rar.</td></tr><tr><td class="lvl-tag" style="background:var(--mediu)">Mediu</td><td>Sprijin emoțional în anumite situații, dar neconstant.</td></tr><tr><td class="lvl-tag" style="background:var(--bun)">Bun</td><td>Sprijin emoțional constant; elevii se simt susținuți.</td></tr><tr><td class="lvl-tag" style="background:var(--optim)">Optim</td><td>Relație solidă părinte–copil; comunicare deschisă.</td></tr></table>
        
        <div class="meth-indicator-title">A2 – Sprijin parental pentru educație</div>
        <table class="legend-table"><tr><td class="lvl-tag" style="background:var(--f-scazut)">Foarte scăzut</td><td>Părinții nu se implică în activitatea școlară.</td></tr><tr><td class="lvl-tag" style="background:var(--scazut)">Scăzut</td><td>Implicare redusă, punctuală.</td></tr><tr><td class="lvl-tag" style="background:var(--mediu)">Mediu</td><td>Urmărirea rezultatelor școlare, fără implicare activă.</td></tr><tr><td class="lvl-tag" style="background:var(--bun)">Bun</td><td>Implicare constantă și comunicare cu școala.</td></tr><tr><td class="lvl-tag" style="background:var(--optim)">Optim</td><td>Implicare activă și permanentă.</td></tr></table>
        
        <div class="meth-indicator-title">B4 – Sprijin social oferit de profesori</div>
        <table class="legend-table"><tr><td class="lvl-tag" style="background:var(--f-scazut)">Foarte scăzut</td><td>Elevii nu se simt sprijiniți de profesori.</td></tr><tr><td class="lvl-tag" style="background:var(--scazut)">Scăzut</td><td>Sprijin limitat, relație distantă.</td></tr><tr><td class="lvl-tag" style="background:var(--mediu)">Mediu</td><td>Sprijin academic, mai puțin emoțional.</td></tr><tr><td class="lvl-tag" style="background:var(--bun)">Bun</td><td>Relație pozitivă profesor–elev.</td></tr><tr><td class="lvl-tag" style="background:var(--optim)">Optim</td><td>Climat de încredere și sprijin constant.</td></tr></table>

        <div class="meth-indicator-title">B5 – Mediul de învățare (Zgomot)</div>
        <table class="legend-table"><tr><td class="lvl-tag" style="background:var(--f-scazut)">Scăzut</td><td>Zgomot ridicat, afectează constant învățarea.</td></tr><tr><td class="lvl-tag" style="background:var(--scazut)">Mediu</td><td>Zgomot frecvent, concentrare redusă.</td></tr><tr><td class="lvl-tag" style="background:var(--mediu)">Bun</td><td>Zgomot ocazional, parțial controlat.</td></tr><tr><td class="lvl-tag" style="background:var(--bun)">Optim</td><td>Mediu liniștit și organizat; nivel redus de zgomot.</td></tr></table>

        <div class="meth-indicator-title">B6 – Violența între elevi (Bullying)</div>
        <table class="legend-table"><tr><td class="lvl-tag" style="background:var(--scazut)">Scăzut</td><td>Situații de bullying gestionate insuficient.</td></tr><tr><td class="lvl-tag" style="background:var(--mediu)">Mediu</td><td>Cazuri izolate, intervenții reactive.</td></tr><tr><td class="lvl-tag" style="background:var(--bun)">Bun</td><td>Rar întâlnit, reguli clare respectate.</td></tr><tr><td class="lvl-tag" style="background:var(--optim)">Optim</td><td>Mediu sigur, prevenție activă și armonie.</td></tr></table>
    </div>
</div>

<script>
const supabaseUrl = 'https://aexjrbdgajurxzngfkpx.supabase.co';
const supabaseKey = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
const _db = supabase.createClient(supabaseUrl, supabaseKey);

const METRICS_MAP = [
    { id: "A1", t: "(A1) Sprijin parental social și emoțional", items: ["a11","a12","a13","a14","a15"], limit: 15, mode: "OPTIMAL", label: "Optim" },
    { id: "A2", t: "(A2) Sprijin parental pentru educație", items: ["a21","a22","a23","a24","a25","a26"], limit: 18, mode: "OPTIMAL", label: "Optim" },
    { id: "B4", t: "(B4) Sprijin social oferit de profesori", items: ["b41","b42","b43","b44","b45"], limit: 15, mode: "OPTIMAL", label: "Optim" },
    { id: "B5", t: "(B5) Mediul de învățare (Zgomot)", items: ["b51","b52","b53"], limit: 11, mode: "RISK", label: "Risc" },
    { id: "B6", t: "(B6) Violența între elevi (Bullying)", items: ["b61","b62","b63","b64"], limit: 15, mode: "RISK", label: "Risc" }
];

let currentPeriod = ""; let dateleCurente = []; let timeoutSalvare = null;

function getLvl(perc, mode) {
    const p = parseFloat(perc);
    if (mode === "OPTIMAL") {
        if (p >= 85) return { l: "Optim", c: "var(--optim)" };
        if (p >= 70) return { l: "Bun", c: "var(--bun)" };
        if (p >= 50) return { l: "Mediu", c: "var(--mediu)" };
        if (p >= 30) return { l: "Scăzut", c: "var(--scazut)" };
        return { l: "Foarte scăzut", c: "var(--f-scazut)" };
    } else {
        if (p < 20) return { l: "Optim", c: "var(--optim)" };
        if (p < 40) return { l: "Bun", c: "var(--bun)" };
        if (p < 60) return { l: "Mediu", c: "var(--mediu)" };
        return { l: "Scăzut", c: "var(--scazut)" };
    }
}

async function initRaport(period, year, btn) {
    document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentPeriod = period;
    document.getElementById('display-period').innerText = period;
    let targetYear = (period === 'SEPTEMBRIE 2025') ? 2026 : year;
    const { data } = await _db.from('mate_pnras').select('*').eq('anul', targetYear).not('a11', 'is', null);
    dateleCurente = data || [];
    renderSummary(dateleCurente, "school-summary-body");
    renderClasses(dateleCurente);
    await incarcaRaportSalvat();
}

function renderSummary(data, targetId) {
    const container = document.getElementById(targetId);
    container.innerHTML = "";
    if(!data.length) return;
    METRICS_MAP.forEach(m => {
        let cnt = 0; data.forEach(e => {
            let s = 0; m.items.forEach(it => s += (e[it]||0));
            if (m.mode === "OPTIMAL" ? s >= m.limit : s > m.limit) cnt++;
        });
        let p = ((cnt / data.length) * 100).toFixed(1);
        let st = getLvl(p, m.mode);
        container.innerHTML += `
            <div class="card">
                <div class="card-info"><div class="card-subtitle">Pondere ${m.label}</div><div class="card-title">${m.t}</div></div>
                <div class="prog-container"><span class="score-val">${p}%</span><div class="prog-bar"><div class="prog-fill" style="width:${p}%; background:${st.c}"></div></div><span class="badge" style="background:${st.c}">${st.l}</span></div>
            </div>`;
    });
}

function renderClasses(data) {
    const container = document.getElementById('classes-container');
    container.innerHTML = "";
    const clase = [...new Set(data.map(d => d.clasa))].sort();
    clase.forEach(c => {
        const cD = data.filter(d => d.clasa === c);
        const sid = `class-grid-${c}`;
        container.innerHTML += `<div class="sub-header">Situație Clasa ${c} (Efectiv: ${cD.length})</div><div class="cards-grid" id="${sid}"></div>`;
        renderSummary(cD, sid);
    });
}

async function salveazaInSupabase() {
    if (!currentPeriod) return;
    const analiza = document.getElementById('interpretare-text').innerHTML;
    const nrInreg = document.getElementById('nr-inreg-field').innerText;
    const reportId = `sasat_v4_${currentPeriod.replace(/ /g, '_')}`;
    await _db.from('rapoarte_salvate').upsert({ id: reportId, continut_analiza: analiza, nr_inreg: nrInreg, updated_at: new Date() });
}

function organizeAnalysisAndSignature() {
    const box = document.getElementById('interpretare-text');
    const existingGroup = box.querySelector('.keep-together');
    if(existingGroup) return; // Prevenim dublarea semnăturii

    const paragraphs = box.querySelectorAll('.ai-paragraph');
    if (paragraphs.length > 0) {
        const lastP = paragraphs[paragraphs.length - 1];
        const wrapper = document.createElement('div');
        wrapper.className = 'keep-together';
        lastP.parentNode.insertBefore(wrapper, lastP);
        wrapper.appendChild(lastP);
        wrapper.innerHTML += `<div class="signature-row"><strong>Întocmit,</strong><br>Manager proiect PNRAS, prof. dr. Ciprian MIHAI</div>`;
    }
}

async function incarcaRaportSalvat() {
    const reportId = `sasat_v4_${currentPeriod.replace(/ /g, '_')}`;
    const { data } = await _db.from('rapoarte_salvate').select('*').eq('id', reportId).maybeSingle();
    const out = document.getElementById('interpretare-text');
    const nr = document.getElementById('nr-inreg-field');
    if (data) {
        out.innerHTML = data.continut_analiza;
        if(data.nr_inreg) nr.innerText = data.nr_inreg;
        // Nu chemam organizeAnalysisAndSignature aici daca datele vin deja cu ea din DB
        if(!out.querySelector('.signature-row')) organizeAnalysisAndSignature();
    } else {
        out.innerHTML = '<span style="color:#64748b;">Apăsați butonul pentru analiza AI.</span>';
    }
}

async function generateInterpretation() {
    if (!dateleCurente.length) return;
    const out = document.getElementById('interpretare-text');
    out.innerHTML = '<span>Generare analiză narativă...</span>';
    try {
        const response = await fetch('https://aexjrbdgajurxzngfkpx.supabase.co/functions/v1/chatgpt-pnras', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${supabaseKey}` },
            body: JSON.stringify({ 
                prompt: `Ești expert în diagnoză educațională SASAT. Analizează rezultatele (${currentPeriod}). Identifică tendințele și corelațiile statistice globale și pe clase. REGULI: Generează paragrafe narative lungi, inteligente, academice. STRICT INTERZIS: Liste, liniuțe, titluri.` 
            })
        });
        const r = await response.json();
        out.innerHTML = r.reply.split('\n').filter(p => p.trim() !== '').map(p => `<span class="ai-paragraph">${p.trim()}</span>`).join('');
        organizeAnalysisAndSignature();
        await salveazaInSupabase();
    } catch (e) { out.innerHTML = "Eroare la generare."; }
}

document.addEventListener('input', (e) => {
    if (e.target.id === 'interpretare-text' || e.target.id === 'nr-inreg-field') {
        clearTimeout(timeoutSalvare);
        timeoutSalvare = setTimeout(salveazaInSupabase, 2000);
    }
});
</script>
</body>
</html>