<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListƒÉ MasƒÉ CaldƒÉ PNRAS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e40af; --accent: #10b981; --text: #1f2937; --warning: #f59e0b; }
        @page { size: A4; margin: 1cm; }
        body { background: #f3f4f6; font-family: 'Inter', sans-serif; color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .page { background: white; width: 210mm; min-height: 297mm; padding: 10mm 15mm; box-sizing: border-box; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-radius: 8px; margin-bottom: 30px; page-break-after: always; position: relative; }
        .antet-img { width: 100%; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        h2 { font-family: 'Montserrat', sans-serif; color: black; text-align: center; text-transform: uppercase; margin: 10px 0; font-size: 17px; line-height: 1.3; }
        .grid-info { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 10px 40px; margin-bottom: 20px; background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; border-left: 5px solid var(--primary); }
        .info-item { font-size: 12px; }
        .info-label { font-weight: 700; color: #4b5563; text-transform: uppercase; font-size: 10px; display: block; }
        .info-value { font-size: 14px; color: var(--text); font-weight: 600; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-family: 'Roboto Mono', monospace; }
        th { background: #f8fafc; color: black; font-weight: 700; text-transform: uppercase; font-size: 11px; padding: 10px 5px; border: 1px solid black; text-align: center; }
        td { border: 1px solid black; padding: 8px 5px; font-size: 13px; color: black; text-align: center; vertical-align: middle; }
        .signature-area { margin-top: 50px; text-align: center; width: 100%; font-size: 14px; }
        .no-print { margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; position: sticky; top: 10px; z-index: 1000; background: #f3f4f6eb; padding: 10px; border-radius: 10px; }
        .main-btn { padding: 12px 20px; cursor: pointer; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-back-bold { background: #000; color: #fff; border: 2px solid #fff; font-size: 16px; padding: 12px 25px; }
        .btn-back-bold span { color: #10b981; font-weight: 900; }
        .btn-success { background: #059669; }
        .btn-danger { background: #dc2626; }
        
        .day-lock-bar { background: #fffbeb; border: 2px solid var(--warning); padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn-lock-day { background: var(--warning); color: #000; font-weight: 800; border: 1px solid #b45309; }
        .btn-unlock-day { background: #ef4444; color: #fff; }

        .msg-special { padding: 30px; border: 2px dashed #dc2626; color: #b91c1c; font-weight: bold; text-align: center; background: #fef2f2; margin-top: 20px; border-radius: 10px; line-height: 1.5; }
        input.edit-name { border: none !important; outline: none !important; width: 100%; font-family: inherit; font-size: inherit; background: transparent; text-align: center; font-weight: 600; }
        
        /* Stil special pentru izolarea paginii la printare individualƒÉ */
        .hide-for-print { display: none !important; }

        @media print { .no-print, #status-msg, .day-lock-bar { display: none !important; } body { padding: 0; background: none; } .page { box-shadow: none; border-radius: 0; padding: 5mm; width: 100%; margin: 0; } }
    </style>
</head>
<body>
    <div id="status-msg" style="padding: 10px; background: #dcfce7; border-radius: 5px; margin-bottom: 10px;">‚åõ Se genereazƒÉ listele de masƒÉ...</div>
    <div class="no-print">
        <button id="btn-back" class="main-btn btn-back-bold"><span>‚¨Ö</span> √éNAPOI</button>
        <button class="main-btn btn-success" onclick="addRow()">‚ûï ADAUGƒÇ R√ÇND</button>
        <button class="main-btn btn-danger" onclick="removeLastRow()">‚ûñ »òTERGE R√ÇND</button>
    </div>
    <div id="master-container"></div>
    <template id="page-template">
        <div class="page">
            <img src="antet_pnras.jpeg" class="antet-img">
            <h2>LISTƒÇ DE PRIMIRE A PACHETULUI ALIMENTAR DE TIP MASƒÇ CALDƒÇ</h2>
            <div class="grid-info">
                <div class="info-item" style="grid-column: span 2;"><span class="info-label">Activitate:</span><span class="out-activitate info-value"></span></div>
                <div class="info-item"><span class="info-label">Disciplina:</span><span class="out-disciplina info-value"></span></div>
                <div class="info-item"><span class="info-label">Expert:</span><span class="out-expert info-value"></span></div>
                <div class="info-item"><span class="info-label">Data:</span><span class="out-data info-value"></span></div>
                <div class="info-item"><span class="info-label">Clasa / Grupa:</span><span class="out-clasa info-value"></span></div>
            </div>
            <div class="day-lock-bar no-print">
                <span class="lock-status-text">‚ÑπÔ∏è AceastƒÉ zi este liberƒÉ pentru distribuire.</span>
                <div class="lock-actions">
                    <button class="main-btn btn-lock-day" onclick="printeazaSiBlocheazaZiua(this)">üîí PRINTEAZƒÇ »òI BLOCHEAZƒÇ ZIUA</button>
                    <button class="main-btn btn-unlock-day" onclick="deblocheazaZiua(this)" style="display:none;">üîì DEBLOCHEAZƒÇ</button>
                </div>
            </div>
            <div class="container-tabel">
                <table>
                    <thead><tr><th width="5%">Nr.</th><th width="55%">Nume elev</th><th width="10%">Da</th><th width="10%">Nu</th><th width="20%">SemnƒÉtura</th></tr></thead>
                    <tbody class="tabel-body"></tbody>
                </table>
            </div>
            <div class="msg-special" style="display: none;"></div>
            <div class="signature-area"><p style="margin-bottom: 50px;">√éntocmit,</p><p>Expert: <span class="sig-expert" style="font-weight: bold; text-decoration: underline;"></span></p></div>
        </div>
    </template>

<script>
    const URL_S = 'https://aexjrbdgajurxzngfkpx.supabase.co';
    const KEY_S = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
    const _supabase = supabase.createClient(URL_S, KEY_S);

    const MAP_CLASE = { '5A': 'Clasa a V-a A', '5B': 'Clasa a V-a B', '5C': 'Clasa a V-a C', '6A': 'Clasa a VI-a A', '6B': 'Clasa a VI-a B', '6C': 'Clasa a VI-a C', '7A': 'Clasa a VII-a A', '7B': 'Clasa a VII-a B', '7C': 'Clasa a VII-a C', '8A': 'Clasa a VIII-a A', '8B': 'Clasa a VIII-a B', '8C': 'Clasa a VIII-a C', 'SG1': 'Grupa 1, Sport', 'SG2': 'Grupa 2, Sport', 'PG1': 'Grupa 1, PicturƒÉ', 'PG2': 'Grupa 2, PicturƒÉ', 'MG1': 'Grupa 1, MuzicƒÉ', 'MG2': 'Grupa 2, MuzicƒÉ', 'DG1': 'Grupa 1, Dansuri', 'StG1': 'Grupa 1, »òtiin»õe', 'StG2': 'Grupa 1, »òtiin»õe', 'SG1A': 'Grupa 1A, Sport', 'SG1B': 'Grupa 1B, Sport', 'PG1A': 'Grupa 1A, PicturƒÉ', 'PG1B': 'Grupa 1B, PicturƒÉ', 'StG1A': 'Grupa 1A, »òtiin»õe', 'StG1B': 'Grupa 1B, »òtiin»õe', 'AV5A': 'Clasa a V-a A', 'AV5B': 'Clasa a V-a B', 'AV6A': 'Clasa a VI-a A', 'AV6B': 'Clasa a VI-a B', 'AV7A': 'Clasa a VII-a A', 'AV7B': 'Clasa a VII-a B', 'AV8A1': 'Clasa a VIII-a A, Grupa 1', 'AV8A2': 'Clasa a VIII-a A, Grupa 2', 'AV8B1': 'Clasa a VIII-a B, Grupa 1', 'AV8B2': 'Clasa a VIII-a B, Grupa 2', 'AR5AB': 'Clasele a V-a A, B', 'AR5A': 'Clasa a V-a A', 'AR5B': 'Clasa a V-a B', 'AR6A': 'Clasa a VI-a A', 'AR6B': 'Clasa a VI-a B', 'AR7B': 'Clasa a VII-a B', 'BA6B': 'Clasa a VI-a B', 'BA7A': 'Clasa a VII-a A', 'BA8A1': 'Clasa a VIII-a A, Grupa 1', 'BA8A2': 'Clasa a VIII-a A, Grupa 2', 'BA8B': 'Clasa a VIII-a B', 'AD8B1': 'Clasa a VIII-a B, Grupa 1', 'AD8B2': 'Clasa a VIII-a B, Grupa 2', 'AD8B3': 'Clasa a VIII-a B, Grupa 3', 'PE8A1': 'Clasa a VIII-a A, Grupa 1', 'PE8A2': 'Clasa a VIII-a A, Grupa 2', 'PE6B': 'Clasa a VI-a B', 'PE7A': 'Clasa a VII-a A', 'IA5AB1': 'Clasele a V-a A, B', 'IA5AB2': 'Clasele a V-a A, B', 'IA6A': 'Clasa a VI-a A', 'IA7B': 'Clasa a VII-a B' };
    const MAP_ACTIVITATI = { 'A II.4.': ['Anghelu»ô Raluca', 'Baziluc Ana Maria', 'Gheme»ô Anca', 'ArotƒÉri»õei DƒÉnu»õ', 'Boldan Ovidiu', 'Popovici Estera', 'Iftene Ana Maria'], 'A II.5.': ['Albu »òtefan', 'Marele Daniela', 'TanasƒÉ Liliana', 'Popa Gabriela', 'Nohai Iuliana', 'Nohai Vili'], 'A II.6.': ['AparascƒÉi Vasile'] };
    const DESC_ACTIVITATI = { 'A II.4.': 'A II. 4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin', 'A II.5.': 'A II.5. ActivitƒÉ»õi extracurriculare »ôi/sau extra»ôcolare', 'A II.6.': 'A II.6. ActivitƒÉ»õi pentru dezvoltarea litera»õiei. Club de lecturƒÉ' };
    const MAP_DISCIPLINE = { 'Anghelu»ô Raluca': 'ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ', 'Baziluc Ana Maria': 'ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ', 'Gheme»ô Anca': 'ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ', 'ArotƒÉri»õei DƒÉnu»õ': 'ActivitƒÉ»õi remediale la matematicƒÉ', 'Boldan Ovidiu': 'ActivitƒÉ»õi remediale la matematicƒÉ', 'Popovici Estera': 'ActivitƒÉ»õi remediale la matematicƒÉ', 'Albu »òtefan': 'ActivitƒÉ»õi extracurriculare la Clubul de activitƒÉ»õi sportive »ôi outdoor', 'Marele Daniela': 'ActivitƒÉ»õi extracurriculare la Clubul de picturƒÉ', 'TanasƒÉ Liliana': 'ActivitƒÉ»õi extracurriculare la Clubul de muzicƒÉ', 'Popa Gabriela': 'ActivitƒÉ»õi extracurriculare la Clubul de dansuri', 'Nohai Iuliana': 'ActivitƒÉ»õi extracurriculare la Clubul de »ôtiin»õe', 'Nohai Vili': 'ActivitƒÉ»õi extracurriculare la Clubul de »ôtiin»õe', 'AparascƒÉi Vasile': 'ActivitƒÉ»õi extracurriculare la Clubul de lecturƒÉ »ôi litera»õie', 'Iftene Ana Maria': 'ActivitƒÉ»õi remediale la matematicƒÉ' };

    let globalConfig = {};

    function toggleCheck(el, type) {
        const row = el.closest('tr');
        const d = row.querySelector('.p-check'), n = row.querySelector('.a-check');
        if (type === 'p' && d.checked) n.checked = false;
        if (type === 'a' && n.checked) d.checked = false;
    }

    async function printeazaSiBlocheazaZiua(btn) {
        const page = btn.closest('.page');
        const zi = page.getAttribute('data-zi');
        
        // 1. Ascundem toate celelalte pagini pentru a printa doar una
        const allPages = document.querySelectorAll('.page');
        allPages.forEach(p => { if (p !== page) p.classList.add('hide-for-print'); });

        const idBlocare = `MASA_${zi}_${globalConfig.luna}_${globalConfig.an}_${globalConfig.clasa}`;
        const { error } = await _supabase.from('planificari_documente').upsert({ 
            tip_document: idBlocare, 
            expert: globalConfig.expert, 
            continut_json: { status: "printat", timestamp: new Date().toISOString() } 
        });

        if (!error) { 
            window.print(); 
            // 2. Afi»ôƒÉm √Ænapoi toate paginile dupƒÉ print »ôi re√ÆncƒÉrcƒÉm pentru refresh status
            allPages.forEach(p => p.classList.remove('hide-for-print'));
            location.reload(); 
        } else {
            allPages.forEach(p => p.classList.remove('hide-for-print'));
            alert("Eroare la blocare!");
        }
    }

    async function deblocheazaZiua(btn) {
        if (!confirm("Deblochezi lista pentru aceastƒÉ zi?")) return;
        const page = btn.closest('.page');
        const zi = page.getAttribute('data-zi');
        const idBlocare = `MASA_${zi}_${globalConfig.luna}_${globalConfig.an}_${globalConfig.clasa}`;
        const { error } = await _supabase.from('planificari_documente').delete().eq('tip_document', idBlocare);
        if (!error) location.reload();
    }

    function addRow() {
        document.querySelectorAll('.tabel-body').forEach(tbody => {
            if (tbody.closest('.container-tabel').style.display !== 'none') {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="nr-cell"></td><td><input type="text" class="edit-name" placeholder="Nume Prenume"></td><td><input type="checkbox" class="p-check" checked onclick="toggleCheck(this, 'p')"></td><td><input type="checkbox" class="a-check" onclick="toggleCheck(this, 'a')"></td><td></td>`;
                tbody.appendChild(tr);
            }
        });
        reindexAll();
    }

    function removeLastRow() {
        document.querySelectorAll('.tabel-body').forEach(tbody => { if (tbody.lastElementChild) tbody.removeChild(tbody.lastElementChild); });
        reindexAll();
    }

    function reindexAll() {
        document.querySelectorAll('.tabel-body').forEach(tbody => {
            tbody.querySelectorAll('.nr-cell').forEach((td, i) => td.textContent = i + 1);
        });
    }

    async function incarcaDate() {
        try {
            const params = new URLSearchParams(window.location.search);
            globalConfig = { expert: params.get('expert'), clasa: params.get('clasa'), luna: params.get('luna'), an: params.get('an') };
            document.getElementById('btn-back').onclick = () => { window.location.href = `dosar-expert.html?expert=${encodeURIComponent(globalConfig.expert)}`; };
            
            const { data: pontaje } = await _supabase.from('pontaj_detaliat').select('zi, fara_masa').eq('expert', globalConfig.expert).eq('clase_grupe', globalConfig.clasa).eq('luna', globalConfig.luna).eq('an', globalConfig.an).order('zi', { ascending: true });
            if (!pontaje || pontaje.length === 0) { document.getElementById('status-msg').textContent = "‚ö†Ô∏è Nu s-au gƒÉsit activitƒÉ»õi."; return; }

            const { data: elevi } = await _supabase.from('elevi').select('nume_complet').eq('clasa_grupa', globalConfig.clasa).order('nume_complet', { ascending: true });
            const master = document.getElementById('master-container');
            const template = document.getElementById('page-template').content;

            for (let p of pontaje) {
                const clone = document.importNode(template, true);
                const pageDiv = clone.querySelector('.page');
                pageDiv.setAttribute('data-zi', p.zi);

                let actCod = "";
                for (let k in MAP_ACTIVITATI) if (MAP_ACTIVITATI[k].includes(globalConfig.expert)) actCod = k;
                clone.querySelector('.out-activitate').textContent = DESC_ACTIVITATI[actCod] || "---";
                clone.querySelector('.out-disciplina').textContent = MAP_DISCIPLINE[globalConfig.expert] || "---";
                clone.querySelector('.out-expert').textContent = globalConfig.expert;
                clone.querySelector('.sig-expert').textContent = globalConfig.expert;
                clone.querySelector('.out-clasa').textContent = MAP_CLASE[globalConfig.clasa] || globalConfig.clasa;
                clone.querySelector('.out-data').textContent = `${p.zi} ${globalConfig.luna} ${globalConfig.an}`.trim();

                const idVerificare = `MASA_${p.zi}_${globalConfig.luna}_${globalConfig.an}_${globalConfig.clasa}`;
                const { data: blocaj } = await _supabase.from('planificari_documente').select('expert').eq('tip_document', idVerificare).maybeSingle();

                const msgBox = pageDiv.querySelector('.msg-special');
                const tableCont = pageDiv.querySelector('.container-tabel');
                const lockBar = pageDiv.querySelector('.day-lock-bar');
                const statusText = pageDiv.querySelector('.lock-status-text');

                if (p.fara_masa) {
                    tableCont.style.display = 'none';
                    lockBar.style.display = 'none';
                    msgBox.style.display = 'block';
                    msgBox.innerHTML = `‚ö†Ô∏è ATEN»öIE: Conform pontajului, √Æn data de <strong>${p.zi} ${globalConfig.luna} ${globalConfig.an}</strong> elevii <strong>NU AU AVUT MASƒÇ CALDƒÇ</strong>.`;
                } else if (blocaj) {
                    if (blocaj.expert !== globalConfig.expert) {
                        tableCont.style.display = 'none';
                        lockBar.style.display = 'none';
                        msgBox.style.display = 'block';
                        msgBox.innerHTML = `‚ö†Ô∏è ATEN»öIE: Pachetul alimentar a fost deja distribuit de cƒÉtre <strong>${blocaj.expert.toUpperCase()}</strong> √Æn aceastƒÉ zi.`;
                    } else {
                        statusText.innerHTML = `‚úÖ Ziua ${p.zi} este BLOCATƒÇ de tine.`;
                        pageDiv.querySelector('.btn-lock-day').style.display = 'none';
                        pageDiv.querySelector('.btn-unlock-day').style.display = 'inline-block';
                        const tbody = pageDiv.querySelector('.tabel-body');
                        if (elevi) elevi.forEach((e, i) => adaugaRandElev(tbody, e.nume_complet, i));
                    }
                } else {
                    const tbody = pageDiv.querySelector('.tabel-body');
                    if (elevi) elevi.forEach((e, i) => adaugaRandElev(tbody, e.nume_complet, i));
                }
                master.appendChild(clone);
            }
            document.getElementById('status-msg').style.display = 'none';
        } catch (err) { console.error(err); }
    }

    function adaugaRandElev(tbody, nume, i) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="nr-cell">${i+1}</td><td><input type="text" class="edit-name" value="${nume}"></td><td><input type="checkbox" class="p-check" checked onclick="toggleCheck(this, 'p')"></td><td><input type="checkbox" class="a-check" onclick="toggleCheck(this, 'a')"></td><td></td>`;
        tbody.appendChild(tr);
    }

    document.addEventListener('DOMContentLoaded', incarcaDate);
</script>
</body>
</html>