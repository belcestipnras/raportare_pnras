<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Management Fi»ôe PNRAS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @page { size: A4; margin: 1.5cm; }
        
        body { background: #f0f2f5; margin: 0; padding: 80px 0; font-family: "Times New Roman", serif; }
        
        /* BARA DE CONTROL ACTUALIZATƒÇ */
        /* BARA DE CONTROL PE UN SINGUR R√ÇND */
        /* BARA DE CONTROL COMPACTƒÇ - UN SINGUR R√ÇND */
        .no-print { 
            position: fixed; top: 0; left: 0; width: 100%; 
            background: #1e293b; padding: 10px 20px; 
            display: grid; 
            grid-template-columns: auto 1fr auto; 
            align-items: center;
            z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            box-sizing: border-box;
            gap: 15px;
        }

        .nav-left { display: flex; gap: 15px; align-items: center; white-space: nowrap; }
        .nav-center { display: flex; justify-content: center; gap: 10px; }
        .nav-right { display: flex; justify-content: flex-end; align-items: center; }

        /* Ajustare dimensiune butoane pentru a garanta spa»õiul pe un r√¢nd */
        .btn { padding: 8px 16px; border: none; cursor: pointer; font-weight: bold; border-radius: 8px; font-family: sans-serif; transition: 0.2s; font-size: 13px; }
        .btn-print { background: #3b82f6; color: white; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); }

        .page { 
            background: white; width: 210mm; min-height: 297mm; 
            padding: 1.5cm; margin: 0 auto 30px auto;
            box-sizing: border-box; box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            display: flex; flex-direction: column;
            page-break-after: always;
        }

        .antet-img { width: 100%; height: auto; margin-bottom: 10px; }
        .titlu-fisa { text-align: center; font-size: 16pt; font-weight: bold; margin: 15px 0; text-transform: uppercase; color: #1e293b; }
        
        /* CARD INFO */
        .info-card { 
            background: #ffffff; padding: 25px; border-radius: 12px; 
            border: 1px solid #e2e8f0; border-left: 6px solid #2563eb;
            margin-bottom: 30px; box-shadow: 0 2px 15px rgba(37, 99, 235, 0.05);
            display: flex; flex-direction: column; gap: 12px;
        }
        .info-row { display: flex; align-items: flex-start; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        .info-row:last-child { border-bottom: none; padding-bottom: 0; }
        .info-label { min-width: 110px; font-family: sans-serif; font-size: 9pt; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .info-value { font-size: 11.5pt; color: #1e293b; font-weight: 500; }

        /* SEC»öIUNI */
        .sectiune { margin-top: 15px; display: flex; flex-direction: column; position: relative; padding-left: 18px; width: 100%; box-sizing: border-box; }
        .sectiune-titlu { font-weight: bold; font-size: 10pt; color: #2563eb; text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; font-family: sans-serif; }
        .sectiune::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: #2563eb; border-radius: 3px; }
        
        .caseta { border: 1px solid #cbd5e1; padding: 12px; border-radius: 0 8px 8px 8px; min-height: 1.4em; font-size: 11.5pt; outline: none; white-space: pre-wrap; width: 100%; box-sizing: border-box; background: #fff; color: #000; }

        .signature-block { margin-top: 40px; padding: 20px; border: 1px dashed #cbd5e1; border-radius: 12px; background: #fcfcfc; }

        /* BUTOANE */
        .btn { padding: 10px 20px; border: none; cursor: pointer; font-weight: bold; border-radius: 8px; font-family: sans-serif; transition: 0.2s; font-size: 13px; }
        .btn-print { background: #3b82f6; color: white; font-size: 15px; padding: 12px 40px; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); }
        .btn-back { background: #475569; color: white; }
        .btn-reset { background: #ef4444; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        #save-status { color: #10b981; font-family: sans-serif; font-size: 13px; font-weight: 600; }

        @media print {
            body { background: white; padding: 0; }
            .no-print { display: none; }
            .page { margin: 0; box-shadow: none; width: 100%; }
            .caseta { border: 1px solid #94a3b8 !important; }
            .info-card { border: 1px solid #cbd5e1 !important; border-left: 6px solid #2563eb !important; background: #fff !important; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <div class="nav-left">
            <button id="btn-back-dinamic" class="btn btn-back">‚¨ÖÔ∏è √énapoi</button>
            <div id="save-status"></div>
        </div>
        
        <div class="nav-center">
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è PRINTEAZƒÇ TOT</button>
            <button class="btn" style="background: #8b5cf6; color: white;" onclick="completeazaToateFiseleAI()">‚ú® CompleteazƒÉ tot cu AI</button>
        </div>

        <div class="nav-right">
            <button class="btn btn-reset" onclick="reseteazaLaPlanificare()">üßπ Reset (Planificare)</button>
        </div>
    </div>
<div class="nav-right">
    <button class="btn" style="background: #059669; color: white; margin-right: 8px;" 
            onclick="document.getElementById('input-fise').click()">üìÑ √éncarcƒÉ Fi»ôƒÉ</button>
    
    <button class="btn" style="background: #d97706; color: white; margin-right: 15px;" 
            onclick="document.getElementById('input-foto').click()">üì∏ Fotografii</button>
      
    <input type="file" id="input-fise" style="display: none;" accept="application/pdf" 
           onchange="incarcaInCloud(this, 'FISA')">
    <input type="file" id="input-foto" style="display: none;" accept="image/*" 
           onchange="incarcaInCloud(this, 'FOTO')">
</div>
    <div id="container-fise"></div>

<script>
    const URL_S = 'https://aexjrbdgajurxzngfkpx.supabase.co';
    const KEY_S = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
    const supabaseClient = supabase.createClient(URL_S, KEY_S);

    const params = new URLSearchParams(window.location.search);
    const config = {
        expert: params.get('expert'), luna: params.get('luna'), an: params.get('an'), clasa: params.get('clasa'),
        idDoc: `PLAN_${params.get('expert')}_${params.get('clasa')}_${params.get('luna')}_${params.get('an')}`,
        idData: `DATA_${params.get('expert')}_${params.get('clasa')}_${params.get('luna')}_${params.get('an')}`
    };

    // LOGICA BUTON BACK DINAMIC
    document.getElementById('btn-back-dinamic').onclick = () => {
        window.location.href = `dosar-expert.html?expert=${encodeURIComponent(config.expert)}`;
    };

    const dbExperti = {
        "Anghelu»ô Raluca": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ" },
        "Baziluc Ana Maria": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ" },
        "Gheme»ô Anca": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ" },
        "ArotƒÉri»õei DƒÉnu»õ": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la matematicƒÉ" },
        "Boldan Ovidiu": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la matematicƒÉ" },
        "Popovici Estera": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la matematicƒÉ" },
        "Iftene Ana Maria": { act: "A II.4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin", disc: "ActivitƒÉ»õi remediale la matematicƒÉ" },
        "Albu »òtefan": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de activitƒÉ»õi sportive »ôi outdoor" },
        "Marele Daniela": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de picturƒÉ" },
        "TanasƒÉ Liliana": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de muzicƒÉ" },
        "Popa Gabriela": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de dansuri" },
        "Nohai Iuliana": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de »ôtiin»õe" },
        "Nohai Vili": { act: "A II.5. ActivitƒÉ»õi extracurriculare »ôi de educa»õie non-formalƒÉ", disc: "Clubul de »ôtiin»õe" },
        "AparascƒÉi Vasile": { act: "A II.6. ActivitƒÉ»õi de dezvoltare a abilitƒÉ»õilor de litera»õie", disc: "Clubul de lecturƒÉ »ôi litera»õie" }
    };

    function applySmartBullets(text) {
        if (!text) return "";
        let lines = text.split('\n').map(l => l.replace(/^‚Ä¢\s*/, '').trim()).filter(l => l !== "");
        return lines.map((line, index) => {
            let cleanLine = line.replace(/[.;]$/, '');
            return index === lines.length - 1 ? `‚Ä¢ ${cleanLine}.` : `‚Ä¢ ${cleanLine};`;
        }).join('\n');
    }

    async function salveaza() {
        const pagini = document.querySelectorAll('.page');
        const fise = [];
        pagini.forEach(p => {
            const casete = p.querySelectorAll('.caseta');
            fise.push({
                data: p.querySelector('.data-val').innerText,
                titlu: casete[0].innerText, obiective: casete[1].innerText, activitati: casete[2].innerText,
                metode: casete[3].innerText, mijloace: casete[4].innerText, organizare: casete[5].innerText, concluzii: casete[6].innerText
            });
        });
        await supabaseClient.from('planificari_documente').upsert({ tip_document: config.idData, expert: config.expert, continut_json: { fise } }, { onConflict: 'tip_document' });
        document.getElementById('save-status').style.display = 'block';
        setTimeout(() => document.getElementById('save-status').style.display = 'none', 2000);
    }

    async function reseteazaLaPlanificare() {
        if (confirm("E»ôti sigur cƒÉ vrei sƒÉ »ôtergi tot ce ai scris »ôi sƒÉ revii la datele ini»õiale din planificare? AceastƒÉ ac»õiune nu poate fi anulatƒÉ.")) {
            const { error } = await supabaseClient
                .from('planificari_documente')
                .delete()
                .eq('tip_document', config.idData);
            
            if (!error) {
                window.location.reload();
            } else {
                alert("Eroare la resetare: " + error.message);
            }
        }
    }

    async function init() {
        let { data: saved } = await supabaseClient.from('planificari_documente').select('continut_json').eq('tip_document', config.idData).maybeSingle();
        let rows = [];
        if (saved && saved.continut_json.fise) {
            rows = saved.continut_json.fise;
        } else {
            let { data: plan } = await supabaseClient.from('planificari_documente').select('continut_json').eq('tip_document', config.idDoc).maybeSingle();
            if (plan) {
                rows = plan.continut_json.tableRows.map(r => ({ 
                    data: r.data, titlu: r.cont, obiective: "", 
                    activitati: r.actv || r.cont,
                    metode: "", mijloace: r.res, organizare: "", concluzii: "" 
                }));
            }
        }

        const container = document.getElementById('container-fise');
        const info = dbExperti[config.expert] || { act: "---", disc: "---" };

        rows.forEach(row => {
            const page = document.createElement('div');
            page.className = 'page';
            page.innerHTML = `
                <img src="antet_pnras.jpeg" class="antet-img">
                <div class="titlu-fisa">Fi»ôƒÉ de activitate</div>
                
                <div class="info-card">
                    <div class="info-row"><span class="info-label">Activitatea:</span><span class="info-value">${info.act}</span></div>
                    <div class="info-row"><span class="info-label">Disciplina:</span><span class="info-value">${info.disc}</span></div>
                    <div class="info-row"><span class="info-label">Expert:</span><span class="info-value">${config.expert}</span></div>
                    <div class="info-row"><span class="info-label">Data:</span><span class="info-value data-val">${row.data}</span></div>
                    <div class="info-row"><span class="info-label">Clasa:</span><span class="info-value">${config.clasa}</span></div>
                </div>

                <div class="sectiune"><div class="sectiune-titlu">üìå Titlul activitƒÉ»õii:</div><div class="caseta" contenteditable="true" onblur="this.innerText=applySmartBullets(this.innerText); salveaza();">${applySmartBullets(row.titlu)}</div></div>
                <div class="sectiune"><div class="sectiune-titlu">üéØ Obiective urmƒÉrite:</div><div class="caseta" contenteditable="true" onblur="this.innerText=applySmartBullets(this.innerText); salveaza();">${applySmartBullets(row.obiective)}</div></div>
                <div class="sectiune"><div class="sectiune-titlu">üìù ActivitƒÉ»õi de √ÆnvƒÉ»õare:</div><div class="caseta" contenteditable="true" onblur="this.innerText=applySmartBullets(this.innerText); salveaza();">${applySmartBullets(row.activitati)}</div></div>
                <div class="sectiune"><div class="sectiune-titlu">‚öôÔ∏è Metode »ôi procedee:</div><div class="caseta" contenteditable="true" onblur="this.innerText=applySmartBullets(this.innerText); salveaza();">${applySmartBullets(row.metode)}</div></div>
                <div class="sectiune"><div class="sectiune-titlu">üõ†Ô∏è Mijloace de √ÆnvƒÉ»õƒÉm√¢nt:</div><div class="caseta" contenteditable="true" onblur="this.innerText=applySmartBullets(this.innerText); salveaza();">${applySmartBullets(row.mijloace)}</div></div>
                <div class="sectiune"><div class="sectiune-titlu">üë• Forme de organizare:</div><div class="caseta" contenteditable="true" onblur="this.innerText=applySmartBullets(this.innerText); salveaza();">${applySmartBullets(row.organizare)}</div></div>
                <div class="sectiune"><div class="sectiune-titlu">üí° Concluzii »ôi recomandƒÉri:</div><div class="caseta" contenteditable="true" onblur="this.innerText=applySmartBullets(this.innerText); salveaza();">${applySmartBullets(row.concluzii)}</div></div>

                <div class="signature-block">
                    <div style="font-weight: bold; color: #2563eb; margin-bottom: 5px; font-family: sans-serif; font-size: 10pt;">LIVRABILE:</div>
                    <div style="font-size: 11pt; color: #475569;">
                        ‚Ä¢ Anexa 1: Fi»ôe de lucru/Materiale suport;<br>
                        ‚Ä¢ Anexa 2: Fotografii.
                    </div>
                    <div style="margin-top: 30px; font-weight: bold; font-size: 11pt; border-top: 1px solid #eee; padding-top: 15px;">Expert, ${config.expert}</div>
                </div>
            `;
            container.appendChild(page);
        });
    }
    init();
// --- LOGICA AI PENTRU FI»òE ---

// AceastƒÉ func»õie va folosi elementul tƒÉu <div id="save-status">
function setStatus(tip, mesaj) {
    const el = document.getElementById('save-status');
    if (!el) return;
    el.innerText = mesaj;
    el.style.color = tip === 'error' ? '#ef4444' : (tip === 'loading' ? '#fbbf24' : '#10b981');
}

async function completeazaToateFiseleAI() {
    const pagini = document.querySelectorAll('.page');
    if (!confirm(`Vrei sƒÉ completezi automat ${pagini.length} fi»ôe?`)) return;

    for (let i = 0; i < pagini.length; i++) {
        const p = pagini[i];
        const casete = p.querySelectorAll('.caseta');
        
        const tema = casete[0].innerText.trim(); 
        const activitateSursa = casete[2].innerText.trim(); 

        if (tema.length < 2) continue;

        setStatus('loading', `ü§ñ Generare fi»ôa ${i+1}/${pagini.length}...`);

        // 1. MODIFICARE PROMPT: Am cerut explicit r√¢nduri noi pentru fiecare punct
        const promptStrict = `
            E»ôti expert educa»õional PNRAS.
            TEMA: "${tema}"
            ACTIVITATE: "${activitateSursa}"
            CERIN»öA: CompleteazƒÉ fi»ôa respect√¢nd structura de mai jos.
            
            REGULI DE FORMATARE:
            - Fiecare punct din Obiective, Metode »ôi Mijloace trebuie sƒÉ fie pe r√¢nd nou.
            - NU folosi buline (le adaug eu).
            - NU scrie titlurile sec»õiunilor.
            - Folose»ôte caracterul "|" doar pentru a separa sec»õiunile mari.

            STRUCTURA RƒÇSPUNSULUI (Exemplu de format):
            Obiectiv 1
            Obiectiv 2
            Obiectiv 3 | Metoda 1
            Metoda 2 | Mijloc 1
            Mijloc 2 | Organizare | Concluzie
        `;

        try {
            const response = await fetch(`${URL_S}/functions/v1/chatgpt-pnras`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${KEY_S}` },
                body: JSON.stringify({ prompt: promptStrict })
            });

            const data = await response.json();
            let textAI = data.choices ? data.choices[0].message.content : (data.text || "");
            
            // CurƒÉ»õare cuvinte reziduale
            const deSters = ["Obiective:", "Metode:", "Mijloace:", "Organizare:", "Concluzii:"];
            deSters.forEach(cuvant => {
                const regex = new RegExp(cuvant, "gi");
                textAI = textAI.replace(regex, "");
            });

            // 2. SPLIT & CLEAN: √émpƒÉr»õim pe sec»õiuni (Obiective | Metode | etc.)
            const parti = textAI.split('|').map(p => p.trim());

            if (parti.length >= 5) {
                // 3. SEPARARE PE R√ÇNDURI: applySmartBullets va prelua textul cu \n »ôi va pune buline pe fiecare r√¢nd
                casete[1].innerText = applySmartBullets(parti[0]); // Obiective
                casete[3].innerText = applySmartBullets(parti[1]); // Metode
                casete[4].innerText = applySmartBullets(parti[2]); // Mijloace
                casete[5].innerText = applySmartBullets(parti[3]); // Organizare
                casete[6].innerText = applySmartBullets(parti[4]); // Concluzii
                
                if (typeof salveaza === 'function') await salveaza();
            }
            await new Promise(r => setTimeout(r, 1000));
        } catch (e) {
            console.error("Eroare:", e);
            setStatus('error', "Eroare la fi»ôa " + (i+1));
        }
    }
    setStatus('saved', '‚úÖ Fi»ôe completate pe r√¢nduri separate!');
}
let tipIncarcare = ''; 

function selecteazaFisier(tip) {
    tipIncarcare = tip;
    const input = document.getElementById('upload-input-invizibil');
    if (input) input.click();
}

// ACEASTƒÇ FUNC»öIE LIPSEA DIN CODUL TƒÇU
// --- FUNC»öIA DE UPLOAD (STREAMING) ---
async function incarcaInCloud(inputElement, tip) {
    const fisier = inputElement.files[0];
    if (!fisier) return;

    // 1. PreluƒÉm datele de context din URL (Expert »ôi ClasƒÉ)
    const params = new URLSearchParams(window.location.search);
    const expertName = params.get('expert') || "Expert_Necunoscut";
    const clasa = params.get('clasa') || "5A";

    // 2. IdentificƒÉm pagina pentru care se face √ÆncƒÉrcarea
    const pagini = document.querySelectorAll('.page');
    const raspuns = prompt(`√éncarci ${tip}. Pentru ce paginƒÉ (1-${pagini.length})?`);
    if (raspuns === null) { inputElement.value = ''; return; }
    
    const nr = parseInt(raspuns);
    if (isNaN(nr) || nr < 1 || nr > pagini.length) {
        alert("PaginƒÉ invalidƒÉ!");
        inputElement.value = '';
        return;
    }

    // 3. DEFINIM dataFisa (Aici era eroarea!)
    // CƒÉutƒÉm data scrisƒÉ √Æn pagina selectatƒÉ (√Æn elementul cu clasa .data-val)
    const paginaSelectata = pagini[nr - 1];
    let dataFisa = "01-01-2025"; // O datƒÉ de rezervƒÉ
    const dataElement = paginaSelectata.querySelector('.data-val');
    
    if (dataElement && dataElement.innerText.trim() !== "") {
        // √énlocuim punctele cu cratime pentru a fi acceptat ca nume de folder (ex: 31.01.2025 -> 31-01-2025)
        dataFisa = dataElement.innerText.trim().replace(/\./g, '-');
    }

    const numeFinal = `${tip}_${nr}_${expertName.replace(/\s+/g, '_')}_${clasa}.${tip === 'FOTO' ? 'jpg' : 'pdf'}`;
    
    setStatus('loading', `üöÄ Se pregƒÉte»ôte ${numeFinal}...`);

    const reader = new FileReader();
    reader.readAsDataURL(fisier);
    reader.onloadend = async () => {
        const base64data = reader.result.split(',')[1];
        
        // FOLOSE»òTE ULTIMUL URL GENERAT LA PASUL 2 (cel cu /exec)
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbwt8PX04jDM4a4vCbenf66TCixs47DwX8Ab8Ij6z580NxgsoNqqusdCKNjklzJ36qHUtA/exec";

        try {
            // Trimitem datele cƒÉtre Google Script
            await fetch(googleScriptUrl, {
                method: "POST",
                mode: "no-cors", // <--- ACEASTA ESTE LINIA CRUCIALƒÇ
                cache: "no-cache",
                headers: {
                    "Content-Type": "text/plain", // Folosim text/plain ca sƒÉ nu declan»ôƒÉm verificƒÉri de securitate
                },
                body: JSON.stringify({
                    fileName: numeFinal,
                    fileType: fisier.type,
                    fileBase64: base64data,
                    rootFolderId: '173Qq7JNoOEHL2ZnG4At2zH1MxzUiACvn',
                    expertName: expertName, 
                    clasa: clasa,           
                    dataFisa: dataFisa      
                })
            });

            // Deoarece folosim no-cors, browserul nu ne lasƒÉ sƒÉ citim rƒÉspunsul,
            // a»ôa cƒÉ afi»ôƒÉm succesul dupƒÉ o scurtƒÉ a»ôteptare.
            setTimeout(() => {
                alert(`‚úÖ CERERE TRIMISƒÇ!\nDocumentul a plecat spre: ${expertName} > Clasa ${clasa}`);
                setStatus('saved', "‚úÖ Finalizat");
            }, 1000);
            
        } catch (err) {
            console.error("Eroare fetch:", err);
            alert("Eroare la trimitere: " + err.message);
            setStatus('error', "‚ùå Eroare");
            } finally {
            inputElement.value = '';
        }
    };
}

</script>
</body>
</html>