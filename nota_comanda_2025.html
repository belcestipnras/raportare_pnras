<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotÄƒ ComandÄƒ 2025 - PNRAS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e40af; --accent: #3b82f6; --save-color: #10b981; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #475569; color: #1e293b; }
        
        .selection-container { display: flex; flex-direction: column; align-items: center; padding: 50px 20px; background: #e2e8f0; min-height: 100vh;}
        .months-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; width: 100%; max-width: 1000px; margin-top: 30px; }
        .month-card { background: white; padding: 25px; border-radius: 15px; text-align: center; cursor: pointer; transition: 0.3s; border: 2px solid #fff; font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .month-card:hover { transform: translateY(-5px); border-color: var(--primary); color: var(--primary); }

        #document-view { display: none; padding: 40px 0; position: relative; }
        .sheet {
            background: white; width: 210mm; margin: 0 auto; box-sizing: border-box; 
            padding: 1.5cm; position: relative; font-family: "Times New Roman", Times, serif; 
            font-size: 12pt; line-height: 1.5; color: #000; box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }
        .antet-img { width: 100%; height: auto; margin-bottom: 10px; }

        .nr-inregistrare { margin-top: 5px; font-weight: bold; font-size: 12pt; display: flex; align-items: center; }
        .input-inv { border: none; outline: none; font-family: inherit; font-size: inherit; font-weight: bold; background: transparent; padding: 0; margin: 0; }
        
        .header-box { text-align: center; margin: 20px 0; border: 1pt solid var(--primary); padding: 15px; border-radius: 12px; background: #f0f7ff; }
        .titlu-principal { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 18pt; color: var(--primary); text-transform: uppercase; margin: 0; }
        
        .destinatar-card { background: #f8fafc; padding: 15px; border-left: 6px solid var(--primary); margin: 15px 0; border-radius: 4px; font-weight: bold; outline: none;}
        .continut-text { text-indent: 1.25cm; text-align: justify; margin-bottom: 8px; outline: none; }

        .tabel-comanda { width: 100%; border-collapse: collapse; border: 1pt solid #000; table-layout: fixed; }
        .tabel-comanda th, .tabel-comanda td { border: 1pt solid #000; padding: 8px; text-align: center; outline: none; }
        .tabel-comanda th { background: #eff6ff !important; font-weight: bold; }

        .info-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
        .info-box { border: 1pt solid #000; padding: 12px; border-radius: 8px; outline: none; }
        .semnatura { margin-top: 40px; text-align: right; font-weight: bold; padding-right: 30px; outline: none; }

        .controls { position: fixed; top: 20px; left: 20px; z-index: 1000; display: flex; gap: 10px; }
        .btn-ui { padding: 12px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; font-family: 'Inter'; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-reset { background: #ef4444; color: white; }
        .btn-print { background: var(--primary); color: white; }
        .status-notif { position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px 20px; border-radius: 30px; border: 2px solid var(--save-color); font-weight: bold; display: none; z-index: 9999; }

        @media print {
            @page { size: A4; margin: 1.5cm; }
            body { background: white; margin: 0; }
            #document-view { padding: 0; display: block !important; }
            .controls, #selection-view, .status-notif { display: none !important; }
            .sheet { box-shadow: none; margin: 0; width: 100%; padding: 0 !important; }
            .input-inv { border: none !important; }
            .tabel-comanda, .tabel-comanda th, .tabel-comanda td, .info-box { border: 1pt solid #000 !important; }
        }
    </style>
</head>
<body>

    <div id="save-status" class="status-notif">â˜ï¸ Se salveazÄƒ...</div>

    <div class="controls">
        <button class="btn-ui" style="background:white; border:2px solid var(--primary);" onclick="goBack()">â¬…ï¸ Ãnapoi</button>
        <button class="btn-ui btn-reset" onclick="resetLaPontaj()">ğŸ”„ Revenire la datele din pontaj</button>
        <button id="print-btn" class="btn-ui btn-print" style="display:none;" onclick="window.print()">ğŸ–¨ï¸ PrinteazÄƒ</button>
    </div>

    <div id="selection-view" class="selection-container">
        <h1 style="color: var(--primary); font-family: Montserrat;">ğŸ“… NotÄƒ de ComandÄƒ 2025</h1>
        <div class="months-grid" id="months-grid"></div>
    </div>

    <div id="document-view">
        <div class="sheet">
            <img src="antet_pnras.jpeg" alt="Antet PNRAS" class="antet-img">
            
            <div class="nr-inregistrare">
                Nr. <input type="text" id="db-nr" class="input-inv" style="width:40px; text-align:right;" oninput="autoSave()">/<input type="text" id="db-data-nr" class="input-inv" style="width:110px;" oninput="autoSave()">
            </div>

            <div class="header-box">
                <div class="titlu-principal">ğŸ“ NotÄƒ de comandÄƒ</div>
                <div class="subtitlu">privind distribuirea pachetului alimentar de tip masÄƒ caldÄƒ, pentru elevii participanÈ›i la activitÄƒÈ›ile remediale È™i extracurriculare</div>
            </div>

            <div class="destinatar-card" contenteditable="true" id="db-dest" oninput="autoSave()">
                ğŸ¢ CÄƒtre: SC PROCONS IAÈ˜I SRL<br>ğŸ“ Adresa: Sat BelceÈ™ti, Comuna BelceÈ™ti, nr. 370, mansardÄƒ, JudeÈ›ul IaÈ™i
            </div>

            <div class="continut-text" contenteditable="true" id="db-salut" oninput="autoSave()">ğŸ‘‹ StimatÄƒ doamnÄƒ Murariu Mirela,</div>
            <div class="continut-text">
                VÄƒ transmitem prezenta notÄƒ de comandÄƒ cu privire la distribuirea pachetului alimentar de tip masÄƒ caldÄƒ, pentru 
                <strong>luna <span id="luna-text-dinamic" style="color:var(--primary)">________</span> 2025</strong>, dupÄƒ cum urmeazÄƒ:
            </div>

            <div style="font-weight: bold; margin: 15px 0 5px 0; color: var(--primary);">ğŸ“Œ Denumire activitate, conform cererii de finanÈ›are: A II.3. GustÄƒri/MasÄƒ rece/caldÄƒ È™i sÄƒnÄƒtoasÄƒ</div>

            <table class="tabel-comanda">
                <thead>
                    <tr>
                        <th style="width: 8%;">Nr. crt.</th>
                        <th style="width: 42%;">Denumirea serviciului</th>
                        <th style="width: 25%;">Data</th>
                        <th style="width: 25%;">Cantitate (porÈ›ii)</th>
                    </tr>
                </thead>
                <tbody id="corp-tabel-nota"></tbody>
                <tfoot>
                    <tr style="font-weight: bold; background: #f8fafc;">
                        <td colspan="3" style="text-align: right; padding-right: 15px;">ğŸ“Š TOTAL PORÈšII LUNÄ‚</td>
                        <td id="total-final">0</td>
                    </tr>
                </tfoot>
            </table>

            <div class="info-container">
                <div class="info-box" contenteditable="true" id="db-mentiuni" oninput="autoSave()">
                    <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">ğŸ” MenÈ›iuni:</div>
                    <ul style="margin:0; padding:0; list-style:none; font-size:10.5pt;">
                        <li style="text-indent:0.5cm;">1. Produsele trebuie fi livrate conform contractului de prestÄƒri servicii de catering Nr. 143/06.12.2024;</li>
                        <li style="text-indent:0.5cm;">2. Produsele trebuie sÄƒ fie conforme din punct de vedere sanitar-veterinar;</li>
                        <li style="text-indent:0.5cm;">3. Pe durata transportului, marfa trebuie sÄƒ fie Ã®nsoÈ›itÄƒ de aviz;</li>
                    </ul>
                </div>
                <div class="info-box" contenteditable="true" id="db-livrare" oninput="autoSave()">
                    <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">ğŸšš Date privind livrarea:</div>
                    <ul style="margin:0; padding:0; list-style:none; font-size:10.5pt;">
                        <li style="text-indent:0.5cm;">1. Numele delegatului: Murariu Mirela;</li>
                        <li style="text-indent:0.5cm;">2. LivrÄƒrile se vor efectua la adresa beneficiarului, la datele stabilite conform prezentei note de comanda, la ora 13.30;</li>
                        <li style="text-indent:0.5cm;">3. Persoana delegatÄƒ pentru a primi produsele este Pavel Ioan, tel. 0748159864;</li>
                        <li style="text-indent:0.5cm;">4. DacÄƒ livrarea nu se poate efectua Ã®n ziua stabilitÄƒ, vÄƒ rugÄƒm sÄƒ ne Ã®nÈ™tiinÈ›aÈ›i cu cel puÈ›in 4 ore Ã®nainte.</li>
                    </ul>
                </div>
            </div>

            <div class="semnatura" contenteditable="true" id="db-semn" oninput="autoSave()">
                ğŸ–‹ï¸ Manager proiect,<br>prof. dr. Ciprian MIHAI
            </div>
        </div>
    </div>

    <script type="module">
        const URL_S = 'https://aexjrbdgajurxzngfkpx.supabase.co';
        const KEY_S = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
        const supabase = window.supabase.createClient(URL_S, KEY_S);

        const luniNames = ["Ianuarie", "Februarie", "Martie", "Aprilie", "Mai", "Iunie", "Iulie", "August", "Septembrie", "Octombrie", "Noiembrie", "Decembrie"];
        const luniMap = {"Ianuarie":"01","Februarie":"02","Martie":"03","Aprilie":"04","Mai":"05","Iunie":"06","Iulie":"07","August":"08","Septembrie":"09","Octombrie":"10","Noiembrie":"11","Decembrie":"12"};
        let currentLuna = "";
        let saveTimer = null;

        const grid = document.getElementById('months-grid');
        grid.innerHTML = luniNames.map(l => `<div class="month-card" onclick="selectLuna('${l}')">ğŸ“‚ ${l}</div>`).join('');

        // La Ã®ncÄƒrcare, verificÄƒm dacÄƒ avem o lunÄƒ Ã®n URL
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const lunaParam = urlParams.get('luna');
            if (lunaParam && luniNames.includes(lunaParam)) {
                selectLuna(lunaParam, false);
            }
        });

        window.selectLuna = async (luna, updateUrl = true) => {
            currentLuna = luna;
            if (updateUrl) {
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?luna=' + luna;
                window.history.pushState({path:newUrl}, '', newUrl);
            }
            document.getElementById('selection-view').style.display = 'none';
            document.getElementById('document-view').style.display = 'block';
            document.getElementById('print-btn').style.display = 'block';
            document.getElementById('luna-text-dinamic').innerText = luna;
            await incarcaDocument();
        };

        window.goBack = () => {
            if (document.getElementById('document-view').style.display === 'block') {
                // DacÄƒ suntem Ã®n vizualizarea documentului, mergem Ã®napoi la selecÈ›ia lunii
                const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                window.history.pushState({path:cleanUrl}, '', cleanUrl);
                document.getElementById('document-view').style.display = 'none';
                document.getElementById('selection-view').style.display = 'flex';
                document.getElementById('print-btn').style.display = 'none';
            } else {
                // Altfel mergem la pagina principalÄƒ a meniului
                window.location.href = 'nota_comanda_masa.html';
            }
        };

        async function incarcaDocument() {
            const docId = `NOTA_COM_2025_${currentLuna}`;
            const { data: savedDoc } = await supabase.from('planificari_documente').select('continut_json').eq('tip_document', docId).maybeSingle();

            if (savedDoc && savedDoc.continut_json) {
                const j = savedDoc.continut_json;
                document.getElementById('db-nr').value = j.nr || "";
                document.getElementById('db-data-nr').value = j.dataNr || "";
                document.getElementById('db-dest').innerHTML = j.dest;
                document.getElementById('db-salut').innerHTML = j.salut;
                document.getElementById('db-mentiuni').innerHTML = j.mentiuni;
                document.getElementById('db-livrare').innerHTML = j.livrare;
                document.getElementById('db-semn').innerHTML = j.semn;
                renderTabel(j.tabel);
            } else {
                await resetLaPontaj(false);
            }
        }

        window.resetLaPontaj = async (confirmare = true) => {
            if(confirmare && !confirm("Sigur vrei sÄƒ È™tergi modificÄƒrile manuale È™i sÄƒ revii la datele din baza de date?")) return;
            const { data } = await supabase.from('setari_pontaj').select('zi, valoare_aviz').match({ an: 2025, luna: currentLuna }).gt('valoare_aviz', 0);
            const initRows = (data || []).sort((a,b) => a.zi - b.zi).map(r => ({ data: `${r.zi.toString().padStart(2,'0')}.${luniMap[currentLuna]}.2025`, qty: r.valoare_aviz }));
            renderTabel(initRows);
            if(confirmare) {
                await supabase.from('planificari_documente').delete().eq('tip_document', `NOTA_COM_2025_${currentLuna}`);
                alert("S-a revenit la datele din pontaj.");
            }
        };

        function renderTabel(rows) {
            const tbody = document.getElementById('corp-tabel-nota');
            const txt = "Pachet alimentar de tip masÄƒ caldÄƒ, conform Contractului nr. 143/06.12.2024";
            tbody.innerHTML = rows.map((r, i) => `
                <tr>
                    <td contenteditable="true" oninput="autoSave()">${i+1}</td>
                    ${i===0 ? `<td rowspan="${rows.length}" contenteditable="true" oninput="autoSave()">${txt}</td>` : ''}
                    <td contenteditable="true" oninput="autoSave()">${r.data}</td>
                    <td contenteditable="true" class="qty-field" oninput="recalc()">${r.qty}</td>
                </tr>
            `).join('');
            recalc(false);
        }

        window.recalc = (trigger = true) => {
            let t = 0;
            document.querySelectorAll('.qty-field').forEach(c => t += parseInt(c.innerText.replace(/\D/g,'')) || 0);
            document.getElementById('total-final').innerText = t;
            if(trigger) autoSave();
        };

        window.autoSave = () => {
            const st = document.getElementById('save-status');
            st.style.display = 'block';
            st.innerText = 'â˜ï¸ Se salveazÄƒ...';
            if(saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(salveazaInCloud, 1500);
        };

        async function salveazaInCloud() {
            const trs = Array.from(document.getElementById('corp-tabel-nota').rows);
            const tabelData = trs.map(r => ({
                data: r.cells[r.cells.length-2].innerText,
                qty: r.cells[r.cells.length-1].innerText
            }));
            const payload = {
                nr: document.getElementById('db-nr').value,
                dataNr: document.getElementById('db-data-nr').value,
                dest: document.getElementById('db-dest').innerHTML,
                salut: document.getElementById('db-salut').innerHTML,
                mentiuni: document.getElementById('db-mentiuni').innerHTML,
                livrare: document.getElementById('db-livrare').innerHTML,
                semn: document.getElementById('db-semn').innerHTML,
                tabel: tabelData
            };
            await supabase.from('planificari_documente').upsert({
                tip_document: `NOTA_COM_2025_${currentLuna}`,
                an: 2025,
                luna: currentLuna,
                continut_json: payload,
                expert: "AUTOSAVE"
            }, { onConflict: 'tip_document' });
            const st = document.getElementById('save-status');
            st.innerText = 'âœ… Salvat Ã®n Cloud';
            setTimeout(() => st.style.display = 'none', 1500);
        }
    </script>
</body>
</html>