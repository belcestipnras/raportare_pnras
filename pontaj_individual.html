<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fi»ôƒÉ IndividualƒÉ de Pontaj PNRAS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --deep-blue: #1e3a8a; 
            --electric-blue: #2563eb;
            --soft-blue: #eff6ff;
            --border-blue: #bfdbfe;
        }
        @page { size: A4; margin: 0.8cm; }
        
        body { 
            background: #f1f5f9; 
            font-family: 'Inter', sans-serif; 
            color: #000; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            /* For»õeazƒÉ browserul sƒÉ printeze culorile de fundal */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .no-print { 
            position: sticky; top: 10px;
            margin-bottom: 20px; 
            display: flex; gap: 12px; 
            justify-content: center; 
            z-index: 1000;
        }

        .main-btn { 
            padding: 10px 22px; cursor: pointer; color: white; border: none; 
            border-radius: 50px; font-weight: 600; font-size: 13px; 
            display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-back { background: #000; border: 2px solid #10b981; }
        .btn-add { background: #10b981; }
        .btn-del { background: #ef4444; }
        .btn-print { background: var(--electric-blue); }

        .page { 
            background: white; 
            width: 210mm; 
            min-height: 297mm; 
            padding: 12mm 15mm; 
            box-sizing: border-box; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            border-top: 8px solid var(--deep-blue);
        }
        
        .antet-img { width: 100%; margin-bottom: 5px; }
        
        /* NR INREGISTRARE - FARA CHENAR, BOLD MODERAT */
        .nr-inreg { text-align: left; margin: 10px 0; font-size: 13px; font-weight: 500; }
        .nr-inreg input { 
            border: none; 
            background: transparent; 
            font-weight: 600; 
            width: 180px; 
            outline: none; 
            color: #000; 
            font-size: 14px; 
        }

        h2 { 
            text-align: center; text-transform: uppercase; font-size: 19px; 
            margin: 15px 0; font-weight: 800; color: var(--deep-blue);
        }

        /* CARTONA»ò INFO - ALINIAT STANGA, COLOANA 2 SPRE DREAPTA */
        .info-card { 
            background: var(--soft-blue) !important;
            padding: 15px 20px; 
            border-radius: 12px; 
            border: 1.5px solid var(--border-blue); 
            margin: 15px 0;
            display: grid;
            grid-template-columns: 1fr 1.1fr; 
            gap: 8px 40px; 
            line-height: 1.3;
        }
        
        .info-line { font-size: 13px; display: flex; flex-direction: column; text-align: left; }
        .info-label { font-weight: 800; text-transform: uppercase; font-size: 9px; color: #444; margin-bottom: 2px; }
        .info-value { font-weight: 700; color: #000; font-size: 13.5px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 2px solid #000; }
        th { 
            background: var(--soft-blue) !important; color: var(--deep-blue); 
            padding: 10px 5px; font-size: 10.5px; font-weight: 800;
            text-transform: uppercase; border: 1.5px solid #000; 
        }
        td { border: 1.5px solid #000; padding: 7px 5px; font-size: 12px; text-align: center; outline: none; color: #000; }
        
        .total-row { font-weight: 800; background: var(--soft-blue) !important; color: var(--deep-blue); }
        .total-label { text-align: right; padding-right: 25px; text-transform: uppercase; font-size: 11px; border: 1.5px solid #000; }

        .signature-row { 
            margin-top: 40px; 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px; 
            text-align: center; 
        }
        .sig-item { color: #000; font-weight: 600; font-size: 12px; }
        .sig-title { display: block; margin-bottom: 35px; font-weight: 700; }
        .sig-name { display: block; font-weight: 800; border-top: 1px solid #000; padding-top: 8px; font-size: 12px; }

        @media print { 
            .no-print { display: none; } 
            body { padding: 0; background: none; } 
            .page { box-shadow: none; width: 100%; margin: 0; padding: 5mm; border-top: 8px solid var(--deep-blue); } 
            /* For»õƒÉm culorile sƒÉ aparƒÉ la imprimantƒÉ */
            .info-card { background-color: var(--soft-blue) !important; border-color: var(--border-blue) !important; }
            th { background-color: var(--soft-blue) !important; color: var(--deep-blue) !important; }
            .total-row { background-color: var(--soft-blue) !important; }
        }
    </style>
</head>
<body>

    <div class="no-print">
        <button id="btn-back" class="main-btn btn-back"><span>‚¨Ö</span> √éNAPOI</button>
        <button class="main-btn btn-add" onclick="addRow()">üìÇ ADAUGƒÇ R√ÇND</button>
        <button class="main-btn btn-del" onclick="removeLastRow()">üóëÔ∏è »òTERGE</button>
        <button class="main-btn btn-print" onclick="window.print()">üñ®Ô∏è PRINTEAZƒÇ</button>
    </div>

    <div class="page">
        <img src="antet_pnras.jpeg" class="antet-img">
        
        <div class="nr-inreg">
    <span>üìù Nr. √Ænreg:</span>
    <input type="text" id="nr_inreg_val" onblur="salveazaMeta()" placeholder="..." 
           style="border:none; border-bottom:1px dashed #000; width:60px; text-align:center; font-weight:bold; background:transparent;"> 
    / 
    <input type="text" id="data_inreg_val" onblur="salveazaMeta()" placeholder="..." 
           style="border:none; border-bottom:1px dashed #000; width:90px; text-align:center; font-weight:bold; background:transparent;">
    <span id="msg-salvare" style="font-size:10px; color:green; margin-left:10px; display:none;">‚úÖ Salvat</span>
</div>

        <h2>Fi»ôƒÉ individualƒÉ de pontaj</h2>

        <div class="info-card">
            <div class="info-line" style="grid-column: span 2;">
                <span class="info-label">Activitatea desfƒÉ»ôuratƒÉ:</span> 
                <span id="out-activitate" class="info-value"></span>
            </div>
            <div class="info-line">
                <span class="info-label">Luna raportatƒÉ:</span> 
                <span id="out-luna-an" class="info-value"></span>
            </div>
            <div class="info-line">
                <span class="info-label">Expert Proiect:</span> 
                <span id="out-expert" class="info-value"></span>
            </div>
            <div class="info-line">
                <span class="info-label">Nr. contract:</span> 
                <span id="out-contract" class="info-value"></span>
            </div>
            <div class="info-line">
                <span class="info-label">Disciplina:</span> 
                <span id="out-disciplina" class="info-value"></span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th width="7%">Nr.crt</th>
                    <th width="15%">Data</th>
                    <th width="63%">Clasa / Grupa Beneficiari</th>
                    <th width="15%">Ore/Zi</th>
                </tr>
            </thead>
            <tbody id="tabel-pontaj" oninput="recalculareTotal()"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="3" class="total-label">Total ore realizate √Æn lunƒÉ:</td>
                    <td id="total-final">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="signature-row">
            <div class="sig-item">
                <span class="sig-title">√éntocmit,<br>Expert,</span>
                <strong id="sig-expert" class="sig-name"></strong>
            </div>

            <div class="sig-item">
                <span class="sig-title">Aprobat,<br>Director,</span>
                <strong class="sig-name">prof. CƒÉtƒÉlin Ionu»õ BAZILUC</strong>
            </div>

            <div class="sig-item">
                <span class="sig-title">Avizat,<br>Manager proiect,</span>
                <strong class="sig-name">prof. dr. Ciprian MIHAI</strong>
            </div>
        </div>
    </div>

<script>
    // [Scriptul rƒÉm√¢ne neschimbat, cu excep»õia func»õiilor necesare]
    const URL_S = 'https://aexjrbdgajurxzngfkpx.supabase.co';
    const KEY_S = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
    const _supabase = supabase.createClient(URL_S, KEY_S);

    const CONTRACTE = { "Anghelu»ô Raluca": "49/PNRAS/31.10.2024", "Baziluc Ana Maria": "51/PNRAS/31.10.2024", "Gheme»ô Anca": "63/PNRAS/31.10.2024", "ArotƒÉri»õei DƒÉnu»õ": "50/PNRAS/31.10.2024", "Boldan Ovidiu": "67/PNRAS/31.10.2024", "Popovici Estera": "59/PNRAS/31.10.2024", "Albu »òtefan": "47/PNRAS/31.10.2024", "Marele Daniela": "53/PNRAS/31.10.2024", "TanasƒÉ Liliana": "60/PNRAS/31.10.2024", "Popa Gabriela": "58/PNRAS/31.10.2024", "Nohai Iuliana": "56/PNRAS/31.10.2024", "Nohai Vili": "57/PNRAS/31.10.2024", "AparascƒÉi Vasile": "48/PNRAS/31.10.2024", "Iftene Ana Maria": "52/PNRAS/31.10.2024" };
    const MAP_DISCIPLINE = { 'Anghelu»ô Raluca': 'ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ', 'Baziluc Ana Maria': 'ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ', 'Gheme»ô Anca': 'ActivitƒÉ»õi remediale la limba »ôi literatura rom√¢nƒÉ', 'ArotƒÉri»õei DƒÉnu»õ': 'ActivitƒÉ»õi remediale la matematicƒÉ', 'Boldan Ovidiu': 'ActivitƒÉ»õi remediale la matematicƒÉ', 'Popovici Estera': 'ActivitƒÉ»õi remediale la matematicƒÉ', 'Albu »òtefan': 'ActivitƒÉ»õi extracurriculare la Clubul de activitƒÉ»õi sportive »ôi outdoor', 'Marele Daniela': 'ActivitƒÉ»õi extracurriculare la Clubul de picturƒÉ', 'TanasƒÉ Liliana': 'ActivitƒÉ»õi extracurriculare la Clubul de muzicƒÉ', 'Popa Gabriela': 'ActivitƒÉ»õi extracurriculare la Clubul de dansuri', 'Nohai Iuliana': 'ActivitƒÉ»õi extracurriculare la Clubul de »ôtiin»õe', 'Nohai Vili': 'ActivitƒÉ»õi extracurriculare la Clubul de »ôtiin»õe', 'AparascƒÉi Vasile': 'ActivitƒÉ»õi extracurriculare la Clubul de lecturƒÉ »ôi litera»õie', 'Iftene Ana Maria': 'ActivitƒÉ»õi remediale la matematicƒÉ' };
    const MAP_CLASE = { '5A': 'Clasa a V-a A', '5B': 'Clasa a V-a B', '5C': 'Clasa a V-a C', '6A': 'Clasa a VI-a A', '6B': 'Clasa a VI-a B', '6C': 'Clasa a VI-a C', '7A': 'Clasa a VII-a A', '7B': 'Clasa a VII-a B', '7C': 'Clasa a VII-a C', '8A': 'Clasa a VIII-a A', '8B': 'Clasa a VIII-a B', '8C': 'Clasa a VIII-a C', 'SG1': 'Grupa 1, Sport', 'SG2': 'Grupa 2, Sport', 'PG1': 'Grupa 1, PicturƒÉ', 'PG2': 'Grupa 2, PicturƒÉ', 'MG1': 'Grupa 1, MuzicƒÉ', 'MG2': 'Grupa 2, MuzicƒÉ', 'DG1': 'Grupa 1, Dansuri', 'StG1': 'Grupa 1, »òtiin»õe', 'StG2': 'Grupa 2, »òtiin»õe', 'SG1A': 'Grupa 1A, Sport', 'SG1B': 'Grupa 1B, Sport', 'PG1A': 'Grupa 1A, PicturƒÉ', 'PG1B': 'Grupa 1B, PicturƒÉ', 'StG1A': 'Grupa 1A, »òtiin»õe', 'StG1B': 'Grupa 1B, »òtiin»õe', 'AV5A': 'Clasa a V-a A', 'AV5B': 'Clasa a V-a B', 'AV6A': 'Clasa a VI-a A', 'AV6B': 'Clasa a VI-a B', 'AV7A': 'Clasa a VII-a A', 'AV7B': 'Clasa a VII-a B', 'AV8A1': 'Clasa a VIII-a A, Gr. 1', 'AV8A2': 'Clasa a VIII-a A, Gr. 2', 'AV8B1': 'Clasa a VIII-a B, Gr. 1', 'AV8B2': 'Clasa a VIII-a B, Gr. 2', 'AR5AB': 'Clasele a V-a A, B', 'AR5A': 'Clasa a V-a A', 'AR5B': 'Clasa a V-a B', 'AR6A': 'Clasa a VI-a A', 'AR6B': 'Clasa a VI-a B', 'AR7B': 'Clasa a VII-a B', 'BA6B': 'Clasa a VI-a B', 'BA7A': 'Clasa a VII-a A', 'BA8A1': 'Clasa a VIII-a A, Gr. 1', 'BA8A2': 'Clasa a VIII-a A, Gr. 2', 'BA8B': 'Clasa a VIII-a B', 'AD8B1': 'Clasa a VIII-a B, Gr. 1', 'AD8B2': 'Clasa a VIII-a B, Gr. 2', 'AD8B3': 'Clasa a VIII-a B, Gr. 3', 'PE8A1': 'Clasa a VIII-a A, Gr. 1', 'PE8A2': 'Clasa a VIII-a A, Gr. 2', 'PE6B': 'Clasa a VI-a B', 'PE7A': 'Clasa a VII-a A', 'IA5AB1': 'Clasele a V-a A, B', 'IA5AB2': 'Clasele a V-a A, B', 'IA6A': 'Clasa a VI-a A', 'IA7B': 'Clasa a VII-a B' };
    const DESC_ACT = { 'A II.4.': 'A II. 4. ActivitƒÉ»õi remediale »ôi diverse activitƒÉ»õi pedagogice »ôi de sprijin', 'A II.5.': 'A II.5. ActivitƒÉ»õi extracurriculare »ôi/sau extra»ôcolare', 'A II.6.': 'A II.6. ActivitƒÉ»õi pentru dezvoltarea litera»õiei. Club de lecturƒÉ' };
    const MAP_ACT = { 'A II.4.': ['Anghelu»ô Raluca', 'Baziluc Ana Maria', 'Gheme»ô Anca', 'ArotƒÉri»õei DƒÉnu»õ', 'Boldan Ovidiu', 'Popovici Estera', 'Iftene Ana Maria'], 'A II.5.': ['Albu »òtefan', 'Marele Daniela', 'TanasƒÉ Liliana', 'Popa Gabriela', 'Nohai Iuliana', 'Nohai Vili'], 'A II.6.': ['AparascƒÉi Vasile'] };

    function recalculareTotal() {
        let suma = 0;
        document.querySelectorAll('#tabel-pontaj tr').forEach(row => {
            suma += parseFloat(row.cells[3].innerText) || 0;
        });
        document.getElementById('total-final').innerText = suma;
    }

    function reindex() {
        document.querySelectorAll('#tabel-pontaj tr').forEach((row, i) => { row.cells[0].innerText = i + 1; });
    }

    function addRow() {
        const tbody = document.getElementById('tabel-pontaj');
        const row = document.createElement('tr');
        row.innerHTML = `<td></td><td contenteditable="true"></td><td contenteditable="true"></td><td contenteditable="true">0</td>`;
        tbody.appendChild(row); reindex(); recalculareTotal();
    }

    function removeLastRow() {
        const tbody = document.getElementById('tabel-pontaj');
        if (tbody.lastElementChild) { tbody.removeChild(tbody.lastElementChild); recalculareTotal(); }
    }

    function formatData(zi, lunaText, an) {
        const luni = {"Ianuarie":"01","Februarie":"02","Martie":"03","Aprilie":"04","Mai":"05","Iunie":"06","Iulie":"07","August":"08","Septembrie":"09","Octombrie":"10","Noiembrie":"11","Decembrie":"12"};
        return `${zi.toString().padStart(2, '0')}.${luni[lunaText] || "01"}.${an}`;
    }

    // Variabile globale pentru salvare
    let g_expert, g_luna, g_an, g_tipDoc;
    
    // Mapare pentru a genera cheia documentului (ex: Ianuarie -> 01)
    const MAP_LUNI_COD = { "Ianuarie": "01", "Februarie": "02", "Martie": "03", "Aprilie": "04", "Mai": "05", "Iunie": "06", "Iulie": "07", "August": "08", "Septembrie": "09", "Octombrie": "10", "Noiembrie": "11", "Decembrie": "12" };

    async function incarca() {
        const params = new URLSearchParams(window.location.search);

        // 1. IDENTIFICARE (Expert din Memorie, Data din Link)
        g_expert = localStorage.getItem('expertPNRAS');
        
        const azi = new Date();
        const LUNI_LOCAL = ["Ianuarie", "Februarie", "Martie", "Aprilie", "Mai", "Iunie", "Iulie", "August", "Septembrie", "Octombrie", "Noiembrie", "Decembrie"];
        
        g_luna = params.get('luna') || LUNI_LOCAL[azi.getMonth()];
        g_an = params.get('an') || azi.getFullYear();

        if (!g_expert) { alert("Nu e»ôti logat! Mergi la 'Dosar Expert'."); return; }

        // Setare texte pe ecran
        document.getElementById('out-expert').innerText = g_expert;
        document.getElementById('sig-expert').innerText = g_expert;
        document.getElementById('out-luna-an').innerText = `${g_luna} ${g_an}`;
        document.getElementById('out-contract').textContent = CONTRACTE[g_expert] || "---";
        document.getElementById('out-disciplina').textContent = MAP_DISCIPLINE[g_expert] || "---";
        
        let actCod = "";
        for (let k in MAP_ACT) if (MAP_ACT[k].includes(g_expert)) actCod = k;
        document.getElementById('out-activitate').textContent = DESC_ACT[actCod] || "---";

        document.getElementById('btn-back').onclick = () => { window.location.href = `dosar-expert.html?expert=${encodeURIComponent(g_expert)}`; };

        // 2. RECUPERARE NR. √éNREGISTRARE (Nou!)
        // GenerƒÉm cheia unicƒÉ: PONTAJ_Nume_01_2025
        const lunaCod = MAP_LUNI_COD[g_luna] || "01";
        g_tipDoc = `PONTAJ_${g_expert.replace(/\s+/g, '')}_${lunaCod}_${g_an}`;

        try {
            const { data: doc } = await _supabase
                .from('planificari_documente')
                .select('continut_json')
                .eq('tip_document', g_tipDoc)
                .maybeSingle();

            if (doc && doc.continut_json) {
                // DacƒÉ gƒÉsim date, le punem √Æn cƒÉsu»õe
                document.getElementById('nr_inreg_val').value = doc.continut_json.nr || "";
                document.getElementById('data_inreg_val').value = doc.continut_json.data || "";
            }
        } catch (e) { console.error("Eroare la preluare Nr. √énreg:", e); }

        // 3. GENERARE TABEL ORE (Standard)
        try {
            const { data } = await _supabase.from('pontaj_detaliat').select('*').eq('expert', g_expert).eq('luna', g_luna).eq('an', g_an).order('zi', { ascending: true });
            const tbody = document.getElementById('tabel-pontaj');
            tbody.innerHTML = "";

            if (data && data.length > 0) {
                const zile = {};
                data.forEach(r => {
                    if (!zile[r.zi]) zile[r.zi] = { clase: [], ore: 0 };
                    const cls = MAP_CLASE[r.clase_grupe] || r.clase_grupe;
                    if (!zile[r.zi].clase.includes(cls)) zile[r.zi].clase.push(cls);
                    zile[r.zi].ore += parseFloat(r.nr_ore);
                });
                let idx = 1;
                let html = "";
                for (let zi in zile) {
                    html += `<tr><td>${idx++}</td><td contenteditable="true">${formatData(zi, g_luna, g_an)}</td><td contenteditable="true">${[...new Set(zile[zi].clase)].join(', ')}</td><td contenteditable="true">${zile[zi].ore}</td></tr>`;
                }
                tbody.innerHTML = html;
                recalculareTotal();
            } else {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red; padding:20px;">Nu existƒÉ ore √Ænregistrate pentru ${g_luna} ${g_an}.</td></tr>`;
            }
        } catch (err) { console.error(err); }
    }

async function salveazaMeta() {
        const nr = document.getElementById('nr_inreg_val').value;
        const dataVal = document.getElementById('data_inreg_val').value;
        const msg = document.getElementById('msg-salvare');

        // SalvƒÉm √Æn tabelul 'planificari_documente'
        const { error } = await _supabase.from('planificari_documente').upsert({
            expert: g_expert,
            tip_document: g_tipDoc, // Cheia unicƒÉ generatƒÉ la √ÆncƒÉrcare
            luna: g_luna,
            an: g_an,
            continut_json: { nr: nr, data: dataVal }, // SalvƒÉm valorile ca JSON
            updated_at: new Date().toISOString()
        }, { onConflict: 'tip_document' });

        if (!error) {
            // Afi»ôƒÉm un mic mesaj "Salvat" care dispare dupƒÉ 2 secunde
            if(msg) { msg.style.display = "inline"; setTimeout(() => msg.style.display = "none", 2000); }
            console.log("Antet salvat cu succes!");
        } else {
            alert("Eroare la salvare: " + error.message);
        }
    }
    document.addEventListener('DOMContentLoaded', incarca);
</script>
</body>
</html>
