<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Management MasƒÉ CaldƒÉ PNRAS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0b0f14; --panel: #1a1f26; --accent: #10b981; --border: #30363d; --text: #e6edf3; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Roboto Condensed', sans-serif; padding-bottom: 50px; }
        .header-bar { background: var(--panel); padding: 15px; border-bottom: 2px solid var(--accent); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .section-title { background: #000; padding: 10px 20px; border-left: 4px solid var(--accent); margin: 30px 0 15px 0; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Tabel Principal */
        .table-wrap { width: 100%; overflow-x: auto; background: var(--panel); padding: 15px; border-bottom: 1px solid var(--border); }
        table { border-collapse: collapse; table-layout: fixed; width: 1500px; }
        th, td { border: 1px solid var(--border); text-align: center; height: 50px; font-size: 11px; }
        th { background: #161b22; color: var(--accent); }
        .row-label { width: 180px; text-align: left; padding-left: 12px; font-weight: bold; background: #161b22; }
        
        /* Celule clickabile */
        .cell-aviz { cursor: pointer; transition: 0.2s; font-weight: bold; color: #fbbf24; font-size: 14px; position: relative; }
        .cell-aviz:hover { background: #fbbf24; color: #000; }
        .cell-aviz:hover::after { content: "DESCHIDE AVIZ"; position: absolute; top: -20px; left: 0; font-size: 8px; background: #000; color: #fff; padding: 2px; width: 100%; }
        .cell-empty { color: #444; }

        .sel-meniu { width: 100%; height: 100%; background: #000; color: var(--accent); border: none; font-weight: bold; text-align: center; cursor: pointer; outline: none; }

        /* Buton Sub Tabel */
        .btn-print-luna { display: block; width: 100%; max-width: 350px; margin: 20px auto; padding: 15px; background: var(--accent); color: #000; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; text-align: center; font-size: 14px; text-transform: uppercase; }
        .btn-print-luna:hover { background: #0d9469; transform: scale(1.02); }

        /* Grile Foldere Rapoarte */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 0 20px; }
        .folder { background: #21262d; border: 1px solid var(--border); padding: 20px 10px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .folder:hover { border-color: var(--accent); background: #1c2128; transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .folder-icon { font-size: 40px; display: block; color: #fbbf24; margin-bottom: 8px; }
        .folder b { display: block; color: #fff; font-size: 12px; }
        .folder span { font-size: 10px; color: var(--accent); font-weight: bold; }

        .btn-back { background: #444; color: white; border: none; padding: 8px 18px; cursor: pointer; font-weight: bold; border-radius: 4px; }
    </style>
</head>
<body>

<div class="header-bar">
    <div style="font-size: 18px; font-weight: bold; color: var(--accent);">LOGISTICƒÇ MASƒÇ CALDƒÇ</div>
    <button class="btn-back" onclick="window.location.href='index.html'">√éNAPOI</button>
</div>

<div class="section-title">1. Verificare ZilnicƒÉ (Click pe cifre pentru Avizul zilei)</div>
<div class="table-wrap">
    <div style="margin-bottom: 15px;">
        <label>Perioada afi»ôatƒÉ √Æn tabel:</label>
        <select id="sel-luna-tabel" onchange="loadTable(this.value)" style="background:#000; color:#fff; border:1px solid var(--accent); padding:8px; border-radius:4px; font-weight:bold;">
            <optgroup label="Anul 2025" id="opt-2025"></optgroup>
            <optgroup label="Anul 2026" id="opt-2026"></optgroup>
        </select>
    </div>
    
    <table id="main-table">
        <thead><tr id="h-row"></tr></thead>
        <tbody>
            <tr id="row-aviz"></tr>
            <tr id="row-tip-meniu"></tr>
        </tbody>
    </table>

    <button id="btn-print-luna" class="btn-print-luna" onclick="printLuna()">üñ®Ô∏è GENEREAZƒÇ RAPORT LUNAR COMPLET</button>
</div>

<div class="section-title">2. ArhivƒÉ Rapoarte Lunare (Dosar complet Avize)</div>
<div class="folder-grid" id="grid-rapoarte"></div>

<script>
    const URL_S = 'https://aexjrbdgajurxzngfkpx.supabase.co';
    const KEY_S = 'sb_publishable_KPV__0BA9z4EvRl5eqC0FQ_hmBLOLYv';
    const supabaseClient = supabase.createClient(URL_S, KEY_S);

    let state = { luna: "Ianuarie", an: "2025" };
    const luniArr = ["Ianuarie", "Februarie", "Martie", "Aprilie", "Mai", "Iunie", "Iulie", "August", "Septembrie", "Octombrie", "Noiembrie", "Decembrie"];

    async function loadTable(lunaAn) {
        const parts = lunaAn.split('_');
        state.luna = parts[0]; 
        state.an = parts[1];
        
        const { data: records } = await supabaseClient.from('setari_pontaj').select('*').match({ luna: state.luna, an: state.an });

        document.getElementById('h-row').innerHTML = `<th class="row-label">ZILE ${state.an}</th>${Array.from({length:31},(_,i)=>`<th>${i+1}</th>`).join('')}`;
        
        let avizCells = `<td class="row-label">POR»öII (AVIZ)</td>`;
        let meniuCells = `<td class="row-label">TIP MENIU</td>`;

        for(let i=1; i<=31; i++) {
            const ziDate = records?.find(x => parseInt(x.zi) === i);
            const valAviz = ziDate?.valoare_aviz;
            
            if (valAviz && parseInt(valAviz) > 0) {
                avizCells += `<td class="cell-aviz" onclick="window.location.href='avize.html?zi=${i}&luna=${state.luna}&an=${state.an}'">${valAviz}</td>`;
            } else {
                avizCells += `<td class="cell-empty">-</td>`;
            }
            
            let opts = `<option value="">-</option>`;
            for(let m=1; m<=5; m++) {
                opts += `<option value="${m}" ${ziDate?.tip_meniu == m ? 'selected' : ''}>M${m}</option>`;
            }
            meniuCells += `<td><select class="sel-meniu" onchange="updateMeniu(${i}, this.value)">${opts}</select></td>`;
        }
        document.getElementById('row-aviz').innerHTML = avizCells;
        document.getElementById('row-tip-meniu').innerHTML = meniuCells;
    }

    async function updateMeniu(zi, val) {
        const v = val === "" ? null : parseInt(val);
        await supabaseClient.from('setari_pontaj').upsert({ zi, luna: state.luna, an: state.an, tip_meniu: v }, { onConflict: 'zi,luna,an' });
    }

    function printLuna() {
        window.location.href = `raport-lunar.html?luna=${state.luna}&an=${state.an}`;
    }

    function init() {
        const grid = document.getElementById('grid-rapoarte'), s25 = document.getElementById('opt-2025'), s26 = document.getElementById('opt-2026');
        
        const calendar = [];
        luniArr.forEach(l => calendar.push({l, a:"2025"}));
        luniArr.slice(0, 6).forEach(l => calendar.push({l, a:"2026"}));

        grid.innerHTML = "";
        calendar.forEach(item => {
            // Dropdown setup
            const opt = `<option value="${item.l}_${item.a}">${item.l} ${item.a}</option>`;
            if(item.a === "2025") s25.innerHTML += opt; else s26.innerHTML += opt;
            
            // Grid Foldere
            grid.innerHTML += `
                <div class="folder" onclick="window.location.href='raport-lunar.html?luna=${item.l}&an=${item.a}'">
                    <span class="folder-icon">üìä</span>
                    <b>Raport ${item.l}</b>
                    <span>AN ${item.a}</span>
                </div>`;
        });
        loadTable("Ianuarie_2025");
    }

    init();
</script>
</body>
</html>